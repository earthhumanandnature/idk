<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <!-- <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-eval' 'unsafe-inline' https://www.gstatic.com https://www.googleapis.com https://firebase.googleapis.com https://firestore.googleapis.com https://apis.google.com https://*.googleapis.com https://*.gstatic.com https://firebase.com https://*.firebase.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com; img-src 'self' data: https:; connect-src 'self' https://www.googleapis.com https://firebase.googleapis.com https://firestore.googleapis.com https://*.googleapis.com https://*.firebase.com;"> -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fishingwiththemath</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-30px);
            }
        }
    </style>

    <style>
        @keyframes slideUp {
                0% {
                        opacity: 1;
                        transform: translateY(0);
                }
                100% {
                        opacity: 0;
                        transform: translateY(-30px);
                }
        }

        @keyframes spin {
                from {
                        transform: rotate(0deg);
                }
                to {
                        transform: rotate(360deg);
                }
        }

        .music-disc {
                animation: spin 3s linear infinite;
                animation-play-state: paused;
        }

        .music-disc.playing {
                animation-play-state: running;
        }

        /* Music Player Styles */
        .music-player {
                position: fixed;
                bottom: 16px;
                left: 16px;
                background: linear-gradient(to bottom right, #9333ea, #ec4899);
                border-radius: 12px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                padding: 16px;
                z-index: 1000;
                color: white;
                transition: all 0.3s;
        }

        .music-player.collapsed {
                width: 64px;
                height: 64px;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
        }

        .music-player.expanded {
                width: 33vw; /* Always 1/3 of screen width */
                max-width: 384px; /* Keep max 384px on desktop */
        }

        .music-player input[type="range"] {
                -webkit-appearance: none;
                appearance: none;
                width: 100%;
                height: 8px;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 4px;
                outline: none;
                cursor: pointer;
        }

        .music-player input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 16px;
                height: 16px;
                background: white;
                border-radius: 50%;
                cursor: pointer;
        }

        .music-player input[type="range"]::-moz-range-thumb {
                width: 16px;
                height: 16px;
                background: white;
                border-radius: 50%;
                cursor: pointer;
                border: none;
        }

        .music-player button {
                transition: all 0.2s;
        }

        .music-player button:hover {
                transform: scale(1.05);
        }

        /* Glitch effect for Th√°i C·ª±c Quy·ªÅn Ph√°p */
        @keyframes glitch {
                0% {
                        transform: translate(0);
                        filter: hue-rotate(0deg);
                }
                20% {
                        transform: translate(-2px, 2px);
                        filter: hue-rotate(90deg);
                }
                40% {
                        transform: translate(-2px, -2px);
                        filter: hue-rotate(180deg);
                }
                60% {
                        transform: translate(2px, -2px);
                        filter: hue-rotate(270deg);
                }
                80% {
                        transform: translate(2px, 2px);
                        filter: hue-rotate(360deg);
                }
                100% {
                        transform: translate(0);
                        filter: hue-rotate(0deg);
                }
        }

        .glitch-text {
                animation: glitch 0.3s infinite;
                text-shadow: 2px 2px 0px #ff0000, -2px -2px 0px #00ffff, 2px -2px 0px #ffff00, -2px 2px 0px #ff00ff;
        }

        .glitch-number {
                animation: glitch 0.2s infinite;
                color: #fff;
                text-shadow: 1px 1px 0px #f00, -1px -1px 0px #0ff, 1px -1px 0px #ff0, -1px 1px 0px #0f0;
        }

        /* Add media query for further mobile adjustments */
        @media (max-width: 640px) {
                .music-player.expanded {
                        padding: 8px;
                        font-size: 12px;
                }
                .music-player.expanded h3 {
                        font-size: 14px;
                }
                .music-disc {
                        width: 80px;
                        height: 80px;
                }
                .music-player button {
                        padding: 6px;
                        font-size: 16px;
                }
                .music-player input[type="range"] {
                        height: 6px;
                }
                .music-player input[type="range"]::-webkit-slider-thumb,
                .music-player input[type="range"]::-moz-range-thumb {
                        width: 12px;
                        height: 12px;
                }
        }

        /* Add scroll in landscape mode */
        @media (orientation: landscape) {
                .music-player.expanded {
                        overflow-y: auto;
                        max-height: 90vh;
                }
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="musicPlayer" class="music-player collapsed" style="display: none;">
        <div id="collapsedView" style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 32px;">
            üéµ
        </div>
        <div id="expandedView" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="font-weight: bold; font-size: 18px;">üéµ Music Player</h3>
                <button id="collapseBtn" style="color: white; background: none; border: none; cursor: pointer; font-size: 16px;">‚ñº</button>
            </div>
            
            <div style="display: flex; justify-content: center; margin-bottom: 16px;">
                <div id="musicDisc" class="music-disc" style="width: 128px; height: 128px; border-radius: 50%; background: linear-gradient(to bottom right, #fbbf24, #ec4899); display: flex; align-items: center; justify-content: center; border: 4px solid white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: #1f2937;"></div>
                </div>
            </div>
            
            <div style="text-align: center; margin-bottom: 16px;">
                <p id="trackName" style="font-weight: bold;">No Music</p>
                <p id="trackInfo" style="font-size: 14px; opacity: 0.8;">Track 0 / 0</p>
            </div>
            
            <div style="margin-bottom: 16px;">
                <input type="range" id="progressBar" min="0" max="100" value="0" style="width: 100%;">
                <div style="display: flex; justify-content: space-between; font-size: 12px; margin-top: 4px;">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
            </div>
            
            <div style="display: flex; justify-content: center; align-items: center; gap: 16px; margin-bottom: 16px;">
                <button id="prevBtn" style="background: rgba(255,255,255,0.2); border: none; border-radius: 50%; padding: 8px; cursor: pointer; font-size: 20px;">‚èÆÔ∏è</button>
                <button id="playBtn" style="background: white; color: #9333ea; border: none; border-radius: 50%; padding: 12px; cursor: pointer; font-size: 24px;">‚ñ∂Ô∏è</button>
                <button id="nextBtn" style="background: rgba(255,255,255,0.2); border: none; border-radius: 50%; padding: 8px; cursor: pointer; font-size: 20px;">‚è≠Ô∏è</button>
            </div>
            
            <div style="margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 14px;">üîä</span>
                    <input type="range" id="volumeBar" min="0" max="100" value="50" style="flex: 1;">
                    <span id="volumeText" style="font-size: 14px; width: 40px;">50%</span>
                </div>
            </div>
            
            <div style="margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 14px;">‚ö°</span>
                    <input type="range" id="speedBar" min="50" max="200" value="100" step="25" style="flex: 1;">
                    <span id="speedText" style="font-size: 14px; width: 40px;">1x</span>
                </div>
            </div>
            
            <div style="display: flex; justify-content: center;">
                <button id="loopBtn" style="padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; background: white; color: #9333ea;">
                    üîÑ Loop ON
                </button>
            </div>
        </div>
    </div>
    
    <audio id="audioElement" preload="metadata"></audio>
    
    <div id="root"></div>

    <script>
        (function() {
            // Music Player Variables
            let playlist = [];
            let currentTrackIndex = 0;
            let isPlaying = false;
            let loop = true;
            
            const audio = document.getElementById('audioElement');
            const musicPlayer = document.getElementById('musicPlayer');
            const collapsedView = document.getElementById('collapsedView');
            const expandedView = document.getElementById('expandedView');
            const musicDisc = document.getElementById('musicDisc');
            const playBtn = document.getElementById('playBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const loopBtn = document.getElementById('loopBtn');
            const collapseBtn = document.getElementById('collapseBtn');
            const progressBar = document.getElementById('progressBar');
            const volumeBar = document.getElementById('volumeBar');
            const speedBar = document.getElementById('speedBar');
            const currentTimeEl = document.getElementById('currentTime');
            const totalTimeEl = document.getElementById('totalTime');
            const volumeText = document.getElementById('volumeText');
            const speedText = document.getElementById('speedText');
            const trackName = document.getElementById('trackName');
            const trackInfo = document.getElementById('trackInfo');
            
            // Format time helper
            function formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return mins + ':' + (secs < 10 ? '0' : '') + secs;
            }
            
            // Check available music files
            async function checkMusicFiles() {
                const available = [];
                for (let i = 1; i <= 10; i++) {
                    const filename = 'music' + i + '.mp3';
                    try {
                        const response = await fetch(filename, { method: 'HEAD' });
                        if (response.ok) {
                            available.push({
                                id: i,
                                name: 'Music ' + i,
                                src: filename
                            });
                        }
                    } catch (error) {
                        // File doesn't exist, skip
                    }
                }
                return available;
            }
            
            // Initialize player
            async function initPlayer() {
                playlist = await checkMusicFiles();
                
                if (playlist.length > 0) {
                    musicPlayer.style.display = 'block';
                    loadTrack(0);
                    updateUI();
                    
                    // Auto expand
                    setTimeout(toggleExpand, 500);
                    
                    // Auto play after 1 second
                    setTimeout(() => {
                        togglePlay();
                    }, 1000);
                }
            }
            
            // Load track
            function loadTrack(index) {
                if (index < 0 || index >= playlist.length) return;
                currentTrackIndex = index;
                audio.src = playlist[index].src;
                updateUI();
            }
            
            // Update UI
            function updateUI() {
                if (playlist.length > 0) {
                    trackName.textContent = playlist[currentTrackIndex].name;
                    trackInfo.textContent = 'Track ' + (currentTrackIndex + 1) + ' / ' + playlist.length;
                }
                
                playBtn.textContent = isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
                
                if (isPlaying) {
                    musicDisc.classList.add('playing');
                } else {
                    musicDisc.classList.remove('playing');
                }
                
                loopBtn.textContent = loop ? 'üîÑ Loop ON' : 'üîÑ Loop OFF';
                loopBtn.style.background = loop ? 'white' : 'rgba(255,255,255,0.2)';
                loopBtn.style.color = loop ? '#9333ea' : 'white';
            }
            
            // Toggle play/pause
            function togglePlay() {
                if (isPlaying) {
                    audio.pause();
                    isPlaying = false;
                } else {
                    audio.play().catch(e => console.log('Play error:', e));
                    isPlaying = true;
                }
                updateUI();
            }
            
            // Skip to next track
            function skipNext() {
                const nextIndex = (currentTrackIndex + 1) % playlist.length;
                loadTrack(nextIndex);
                if (isPlaying) {
                    audio.play();
                }
            }
            
            // Skip to previous track
            function skipPrev() {
                const prevIndex = currentTrackIndex === 0 ? playlist.length - 1 : currentTrackIndex - 1;
                loadTrack(prevIndex);
                if (isPlaying) {
                    audio.play();
                }
            }
            
            // Toggle loop
            function toggleLoop() {
                loop = !loop;
                updateUI();
            }
            
            // Expand/collapse player
            function toggleExpand() {
                if (musicPlayer.classList.contains('collapsed')) {
                    musicPlayer.classList.remove('collapsed');
                    musicPlayer.classList.add('expanded');
                    collapsedView.style.display = 'none';
                    expandedView.style.display = 'block';
                } else {
                    musicPlayer.classList.add('collapsed');
                    musicPlayer.classList.remove('expanded');
                    collapsedView.style.display = 'flex';
                    expandedView.style.display = 'none';
                }
            }
            
            // Event Listeners
            playBtn.addEventListener('click', togglePlay);
            nextBtn.addEventListener('click', skipNext);
            prevBtn.addEventListener('click', skipPrev);
            loopBtn.addEventListener('click', toggleLoop);
            collapseBtn.addEventListener('click', toggleExpand);
            collapsedView.addEventListener('click', toggleExpand);
            
            // Progress bar
            progressBar.addEventListener('input', function() {
                const time = (this.value / 100) * audio.duration;
                audio.currentTime = time;
            });
            
            // Volume bar
            volumeBar.addEventListener('input', function() {
                const vol = this.value / 100;
                audio.volume = vol;
                volumeText.textContent = this.value + '%';
            });
            
            // Speed bar
            speedBar.addEventListener('input', function() {
                const speed = this.value / 100;
                audio.playbackRate = speed;
                speedText.textContent = speed + 'x';
            });
            
            // Audio events
            audio.addEventListener('timeupdate', function() {
                if (audio.duration) {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    progressBar.value = progress;
                    currentTimeEl.textContent = formatTime(audio.currentTime);
                }
            });
            
            audio.addEventListener('loadedmetadata', function() {
                totalTimeEl.textContent = formatTime(audio.duration);
            });
            
            audio.addEventListener('ended', function() {
                if (loop) {
                    skipNext();
                } else {
                    if (currentTrackIndex === playlist.length - 1) {
                        isPlaying = false;
                        updateUI();
                    } else {
                        skipNext();
                    }
                }
            });
            
            // Initialize on page load
            let playerInitialized = false;
            
            window.addEventListener('load', function() {
                // Check if Firebase auth is available
                if (window.firebase && window.firebase.auth) {
                    window.firebase.auth().onAuthStateChanged(function(user) {
                        if (user && !playerInitialized) {
                            // User is logged in, initialize music player
                            playerInitialized = true;
                            initPlayer();
                        } else if (!user) {
                            // User is logged out, hide music player
                            musicPlayer.style.display = 'none';
                            if (isPlaying) {
                                audio.pause();
                                isPlaying = false;
                                updateUI();
                            }
                        }
                    });
                }
            });
        })();
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ‚ö†Ô∏è THAY ƒê·ªîI CONFIG N√ÄY B·∫∞NG FIREBASE CONFIG C·ª¶A B·∫†N
        const firebaseConfig = {
          apiKey: "AIzaSyAdRj_aTtKC4EpctQtiJymTPI5TIhXEQTU",
          authDomain: "fishing-game-b3de4.firebaseapp.com",
          projectId: "fishing-game-b3de4",
          storageBucket: "fishing-game-b3de4.firebasestorage.app",
          messagingSenderId: "995387752934",
          appId: "1:995387752934:web:ccb5c73999a23d7715d627",
          measurementId: "G-2BYJH3JMTZ"
        };

        // Kh·ªüi t·∫°o Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        const FishIcon = ({ size = 24, color = "#000" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2">
                <path d="M6.5 12c.94-3.46 4.94-6 8.5-6 3.56 0 6.06 2.54 7 6-1 3.46-3.44 6-7 6s-7.56-2.54-8.5-6Z"/>
                <path d="M18 12v.5M16 17.5a2 2 0 0 0 2-2"/>
                <path d="M20 12c0-.5 0-1-.09-1.5"/>
            </svg>
        );

        const PackageIcon = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/>
                <path d="m3.3 7 8.7 5 8.7-5M12 22V12"/>
            </svg>
        );

        const FishingGame = () => {
            const [gameState, setGameState] = useState('login');
            const [loginMode, setLoginMode] = useState('login');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [currentUser, setCurrentUser] = useState(null);
            const [userId, setUserId] = useState(null);
            const [currentFish, setCurrentFish] = useState(null);
            const [answer, setAnswer] = useState('');
            const [timeLeft, setTimeLeft] = useState(0);
            const [inventory, setInventory] = useState([]);
            const [items, setItems] = useState([]); // Danh s√°ch items
            const [showInventory, setShowInventory] = useState(false);
            const [inventoryTab, setInventoryTab] = useState('fish');
            const [message, setMessage] = useState('');
            const [money, setMoney] = useState(0);
            const [showSellConfirm, setShowSellConfirm] = useState(false);
            const [loading, setLoading] = useState(false);
            const [showShop, setShowShop] = useState(false);
            const [shopTab, setShopTab] = useState('rods');
            const [fishingRod, setFishingRod] = useState('normal');
            const [ownedRods, setOwnedRods] = useState(['normal']);
            const [currentBait, setCurrentBait] = useState('normal');
            const [ownedBaits, setOwnedBaits] = useState(['normal']);
            const [weatherDocData, setWeatherDocData] = useState(null);
            const [currentWeather, setCurrentWeather] = useState({
                key: 'clear',
                name: 'Tr·ªùi quang',
                multiplier: 1,
                mutation: 'Kh√¥',
                isAdminWeather: false,
                waterLevel: 0,
                sunLevel: 0,
                atmosphereLevel: 0,
                expiresAtMs: 0
            });
            const [configError, setConfigError] = useState(false);
            const [showLeaderboard, setShowLeaderboard] = useState(false);
            const [leaderboardTab, setLeaderboardTab] = useState('fish');
            const [leaderboardData, setLeaderboardData] = useState([]);
            const [loadingLeaderboard, setLoadingLeaderboard] = useState(false);
            // State cho nhi·ªám v·ª• h·∫±ng ng√†y
            const [dailyQuests, setDailyQuests] = useState([]);
            const [showQuests, setShowQuests] = useState(false);
            const [lastQuestReset, setLastQuestReset] = useState(null);
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            const [adminCommand, setAdminCommand] = useState('');
            const [adminOutput, setAdminOutput] = useState('');
            const [displayMoney, setDisplayMoney] = useState(0);
            const [moneyChange, setMoneyChange] = useState(0);
            const [showMoneyChange, setShowMoneyChange] = useState(false);
            const [isBanned, setIsBanned] = useState(false);
            const moneyRef = useRef(money); // Ref ƒë·ªÉ l∆∞u gi√° tr·ªã ti·ªÅn c≈©
            const [isAnonymous, setIsAnonymous] = useState(false); // Theo d√µi ƒëƒÉng nh·∫≠p ·∫©n danh
            // ‚≠ê TH√äM STATE LOGS
            const [showLogs, setShowLogs] = useState(false);
            const [logsData, setLogsData] = useState([]);
            const [loadingLogs, setLoadingLogs] = useState(false);
            // ‚≠ê TH√äM STATE CHO T·ªòC & ROLL
            const [tribe, setTribe] = useState('nguoi'); // Key tribe m·∫∑c ƒë·ªãnh
            const [rollCount, setRollCount] = useState(3); // L·∫ßn roll mi·ªÖn ph√≠
            const [purchasedRollPacks, setPurchasedRollPacks] = useState({ single: 0, five: 0, ten: 0 }); // Theo d√µi mua g√≥i
            const [showRollPanel, setShowRollPanel] = useState(false); // Panel roll t·ªôc
            const [fishingOnlySecret, setFishingOnlySecret] = useState(false);
            const [deletePassword, setDeletePassword] = useState('');  // Kh√¥ng d√πng, nh∆∞ng n·∫øu mu·ªën modal th√¨ d√πng
            // State cho Th√°i C·ª±c Quy·ªÅn Ph√°p
            const [hasTaiChiPower, setHasTaiChiPower] = useState(false);
            const [showTaiChiCutscene, setShowTaiChiCutscene] = useState(false);
            const [showTaiChiImage, setShowTaiChiImage] = useState(false);
            const [taiChiKey, setTaiChiKey] = useState(0); // For force re-render
            const [isTaiChiActive, setIsTaiChiActive] = useState(false);
            const [taiChiCooldownUntil, setTaiChiCooldownUntil] = useState(null); // Timestamp cooldown

            const rarities = [
                { name: 'Common', weight: 60, range: 10, time: 3, color: '#9CA3AF', price: 10 },
                { name: 'Uncommon', weight: 50, range: 20, time: 5, color: '#22C55E', price: 12 },
                { name: 'Rare', weight: 30, range: 30, time: 6, color: '#3B82F6', price: 15 },
                { name: 'Legendary', weight: 20, range: 40, time: 8, color: '#A855F7', price: 20 },
                { name: 'Mythic', weight: 10, range: 50, time: 9, color: '#EF4444', price: 25 },
                { name: 'Secret', weight: 1, range: 60, time: 10, color: '#F59E0B', price: 30 },
                { name: 'Special(admin)', weight: 0, range: 0, time: 0, color: '#FFD700', price: 1000000000 }
            ];

            // Gi·ªõi h·∫°n ti·ªÅn t·ªëi ƒëa
            const MAX_MONEY = 1000000000; // 1 t·ª∑

            // Format s·ªë ti·ªÅn
            const formatMoney = (amount) => {
                if (amount >= 1000000000) return `${(amount / 1000000000).toFixed(1)}b`;
                if (amount >= 1000000) return `${(amount / 1000000).toFixed(1)}m`;
                if (amount >= 1000) return `${(amount / 1000).toFixed(1)}k`;
                return amount.toString();
            };

            // C·∫≠p nh·∫≠t ti·ªÅn v·ªõi animation
            const updateMoneyWithAnimation = (newAmount, change) => {
                // Gi·ªõi h·∫°n t·ªëi ƒëa 1b
                const limitedAmount = Math.min(newAmount, MAX_MONEY);
                const actualChange = limitedAmount - money;
    
                if (actualChange !== 0) {
                    setMoneyChange(actualChange);
                    setShowMoneyChange(true);
        
                    setTimeout(() => {
                        setShowMoneyChange(false);
                    }, 2000);
                }
    
                setMoney(limitedAmount);
            };

            const isAdmin = currentUser === 'vvt158214@gmail.com';

            const WEATHER_DURATION_MS = 5 * 60 * 1000;
            const [weatherNowMs, setWeatherNowMs] = useState(Date.now());
            const weatherExpiryHandledRef = useRef(0);

            const weatherRef = db.collection('weather').doc('state');

            const fishNames = {
                'Common': ['C√° R√¥', 'C√° Ch√©p', 'C√° Tr√™', 'C√° L√≥c'],
                'Uncommon': ['C√° H·ªìi', 'C√° Ng·ª´', 'C√° Chim', 'C√° Basa'],
                'Rare': ['C√° Ki·∫øm', 'C√° M·∫≠p Nh·ªè', 'C√° Voi Con', 'C√° Heo'],
                'Legendary': ['C√° M·∫≠p Tr·∫Øng', 'C√° Voi Xanh', 'C√° S·∫•u', 'C√° R·ªìng'],
                'Mythic': ['C√° R·ªìng V√†ng', 'C√° Ph∆∞·ª£ng Ho√†ng', 'C√° K·ª≥ L√¢n', 'Leviathan'],
                'Secret': ['C√° Th·∫ßn', 'Poseidon', 'Kraken', 'C√° R·ªìng C·ªï ƒê·∫°i'],
                'Special(admin)':['Tralalelo Tralala', 'Trippi Troppi Troppa Trippa(shirm)', 'Trippi Troppi Troppa Trippa(frog)']
            };

            const baitInfo = {
                'normal': {
                    name: 'Normal Bait',
                    description: 'M·ªìi c√¢u th√¥ng th∆∞·ªùng',
                    icon: 'ü™±',
                    color: '#9CA3AF',
                    difficulty: {
                        'Common': 0, 'Uncommon': 0, 'Rare': 0,
                        'Legendary': 0, 'Mythic': 0, 'Secret': 0,
                        'Special(admin)':0
                    }
                },
                'fish': {
                    name: 'Fish Bait',
                    description: 'Gi·∫£m ƒë·ªô kh√≥ b√†i to√°n',
                    icon: 'üêü',
                    color: '#22C55E',
                    price: 200,
                    difficulty: {
                        'Common': 20, 'Uncommon': 15, 'Rare': 10,
                        'Legendary': 5, 'Mythic': 2, 'Secret': 1,
                        'Special(admin)':0

                    }
                },
                'update': {
                    name: 'Update Bait',
                    description: 'Gi·∫£m ƒë√°ng k·ªÉ ƒë·ªô kh√≥',
                    icon: 'ü¶ê',
                    color: '#3B82F6',
                    price: 400,
                    difficulty: {
                        'Common': 40, 'Uncommon': 35, 'Rare': 30,
                        'Legendary': 25, 'Mythic': 20, 'Secret': 10,
                        'Special(admin)':0
                    }
                },
                'secret': {
                    name: 'Secret Bait',
                    description: 'Gi·∫£m c·ª±c k·ª≥ nhi·ªÅu ƒë·ªô kh√≥',
                    icon: 'ü¶ë',
                    color: '#A855F7',
                    price: 700,
                    difficulty: {
                        'Common': 80, 'Uncommon': 75, 'Rare': 70,
                        'Legendary': 65, 'Mythic': 60, 'Secret': 55,
                        'Special(admin)':0
                    }
                }
            };

            const weatherDefs = {
                clear: { name: 'Tr·ªùi quang', multiplier: 1, mutation: 'Kh√¥', isAdminWeather: false },
                cloudy: { name: '√Çm u', multiplier: 1.5, mutation: '√Çm u', isAdminWeather: false },
                rain: { name: 'M∆∞a', multiplier: 2, mutation: '∆Ø·ªõt', isAdminWeather: false },
                flood: { name: 'L≈©', multiplier: 3, mutation: 'Ng·∫≠p', isAdminWeather: false },
                warm: { name: 'N·∫Øng nh·∫π', multiplier: 1.3, mutation: '·∫§m', isAdminWeather: false },
                sunny: { name: 'N·∫Øng', multiplier: 1.8, mutation: 'N·∫Øng', isAdminWeather: false },
                heatwave: { name: 'N·∫Øng g·∫Øt', multiplier: 2.5, mutation: 'N√≥ng', isAdminWeather: false },
                atmosphere: { name: 'Kh√≠ quy·ªÉn l·∫°', multiplier: 1.4, mutation: 'Lo√£ng', isAdminWeather: false },
                aurora: { name: 'C·ª±c quang', multiplier: 2.2, mutation: 'C·ª±c quang', isAdminWeather: false },
                atmosstorm: { name: 'B√£o kh√≠ quy·ªÉn', multiplier: 3.2, mutation: 'Tƒ©nh ƒëi·ªán', isAdminWeather: false },
                volcano: { name: 'N√∫i l·ª≠a', multiplier: 5, mutation: 'Ch√°y', isAdminWeather: true },
                blackhole: { name: 'H·ªë ƒëen', multiplier: 10, mutation: 'H∆∞ v√¥', isAdminWeather: true },
                rainbow: { name: 'C·∫ßu v·ªìng', multiplier: 4, mutation: 'L·∫•p l√°nh', isAdminWeather: true }
            };

            const getAutoWeatherKeyFromLevels = (waterLevel, sunLevel, atmosphereLevel) => {
                const w = typeof waterLevel === 'number' ? waterLevel : 0;
                const s = typeof sunLevel === 'number' ? sunLevel : 0;
                const a = typeof atmosphereLevel === 'number' ? atmosphereLevel : 0;

                if (w < 3 && s < 3 && a < 3) return 'clear';

                if (w >= s && w >= a) {
                    if (w >= 9) return 'flood';
                    if (w >= 6) return 'rain';
                    if (w >= 3) return 'cloudy';
                    return 'clear';
                }

                if (s >= w && s >= a) {
                    if (s >= 9) return 'heatwave';
                    if (s >= 6) return 'sunny';
                    if (s >= 3) return 'warm';
                    return 'clear';
                }

                if (a >= 9) return 'atmosstorm';
                if (a >= 6) return 'aurora';
                if (a >= 3) return 'atmosphere';
                return 'clear';
            };

            const getEffectiveWeatherKeyFromDoc = (docData) => {
                if (!docData) return 'clear';
                const adminOverride = docData.adminOverride || { active: false };
                if (adminOverride && adminOverride.active === true && typeof adminOverride.weatherKey === 'string') {
                    return adminOverride.weatherKey;
                }
                if (typeof docData.autoWeatherKey === 'string') return docData.autoWeatherKey;
                const waterLevel = typeof docData.waterLevel === 'number' ? docData.waterLevel : 0;
                const sunLevel = typeof docData.sunLevel === 'number' ? docData.sunLevel : 0;
                const atmosphereLevel = typeof docData.atmosphereLevel === 'number' ? docData.atmosphereLevel : 0;
                return getAutoWeatherKeyFromLevels(waterLevel, sunLevel, atmosphereLevel);
            };

            const buildCurrentWeatherState = (docData) => {
                const waterLevel = typeof docData?.waterLevel === 'number' ? docData.waterLevel : 0;
                const sunLevel = typeof docData?.sunLevel === 'number' ? docData.sunLevel : 0;
                const atmosphereLevel = typeof docData?.atmosphereLevel === 'number' ? docData.atmosphereLevel : 0;
                const expiresAtMs = docData?.expiresAt && typeof docData.expiresAt.toDate === 'function'
                    ? docData.expiresAt.toDate().getTime()
                    : (docData?.nextUpdateAt && typeof docData.nextUpdateAt.toDate === 'function'
                        ? docData.nextUpdateAt.toDate().getTime()
                        : 0);
                const nextRandomAtMs = docData?.nextRandomAt && typeof docData.nextRandomAt.toDate === 'function'
                    ? docData.nextRandomAt.toDate().getTime()
                    : 0;
                const key = getEffectiveWeatherKeyFromDoc(docData);
                const def = weatherDefs[key] || weatherDefs.clear;
                const isExpired = expiresAtMs && Date.now() >= expiresAtMs;
                const isWaiting = isExpired && nextRandomAtMs && Date.now() < nextRandomAtMs;
                const displayKey = isExpired ? 'clear' : key;
                const displayDef = weatherDefs[displayKey] || weatherDefs.clear;

                // X·ª≠ l√Ω addedWeathers (stack)
                const rawAdded = docData?.addedWeathers || [];
                const now = Date.now();
                const activeAdded = rawAdded
                    .map(item => ({
                        ...item,
                        expiresAtMs: item.expiresAt && typeof item.expiresAt.toDate === 'function' ? item.expiresAt.toDate().getTime() : (item.expiresAtMs || 0)
                    }))
                    .filter(item => item.expiresAtMs > now);
                // T√≠nh t·ªïng h·ª£p multiplier v√† mutation t·ª´ addedWeathers
                let totalMultiplier = displayDef.multiplier;
                let mutations = [];
                if (displayDef.mutation && displayDef.mutation !== 'Kh√¥') mutations.push(displayDef.mutation);
                activeAdded.forEach(item => {
                    const wdef = weatherDefs[item.key];
                    if (wdef) {
                        totalMultiplier += wdef.multiplier - 1; // c·ªông d·ªìn
                        if (wdef.mutation && wdef.mutation !== 'Kh√¥') mutations.push(wdef.mutation);
                    }
                });
                const combinedMutation = mutations.length > 0 ? mutations.join(' + ') : 'Kh√¥';

                return {
                    key: displayKey,
                    name: isExpired ? 'Kh√¥ng c√≥ weather' : displayDef.name,
                    multiplier: isExpired ? 1 : totalMultiplier,
                    mutation: isExpired ? 'Kh√¥' : combinedMutation,
                    isAdminWeather: false,
                    waterLevel: isExpired ? 0 : waterLevel,
                    sunLevel: isExpired ? 0 : sunLevel,
                    atmosphereLevel: isExpired ? 0 : atmosphereLevel,
                    expiresAtMs,
                    nextRandomAtMs,
                    isExpired,
                    isWaiting,
                    addedWeathers: activeAdded
                };
            };

            const formatCountdownFromMs = (expiresAtMs) => {
                if (!expiresAtMs) return '00:00';
                const remainingSeconds = Math.max(0, Math.ceil((expiresAtMs - weatherNowMs) / 1000));
                const mm = String(Math.floor(remainingSeconds / 60)).padStart(2, '0');
                const ss = String(remainingSeconds % 60).padStart(2, '0');
                return `${mm}:${ss}`;
            };

            const getWeatherCountdownText = () => {
                if (currentWeather?.isWaiting && currentWeather?.nextRandomAtMs) {
                    return formatCountdownFromMs(currentWeather.nextRandomAtMs);
                }
                return formatCountdownFromMs(currentWeather?.expiresAtMs);
            };

            // ƒê·ªãnh nghƒ©a items
            const itemDefs = {
                'bat_quai_khai_mo': {
                    name: 'B√°t Qu√°i Khai M·ªü',
                    description: 'M·ªü kh√≥a Th√°i C·ª±c Quy·ªÅn Ph√°p - c√¢u c√° kh√¥ng c·∫ßn gi·∫£i to√°n',
                    icon: '‚òØÔ∏è',
                    color: '#FFD700',
                    usable: true
                }
            };

            const generateLevel = () => {
                let level = 0;
                let chance = 1;
                while (level < 10 && Math.random() < chance) {
                    level += 1;
                    chance = Math.max(0, chance - 0.1);
                }
                return level;
            };

            const ensureWeatherDoc = async () => {
                try {
                    const snap = await weatherRef.get();
                    if (!snap.exists) {
                        const expiresAt = new Date(Date.now() + WEATHER_DURATION_MS);
                        const nextRandomAt = new Date(Date.now() + 2 * WEATHER_DURATION_MS);
                        await weatherRef.set({
                            waterLevel: 0,
                            sunLevel: 0,
                            atmosphereLevel: 0,
                            autoWeatherKey: 'clear',
                            expiresAt: firebase.firestore.Timestamp.fromDate(expiresAt),
                            nextUpdateAt: firebase.firestore.Timestamp.fromDate(expiresAt),
                            nextRandomAt: firebase.firestore.Timestamp.fromDate(nextRandomAt),
                            adminOverride: { active: false },
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                        return;
                    }

                    const data = snap.data() || {};
                    const patch = {};
                    if (typeof data.sunLevel !== 'number') patch.sunLevel = 0;
                    if (typeof data.atmosphereLevel !== 'number') patch.atmosphereLevel = 0;
                    if (!data.expiresAt || !data.nextRandomAt) {
                        const expiresAt = new Date(Date.now() + WEATHER_DURATION_MS);
                        const nextRandomAt = new Date(Date.now() + 2 * WEATHER_DURATION_MS);
                        patch.expiresAt = firebase.firestore.Timestamp.fromDate(expiresAt);
                        patch.nextUpdateAt = firebase.firestore.Timestamp.fromDate(expiresAt);
                        patch.nextRandomAt = firebase.firestore.Timestamp.fromDate(nextRandomAt);
                    }
                    if (Object.keys(patch).length > 0) {
                        patch.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        await weatherRef.set(patch, { merge: true });
                    }
                } catch (e) {
                }
            };

            const tickWeatherIfNeeded = async () => {
                try {
                    await db.runTransaction(async (tx) => {
                        const snap = await tx.get(weatherRef);
                        if (!snap.exists) return;
                        const data = snap.data() || {};
                        const adminOverride = data.adminOverride || { active: false };
                        const nowMs = Date.now();
                        const expiresAtMs = data.expiresAt && typeof data.expiresAt.toDate === 'function'
                            ? data.expiresAt.toDate().getTime()
                            : (data.nextUpdateAt && typeof data.nextUpdateAt.toDate === 'function'
                                ? data.nextUpdateAt.toDate().getTime()
                                : 0);
                        const nextRandomAtMs = data.nextRandomAt && typeof data.nextRandomAt.toDate === 'function'
                            ? data.nextRandomAt.toDate().getTime()
                            : 0;

                        if (adminOverride && adminOverride.active === true) {
                            if (expiresAtMs && nowMs < expiresAtMs) return;
                            // Admin weather expired: clear admin and set expired state
                            tx.set(weatherRef, {
                                adminOverride: {
                                    active: false,
                                    weatherKey: firebase.firestore.FieldValue.delete(),
                                    setBy: adminOverride.setBy || null,
                                    setAt: adminOverride.setAt || null
                                },
                                waterLevel: 0,
                                sunLevel: 0,
                                atmosphereLevel: 0,
                                autoWeatherKey: 'clear',
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            }, { merge: true });
                            return;
                        }

                        // Normal weather logic
                        if (!expiresAtMs || nowMs < expiresAtMs) return;

                        // Weather expired, check if we should random new levels
                        if (!nextRandomAtMs || nowMs >= nextRandomAtMs) {
                            const waterLevel = generateLevel();
                            const sunLevel = generateLevel();
                            const atmosphereLevel = generateLevel();
                            const autoWeatherKey = getAutoWeatherKeyFromLevels(waterLevel, sunLevel, atmosphereLevel);
                            const expiresAt = new Date(nowMs + WEATHER_DURATION_MS);
                            const nextRandomAt = new Date(nowMs + 2 * WEATHER_DURATION_MS);
                            // Clean expired addedWeathers
                            const cleanedAdded = (data.addedWeathers || [])
                                .map(item => ({
                                    ...item,
                                    expiresAtMs: item.expiresAt && typeof item.expiresAt.toDate === 'function' ? item.expiresAt.toDate().getTime() : (item.expiresAtMs || 0)
                                }))
                                .filter(item => item.expiresAtMs > nowMs);
                            tx.set(weatherRef, {
                                waterLevel,
                                sunLevel,
                                atmosphereLevel,
                                autoWeatherKey,
                                expiresAt: firebase.firestore.Timestamp.fromDate(expiresAt),
                                nextUpdateAt: firebase.firestore.Timestamp.fromDate(expiresAt),
                                nextRandomAt: firebase.firestore.Timestamp.fromDate(nextRandomAt),
                                addedWeathers: cleanedAdded,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            }, { merge: true });
                        } else {
                            // Expired but still waiting period; ensure levels are zero and clean addedWeathers
                            const cleanedAdded = (data.addedWeathers || [])
                                .map(item => ({
                                    ...item,
                                    expiresAtMs: item.expiresAt && typeof item.expiresAt.toDate === 'function' ? item.expiresAt.toDate().getTime() : (item.expiresAtMs || 0)
                                }))
                                .filter(item => item.expiresAtMs > nowMs);
                            tx.set(weatherRef, {
                                waterLevel: 0,
                                sunLevel: 0,
                                atmosphereLevel: 0,
                                autoWeatherKey: 'clear',
                                addedWeathers: cleanedAdded,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            }, { merge: true });
                        }
                    });
                } catch (e) {
                }
            };

            // ‚≠ê ƒê·ªäNH NGHƒ®A T·ªòC & BUFF
            const tribes = {
                'nguoi': {
                    name: 'Ng∆∞·ªùi',
                    probability: 50,
                    timeBonus: 0,      // % tƒÉng th·ªùi gian c√¢u
                    diffReduce: 0,     // % gi·∫£m ƒë·ªô kh√≥
                    shopDiscount: 0    // % gi·∫£m gi√° shop
                },
                'ca': {
                    name: 'C√°',
                    probability: 30,
                    timeBonus: 30,
                    diffReduce: 15,
                    shopDiscount: 0
                },
                'nemo': {
                    name: 'Nemo',
                    probability: 15,
                    timeBonus: 5,
                    diffReduce: 0,
                    shopDiscount: 15
                },
                'poseidon': {
                    name: 'Poseidon',
                    probability: 1,
                    timeBonus: 30,
                    diffReduce: 50,
                    shopDiscount: 30
                }
            };

            // C·∫•u h√¨nh nhi·ªám v·ª• h·∫±ng ng√†y
            const dailyQuestTemplates = [
                {
                    id: 'catch_fish',
                    type: 'catch',
                    title: 'C√¢u c√°',
                    description: 'C√¢u ƒë∆∞·ª£c {target} con c√° b·∫•t k·ª≥',
                    target: 5,
                    reward: 50,
                    icon: 'üé£'
                },
                {
                    id: 'catch_rare',
                    type: 'catch_rare',
                    title: 'Th·ª£ sƒÉn Rare',
                    description: 'C√¢u ƒë∆∞·ª£c {target} con c√° Rare tr·ªü l√™n',
                    target: 3,
                    reward: 100,
                    icon: '‚≠ê'
                },
                {
                    id: 'solve_math',
                    type: 'solve',
                    title: 'Cao th·ªß to√°n h·ªçc',
                    description: 'Gi·∫£i ƒë√∫ng {target} b√†i to√°n',
                    target: 10,
                    reward: 75,
                    icon: 'üßÆ'
                },
                {
                    id: 'earn_money',
                    type: 'earn',
                    title: 'Ki·∫øm ti·ªÅn',
                    description: 'Ki·∫øm ƒë∆∞·ª£c {target} xu',
                    target: 200,
                    reward: 100,
                    icon: 'üí∞'
                },
                {
                    id: 'catch_legendary',
                    type: 'catch_legendary',
                    title: 'Huy·ªÅn tho·∫°i',
                    description: 'C√¢u ƒë∆∞·ª£c {target} con c√° Legendary tr·ªü l√™n',
                    target: 1,
                    reward: 200,
                    icon: 'üèÜ'
                }
            ];

            const shopItems = [
                {
                    id: 'legendary_rod',
                    name: 'New Rank Fish!',
                    description: 'Gi√∫p b·∫°n c√¢u ƒë∆∞·ª£c c√° Legendary',
                    price: 300,
                    color: 'bg-green-600 hover:bg-green-700',
                    unlocks: 'legendary'
                },
                {
                    id: 'mythic_rod',
                    name: 'Mythical Fishing Rod',
                    description: 'Gi√∫p b·∫°n c√¢u ƒë∆∞·ª£c c√° Mythic',
                    price: 500,
                    color: 'bg-red-600 hover:bg-red-700',
                    unlocks: 'mythic'
                },
                {
                    id: 'secret_rod',
                    name: 'Mysterious Fishing Rod',
                    description: 'Gi√∫p b·∫°n c√¢u ƒë∆∞·ª£c c√° Secret',
                    price: 700,
                    color: 'bg-gray-900 hover:bg-gray-800',
                    unlocks: 'secret'
                }
            ];

            // ‚≠ê ITEMS MUA ROLL TRONG SHOP
            const rollItems = [
                {
                    id: 'roll_single',
                    name: '1 L·∫ßn Roll T·ªôc',
                    description: 'Mua th√™m 1 l·∫ßn roll t·ªôc',
                    basePrice: 2000,
                    rolls: 1,
                    packType: 'single'
                },
                {
                    id: 'roll_five',
                    name: '5 L·∫ßn Roll T·ªôc',
                    description: 'Mua th√™m 5 l·∫ßn roll t·ªôc',
                    basePrice: 8000,
                    rolls: 5,
                    packType: 'five'
                },
                {
                    id: 'roll_ten',
                    name: '10 L·∫ßn Roll T·ªôc',
                    description: 'Mua th√™m 10 l·∫ßn roll t·ªôc',
                    basePrice: 15000,
                    rolls: 10,
                    packType: 'ten'
                }
            ];

            const executeAdminCommand = async () => {
                if (!isAdmin) {
                    setAdminOutput('‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠ d·ª•ng l·ªánh n√†y!');
                    return;
                }

                const parts = adminCommand.trim().split(' ');
                const command = parts[0].toLowerCase();

                try {
                    if (command === '/givefish') {
                        if (parts.length < 3) {
                            setAdminOutput('‚ùå C√∫ ph√°p: /givefish <t√™n c√°> <email> [mutation1,mutation2,...]');
                            return;
                        }

                        // T√¨m email (ph·∫ßn t·ª≠ cu·ªëi c√πng ch·ª©a @)
                        const emailIndex = parts.findIndex((part, idx) => idx > 0 && part.includes('@'));
                        if (emailIndex === -1) {
                            setAdminOutput('‚ùå Kh√¥ng t√¨m th·∫•y email h·ª£p l·ªá!');
                            return;
                        }
                        const fishName = parts.slice(1, emailIndex).join(' ');
                        const targetEmail = parts[emailIndex];
                        // X·ª≠ l√Ω mutation t√πy ch·ªçn (ph·∫ßn sau email)
                        let mutations = [];
                        if (parts.length > emailIndex + 1) {
                            const mutationParts = parts.slice(emailIndex + 1);
                            const mutationStr = mutationParts.join(' ');
                            if (mutationStr.includes(',')) {
                                mutations = mutationStr.split(',').map(m => m.trim()).filter(Boolean);
                            } else {
                                mutations = [mutationStr.trim()].filter(Boolean);
                            }
                        }
                        const usersSnapshot = await db.collection('users').where('email', '==', targetEmail).get();
                        
                        if (usersSnapshot.empty) {
                            setAdminOutput(`‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi ch∆°i: ${targetEmail}`);
                            return;
                        }

                        const targetUserId = usersSnapshot.docs[0].id;
                        let fishRarity = 'Common';
                        let fishColor = '#9CA3AF';
                        let basePrice = 10;
                        
                        for (const [rarity, names] of Object.entries(fishNames)) {
                            if (names.some(name => name.toLowerCase() === fishName.toLowerCase())) {
                                fishRarity = rarity;
                                const rarityData = rarities.find(r => r.name === rarity);
                                fishColor = rarityData?.color || '#9CA3AF';
                                basePrice = rarityData?.price || 10;
                                break;
                            }
                        }

                        // ‚≠ê T√çNH C√ÇN N·∫∂NG NG·∫™U NHI√äN GI·ªêNG KHI C√ÇU
                        let weight = 1.0;
                        let increaseChance = 1.0;
                        while (Math.random() < increaseChance) {
                            weight += 0.1;
                            increaseChance -= 0.001;
                        }
                        weight = Math.round(weight * 10) / 10;

                        // ‚≠ê T√çNH GI√Å THEO C√ÇN N·∫∂NG
                        const fishPrice = Math.round(basePrice * weight);

                        const fishData = {
                            name: fishName,
                            rarity: fishRarity,
                            weight: weight,
                            price: fishPrice,
                            color: fishColor,
                            favourite: false,
                            caughtAt: firebase.firestore.FieldValue.serverTimestamp(),
                            adminGiven: true
                        };
                        if (mutations.length > 0) {
                            fishData.mutation = mutations.join(' + ');
                        }

                        await db.collection('users').doc(targetUserId).collection('inventory').add(fishData);

                        const mutationStr = mutations.length > 0 ? ` (${mutations.join(' + ')})` : '';
                        setAdminOutput(`‚úÖ ƒê√£ t·∫∑ng "${fishName}"${mutationStr} (${weight}kg, ${fishPrice} xu) cho ${targetEmail}`);
                        saveLog('admin_give_fish', { fish: fishName, weight, target: targetEmail, mutations }, fishPrice);

                    } else if (command === '/ban') {
                        if (parts.length !== 2) {
                            setAdminOutput('‚ùå C√∫ ph√°p: /ban <email>');
                            return;
                        }
                        const targetEmail = parts[1];
                        const usersSnapshot = await db.collection('users').where('email', '==', targetEmail).get();
                        if (usersSnapshot.empty) {
                            setAdminOutput(`‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi ch∆°i: ${targetEmail}`);
                            return;
                        }
                        const targetUserId = usersSnapshot.docs[0].id;
                        await db.collection('users').doc(targetUserId).update({ banned: true });
                        setAdminOutput(`‚úÖ ƒê√£ ban ${targetEmail}`);
                        saveLog('admin_ban', { target: targetEmail }, 0);
                        
                    } else if (command === '/unban') {
                        if (parts.length !== 2) {
                            setAdminOutput('‚ùå C√∫ ph√°p: /unban <email>');
                            return;
                        }
                        const targetEmail = parts[1];
                        const usersSnapshot = await db.collection('users').where('email', '==', targetEmail).get();
                        if (usersSnapshot.empty) {
                            setAdminOutput(`‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi ch∆°i: ${targetEmail}`);
                            return;
                        }
                        const targetUserId = usersSnapshot.docs[0].id;
                        await db.collection('users').doc(targetUserId).update({ banned: false });
                        setAdminOutput(`‚úÖ ƒê√£ unban ${targetEmail}`);
                        saveLog('admin_unban', { target: targetEmail }, 0);

                    } else if (command === '/fishingonlysecret') {
                        if (parts.length !== 3) {
                            setAdminOutput('‚ùå C√∫ ph√°p: /fishingonlysecret <email> <on/off>');
                            return;
                        }
                        const targetEmail = parts[1];
                        const modeStr = parts[2].toLowerCase();
    
                        let newMode;
                        if (modeStr === 'on') {
                            newMode = true;
                        } else if (modeStr === 'off') {
                            newMode = false;
                        } else {
                            setAdminOutput('‚ùå Mode ph·∫£i l√† "on" ho·∫∑c "off"!');
                            return;
                        }
    
                        const usersSnapshot = await db.collection('users').where('email', '==', targetEmail).get();
    
                        if (usersSnapshot.empty) {
                            setAdminOutput(`‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi ch∆°i: ${targetEmail}`);
                            return;
                        }
    
                        const targetUserId = usersSnapshot.docs[0].id;
                        const userData = usersSnapshot.docs[0].data();
    
                        if (!userData.ownedRods || !userData.ownedRods.includes('secret')) {
                            setAdminOutput(`‚ùå ${targetEmail} ch∆∞a c√≥ c·∫ßn c√¢u Secret!`);
                            return;
                        }
    
                        await db.collection('users').doc(targetUserId).update({ fishingOnlySecret: newMode });
    
                        setAdminOutput(`‚úÖ ƒê√£ set ch·∫ø ƒë·ªô only Secret cho ${targetEmail} th√†nh ${newMode ? 'ON' : 'OFF'}`);
                        saveLog('admin_fishing_only_secret', { target: targetEmail, mode: newMode ? 'on' : 'off' }, 0);
                
                    } else if (command === '/givemoney') {
                        if (parts.length !== 3) {
                            setAdminOutput('‚ùå C√∫ ph√°p: /givemoney <s·ªë xu> <email>');
                            return;
                        }

                        const amount = parseInt(parts[1]);
                        const targetEmail = parts[2];

                        if (isNaN(amount)) {
                            setAdminOutput('‚ùå S·ªë xu ph·∫£i l√† s·ªë!');
                            return;
                        }

                        const usersSnapshot = await db.collection('users').where('email', '==', targetEmail).get();
                        
                        if (usersSnapshot.empty) {
                            setAdminOutput(`‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi ch∆°i: ${targetEmail}`);
                            return;
                        }

                        const targetUserId = usersSnapshot.docs[0].id;
                        const userData = usersSnapshot.docs[0].data();
                        const currentMoney = userData.money || 0;
                        if (currentMoney >= MAX_MONEY) {
                            setAdminOutput(`‚ùå ${targetEmail} ƒë√£ ƒë·∫°t m·ª©c ti·ªÅn t·ªëi ƒëa (${formatMoney(MAX_MONEY)}). Kh√¥ng th·ªÉ t·∫∑ng th√™m!`);
                            return;
                        }
                        const newMoney = Math.min(currentMoney + amount, MAX_MONEY);

                        await db.collection('users').doc(targetUserId).update({ money: newMoney });

                        setAdminOutput(`‚úÖ ƒê√£ t·∫∑ng ${amount} xu cho ${targetEmail}`);
                        saveLog('admin_give_money', { amount, target: targetEmail }, amount);

                    } else if (command === '/giverod') {
                        if (parts.length !== 3) {
                            setAdminOutput('‚ùå C√∫ ph√°p: /giverod <legendary|mythic|secret> <email>');
                            return;
                        }

                        const rodType = parts[1].toLowerCase();
                        const targetEmail = parts[2];

                        if (!['legendary', 'mythic', 'secret'].includes(rodType)) {
                            setAdminOutput('‚ùå Lo·∫°i c·∫ßn kh√¥ng h·ª£p l·ªá! (legendary, mythic, secret)');
                            return;
                        }

                        const usersSnapshot = await db.collection('users').where('email', '==', targetEmail).get();
                        
                        if (usersSnapshot.empty) {
                            setAdminOutput(`‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi ch∆°i: ${targetEmail}`);
                            return;
                        }

                        const targetUserId = usersSnapshot.docs[0].id;
                        const userData = usersSnapshot.docs[0].data();
                        const ownedRods = userData.ownedRods || ['normal'];

                        if (!ownedRods.includes(rodType)) {
                            ownedRods.push(rodType);
                            await db.collection('users').doc(targetUserId).update({ ownedRods });
                            setAdminOutput(`‚úÖ ƒê√£ t·∫∑ng c·∫ßn c√¢u ${rodType} cho ${targetEmail}`);
                        } else {
                            setAdminOutput(`‚ö†Ô∏è ${targetEmail} ƒë√£ c√≥ c·∫ßn c√¢u ${rodType}`);
                            saveLog('admin_give_rod', { rod: rodType, target: targetEmail }, 0);
                        }

                    } else if (command === '/giveroll') {
                        if (parts.length !== 3) {
                            setAdminOutput('‚ùå C√∫ ph√°p: /giveroll <s·ªë l·∫ßn roll> <email>');
                            return;
                        }

                        const amount = parseInt(parts[1]);
                        if (isNaN(amount) || amount <= 0) {
                            setAdminOutput('‚ùå S·ªë l·∫ßn roll ph·∫£i l√† s·ªë d∆∞∆°ng!');
                            return;
                        }

                        const targetEmail = parts[2];

                        const usersSnapshot = await db.collection('users').where('email', '==', targetEmail).get();
    
                        if (usersSnapshot.empty) {
                            setAdminOutput(`‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi ch∆°i: ${targetEmail}`);
                            return;
                        }

                        const targetUserId = usersSnapshot.docs[0].id;
                        const userData = usersSnapshot.docs[0].data();
                        const newRollCount = (userData.rollCount || 0) + amount;

                        await db.collection('users').doc(targetUserId).update({ rollCount: newRollCount });

                        setAdminOutput(`‚úÖ ƒê√£ t·∫∑ng ${amount} l·∫ßn roll cho ${targetEmail}`);
                        saveLog('admin_give_roll', { amount, target: targetEmail }, 0);

                    } else if (command === '/setrace') {
                        if (parts.length !== 3) {
                            setAdminOutput('‚ùå C√∫ ph√°p: /setrace <t√™n t·ªôc> <email> (t·ªôc: nguoi, ca, nemo, poseidon)');
                            return;
                        }

                        const tribeKey = parts[1].toLowerCase();
                        if (!Object.keys(tribes).includes(tribeKey)) {
                            setAdminOutput('‚ùå T·ªôc kh√¥ng h·ª£p l·ªá! (nguoi, ca, nemo, poseidon)');
                            return;
                        }

                        const targetEmail = parts[2];

                        const usersSnapshot = await db.collection('users').where('email', '==', targetEmail).get();
    
                        if (usersSnapshot.empty) {
                            setAdminOutput(`‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi ch∆°i: ${targetEmail}`);
                            return;
                        }

                        const targetUserId = usersSnapshot.docs[0].id;

                        await db.collection('users').doc(targetUserId).update({ tribe: tribeKey });

                        setAdminOutput(`‚úÖ ƒê√£ set t·ªôc "${tribes[tribeKey].name}" cho ${targetEmail}`);
                        saveLog('admin_set_race', { tribe: tribes[tribeKey].name, target: targetEmail }, 0);

                    } else if (command === '/giveitem') {
                        if (parts.length < 3) {
                            setAdminOutput('‚ùå C√∫ ph√°p: /giveitem <t√™n item> <email>');
                            return;
                        }

                        const itemKey = parts[1].toLowerCase();
                        if (!Object.keys(itemDefs).includes(itemKey)) {
                            setAdminOutput(`‚ùå Item kh√¥ng h·ª£p l·ªá! (${Object.keys(itemDefs).join(', ')})`);
                            return;
                        }

                        // L·∫•y email t·ª´ ph·∫ßn c√≤n l·∫°i (c√≥ th·ªÉ ch·ª©a kho·∫£ng tr·∫Øng)
                        const targetEmail = parts.slice(2).join(' ').trim();

                        const usersSnapshot = await db.collection('users').where('email', '==', targetEmail).get();
    
                        if (usersSnapshot.empty) {
                            setAdminOutput(`‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi ch∆°i: ${targetEmail}`);
                            return;
                        }

                        const targetUserId = usersSnapshot.docs[0].id;
                        const newItem = {
                            id: Date.now().toString(),
                            key: itemKey,
                            receivedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        await db.collection('users').doc(targetUserId).collection('items').doc(newItem.id).set(newItem);

                        setAdminOutput(`‚úÖ ƒê√£ t·∫∑ng item "${itemDefs[itemKey].name}" cho ${targetEmail}`);
                        saveLog('admin_give_item', { item: itemDefs[itemKey].name, target: targetEmail }, 0);

                    } else if (command === '/setweather') {
                        if (parts.length !== 2) {
                            setAdminOutput('‚ùå C√∫ ph√°p: /setweather <t√™n/off>');
                            return;
                        }

                        const arg = parts[1].toLowerCase();
                        if (arg === 'off') {
                            const expiresAt = new Date(Date.now() + WEATHER_DURATION_MS);
                            await weatherRef.set({
                                adminOverride: {
                                    active: false,
                                    weatherKey: firebase.firestore.FieldValue.delete(),
                                    setBy: currentUser,
                                    setAt: firebase.firestore.FieldValue.serverTimestamp()
                                },
                                expiresAt: firebase.firestore.Timestamp.fromDate(expiresAt),
                                nextUpdateAt: firebase.firestore.Timestamp.fromDate(expiresAt),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            }, { merge: true });
                            setAdminOutput('‚úÖ ƒê√£ t·∫Øt admin weather (quay v·ªÅ weather th∆∞·ªùng).');
                            saveLog('admin_set_weather', { mode: 'off' }, 0);
                            return;
                        }

                        if (!weatherDefs[arg] || weatherDefs[arg].isAdminWeather !== true) {
                            setAdminOutput('‚ùå Weather admin kh√¥ng h·ª£p l·ªá! (volcano, blackhole, rainbow ho·∫∑c off)');
                            return;
                        }

                        const expiresAt = new Date(Date.now() + WEATHER_DURATION_MS);
                        await weatherRef.set({
                            adminOverride: {
                                active: true,
                                weatherKey: arg,
                                setBy: currentUser,
                                setAt: firebase.firestore.FieldValue.serverTimestamp()
                            },
                            expiresAt: firebase.firestore.Timestamp.fromDate(expiresAt),
                            nextUpdateAt: firebase.firestore.Timestamp.fromDate(expiresAt),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });

                        setAdminOutput(`‚úÖ ƒê√£ set admin weather: ${weatherDefs[arg].name}`);
                        saveLog('admin_set_weather', { mode: 'on', weather: arg }, 0);

                    } else if (command === '/addweather') {
                        if (parts.length < 2) {
                            setAdminOutput('‚ùå C√∫ ph√°p: /addweather <t√™n> [ph√∫t]');
                            return;
                        }

                        const weatherKey = parts[1].toLowerCase();
                        if (!weatherDefs[weatherKey]) {
                            setAdminOutput('‚ùå Weather kh√¥ng h·ª£p l·ªá!');
                            return;
                        }

                        const minutes = parts.length >= 3 ? parseInt(parts[2]) : 5;
                        if (isNaN(minutes) || minutes <= 0) {
                            setAdminOutput('‚ùå Th·ªùi gian ph·∫£i l√† s·ªë d∆∞∆°ng (ph√∫t)!');
                            return;
                        }

                        const expiresAt = new Date(Date.now() + minutes * 60 * 1000);
                        await weatherRef.set({
                            addedWeathers: firebase.firestore.FieldValue.arrayUnion({
                                key: weatherKey,
                                expiresAt: firebase.firestore.Timestamp.fromDate(expiresAt),
                                addedBy: currentUser,
                                addedAt: Date.now()
                            }),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });

                        setAdminOutput(`‚úÖ ƒê√£ th√™m weather ${weatherDefs[weatherKey].name} (${minutes} ph√∫t)`);
                        saveLog('admin_add_weather', { weather: weatherKey, minutes }, 0);

                    } else if (command === '/help') {
                        setAdminOutput(`
                        üìã Danh s√°ch l·ªánh Admin:
                        ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                        /givefish <t√™n c√°> <email> [mutation1,mutation2,...]
                          ‚Üí T·∫∑ng c√° cho B·∫§T K·ª≤ ng∆∞·ªùi ch∆°i n√†o
                          ‚Üí C√≥ th·ªÉ ch·ªçn nhi·ªÅu mutation, ngƒÉn c√°ch b·ªüi d·∫•u ph·∫©y
                          ‚Üí VD: /givefish C√° R·ªìng player@gmail.com L·∫•p l√°nh,N√≥ng
                          ‚Üí VD: /givefish C√° R·ªìng player@gmail.com

                        /givemoney <s·ªë xu> <email>
                          ‚Üí T·∫∑ng xu cho B·∫§T K·ª≤ ng∆∞·ªùi ch∆°i n√†o  
                          ‚Üí VD: /givemoney 1000 player@gmail.com

                        /giverod <legendary|mythic|secret> <email>
                          ‚Üí T·∫∑ng c·∫ßn c√¢u cho B·∫§T K·ª≤ ng∆∞·ªùi ch∆°i n√†o
                          ‚Üí VD: /giverod mythic player@gmail.com

                        /ban <email>
                          ‚Üí Ban ng∆∞·ªùi ch∆°i (hi·ªÉn th·ªã th√¥ng b√°o ban khi login)
                          ‚Üí VD: /ban player@gmail.com

                        /unban <email>
                          ‚Üí Unban ng∆∞·ªùi ch∆°i (x√≥a tr·∫°ng th√°i ban)
                          ‚Üí VD: /unban player@gmail.com

                        /giveroll <s·ªë l·∫ßn roll> <email>
                          ‚Üí T·∫∑ng s·ªë l·∫ßn roll t·ªôc cho ng∆∞·ªùi ch∆°i
                          ‚Üí VD: /giveroll 5 player@gmail.com

                        /giveitem <t√™n item> <email>
                          ‚Üí T·∫∑ng item cho ng∆∞·ªùi ch∆°i
                          ‚Üí VD: /giveitem bat_quai_khai_mo player@gmail.com

                        /setrace <t√™n t·ªôc> <email>
                          ‚Üí Set t·ªôc cho ng∆∞·ªùi ch∆°i (nguoi, ca, nemo, poseidon)
                          ‚Üí VD: /setrace poseidon player@gmail.com

                        /fishingonlysecret <email> <on/off>
                          ‚Üí Set ng∆∞·ªùi ch∆°i c√¢u ƒë∆∞·ª£c to√†n c√° secret
                          ‚Üí VD: /fishingonlysecret player@gmail.com on

                        /setweather <volcano|blackhole|rainbow|off>
                          ‚Üí B·∫≠t/t·∫Øt admin weather
                          ‚Üí VD: /setweather blackhole

                        /addweather <t√™n> [ph√∫t]
                          ‚Üí Th√™m weather ch·ªìng l√™n weather hi·ªán t·∫°i
                          ‚Üí M·ªói weather c√≥ th·ªùi gian v√† hi·ªáu ·ª©ng ri√™ng
                          ‚Üí VD: /addweather volcano 3

                        /help - Hi·ªÉn th·ªã tr·ª£ gi√∫p
                        ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                        ‚úÖ B·∫°n c√≥ th·ªÉ give/ban cho M·ªåI email, kh√¥ng ch·ªâ admin!
                        `);

                    } else {
                        setAdminOutput('‚ùå L·ªánh kh√¥ng h·ª£p l·ªá! G√µ /help ƒë·ªÉ xem danh s√°ch l·ªánh.');
                    }

                } catch (error) {
                    setAdminOutput(`‚ùå L·ªói: ${error.message}`);
                }
            };

            // Ki·ªÉm tra Firebase config
            useEffect(() => {
                if (firebaseConfig.apiKey === "Idk") {
                    setConfigError(true);
                }
            }, []);

            // Animation s·ªë ti·ªÅn ch·∫°y
            useEffect(() => {
                if (displayMoney !== money) {
                    moneyRef.current = money; // C·∫≠p nh·∫≠t ref khi money thay ƒë·ªïi
                    const diff = money - displayMoney;
                    const step = diff / 20; // Chia th√†nh 20 b∆∞·ªõc
        
                    const interval = setInterval(() => {
                        setDisplayMoney(prev => {
                            const next = prev + step;
                            // N·∫øu ƒë√£ g·∫ßn ƒë·∫øn s·ªë cu·ªëi th√¨ set lu√¥n
                            if (Math.abs(money - next) < Math.abs(step)) {
                                clearInterval(interval);
                                return money;
                            }
                            return next;
                        });
                    }, 30); // M·ªói 30ms update 1 l·∫ßn
        
                    return () => clearInterval(interval);
                }
            }, [money]);

            // L·∫Øng nghe tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
            // L·∫Øng nghe tr·∫°ng th√°i ƒëƒÉng nh·∫≠p (FIX BAN)
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        setUserId(user.uid);
                        
                        // X√°c ƒë·ªãnh lo·∫°i ƒëƒÉng nh·∫≠p v√† email hi·ªÉn th·ªã
                        if (user.isAnonymous) {
                            setCurrentUser('·∫®n danh');
                            setIsAnonymous(true);
                        } else {
                            setCurrentUser(user.email);
                            setIsAnonymous(false);
                        }

                        // ‚≠ê KI·ªÇM TRA BAN TR∆Ø·ªöC KHI LOAD DATA
                        const gameDoc = await db.collection('users').doc(user.uid).get();
                        if (gameDoc.exists && gameDoc.data().banned === true) {
                            setGameState('banned');
                            return; // D·ª™NG, KH√îNG LOAD DATA
                        }

                        // Kh√¥ng load data n·ªØa, listener s·∫Ω handle
                        setGameState('menu');
                    } else {
                        setGameState('login');
                        setIsAnonymous(false);
                    }            
                });
                return () => unsubscribe();
            }, []);
            // Auto-save game data
            useEffect(() => {
                if (userId && gameState === 'menu' && !isAnonymous) {
                    const saveTimer = setTimeout(() => {
                        saveGameData();
                    }, 2000);
                    return () => clearTimeout(saveTimer);
                }
            }, [money, fishingRod, ownedRods, currentBait, ownedBaits, userId, isAnonymous]);

            useEffect(() => {
                if (!userId) return;

                // Listener cho user document (money, rods, baits, tribe, roll, etc.)
                const unsubscribeUser = db.collection('users').doc(userId).onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        const newMoney = data.money || 0;
                        
                        // Ch·ªâ c·∫≠p nh·∫≠t money n·∫øu th·ª±c s·ª± thay ƒë·ªïi (so s√°nh v·ªõi ref)
                        if (newMoney !== moneyRef.current) {
                            moneyRef.current = newMoney;
                            setMoney(newMoney);
                        }
                        
                        setFishingRod(data.fishingRod || 'normal');
                        setOwnedRods(data.ownedRods || ['normal']);
                        setCurrentBait(data.currentBait || 'normal');
                        setOwnedBaits(data.ownedBaits || ['normal']);
                        setTribe(data.tribe || 'nguoi');
                        setRollCount(data.rollCount || 0);
                        setPurchasedRollPacks(data.purchasedRollPacks || { single: 0, five: 0, ten: 0 });
                        setFishingOnlySecret(data.fishingOnlySecret || false);
                        setIsBanned(data.banned || false);
                        setTaiChiCooldownUntil(data.taiChiCooldownUntil || null);
                        
                        // Ki·ªÉm tra hasUsedTaiChi v√† cooldown ƒë·ªÉ set hasTaiChiPower
                        if (data.hasUsedTaiChi && !data.taiChiCooldownUntil) {
                            // ƒê√£ t·ª´ng d√πng Th√°i C·ª±c v√† kh√¥ng c√≥ cooldown
                            const now = Date.now();
                            if (!data.taiChiCooldownUntil || now >= data.taiChiCooldownUntil) {
                                setHasTaiChiPower(true);
                            } else {
                                setHasTaiChiPower(false);
                            }
                        }

                        // ‚≠ê‚≠ê‚≠ê LOGIC REALTIME BAN/UNBAN ‚≠ê‚≠ê‚≠ê
                        if (data.banned === true) {
                            // User b·ªã ban ‚Üí chuy·ªÉn ngay sang trang banned (KH√îNG SIGNOUT)
                            setGameState('banned');
                        } else if (gameState === 'banned') {
                            // User ƒë∆∞·ª£c unban ‚Üí quay l·∫°i menu REALTIME (v√† load data)
                            setGameState('menu');
                            loadGameData(userId); // Reload data ƒë·ªÉ ƒë·ªìng b·ªô sau unban
                        }
                    }
                });

                // Listener cho inventory collection (c√° m·ªõi t·ª´ /givefish)
                const unsubscribeInventory = db.collection('users').doc(userId).collection('inventory').onSnapshot((snapshot) => {
                    const fishList = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setInventory(fishList);
                });

                // Listener cho quests (n·∫øu admin th√™m l·ªánh sau, ho·∫∑c an to√†n)
                const unsubscribeQuests = db.collection('users').doc(userId).collection('quests').doc('daily').onSnapshot((doc) => {
                    if (doc.exists) {
                        const questData = doc.data();
                        setDailyQuests(questData.quests || []);
                        setLastQuestReset(questData.lastReset ? questData.lastReset.toDate() : null);
                    } else {
                        // N·∫øu kh√¥ng t·ªìn t·∫°i, init m·ªõi
                        checkAndResetQuests(userId);
                    }
                });

                return () => {
                    unsubscribeUser();
                    unsubscribeInventory();
                    unsubscribeQuests();
                };
            }, [userId, gameState]);  // ‚≠ê Th√™m gameState v√†o dependency ƒë·ªÉ track thay ƒë·ªïi

            useEffect(() => {
                if (!userId) return;
                ensureWeatherDoc();
                const unsubscribeWeather = weatherRef.onSnapshot((doc) => {
                    const data = doc.exists ? doc.data() : null;
                    setWeatherDocData(data);
                    setCurrentWeather(buildCurrentWeatherState(data));
                });
                return () => {
                    unsubscribeWeather();
                };
            }, [userId]);

            useEffect(() => {
                if (!userId) return;
                
                // Real-time listener for items
                const unsubscribeItems = db.collection('users').doc(userId).collection('items')
                    .onSnapshot((snapshot) => {
                        const itemsList = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setItems(itemsList);
                    }, (error) => {
                        console.error('L·ªói khi nghe items:', error);
                    });
                
                return () => {
                    unsubscribeItems();
                };
            }, [userId]);

            useEffect(() => {
                if (!userId) return;
                
                // Check Th√°i C·ª±c cooldown m·ªói gi√¢y
                const checkCooldown = setInterval(() => {
                    if (taiChiCooldownUntil) {
                        const now = Date.now();
                        if (now >= taiChiCooldownUntil) {
                            // H·∫øt cooldown
                            setTaiChiCooldownUntil(null);
                            setHasTaiChiPower(true);
                            
                            // X√≥a cooldown kh·ªèi Firestore
                            db.collection('users').doc(userId).update({
                                taiChiCooldownUntil: firebase.firestore.FieldValue.delete()
                            }).catch(error => {
                                console.warn('Kh√¥ng th·ªÉ x√≥a cooldown kh·ªèi Firestore:', error);
                                // Kh√¥ng sao, state local ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t
                            });
                        }
                    }
                }, 1000);
                
                return () => {
                    clearInterval(checkCooldown);
                };
            }, [userId, taiChiCooldownUntil]);

            useEffect(() => {
                if (!userId) return;
                tickWeatherIfNeeded();
                const interval = setInterval(() => {
                    tickWeatherIfNeeded();
                }, 30000);
                return () => clearInterval(interval);
            }, [userId]);

            useEffect(() => {
                if (!userId) return;
                setWeatherNowMs(Date.now());
                const interval = setInterval(() => {
                    setWeatherNowMs(Date.now());
                }, 1000);
                return () => clearInterval(interval);
            }, [userId]);

            useEffect(() => {
                if (!userId) return;
                const expiresAtMs = currentWeather?.expiresAtMs || 0;
                const nextRandomAtMs = currentWeather?.nextRandomAtMs || 0;
                const now = weatherNowMs;
                // Trigger when weather expires (enter waiting state)
                if (expiresAtMs && now >= expiresAtMs && weatherExpiryHandledRef.current !== expiresAtMs) {
                    weatherExpiryHandledRef.current = expiresAtMs;
                    tickWeatherIfNeeded();
                    return;
                }
                // Trigger when waiting period ends (random new weather)
                if (nextRandomAtMs && now >= nextRandomAtMs && weatherExpiryHandledRef.current !== nextRandomAtMs) {
                    weatherExpiryHandledRef.current = nextRandomAtMs;
                    tickWeatherIfNeeded();
                }
            }, [userId, weatherNowMs, currentWeather?.expiresAtMs, currentWeather?.nextRandomAtMs]);

            const loadGameData = async (uid) => {
                try {
                    const gameDoc = await db.collection('users').doc(uid).get();
                    if (gameDoc.exists) {
                        const data = gameDoc.data();
                        const newMoney = data.money || 0;
                        
                        // Ch·ªâ set money v√† displayMoney khi load l·∫ßn ƒë·∫ßu
                        moneyRef.current = newMoney;
                        setMoney(newMoney);
                        setDisplayMoney(newMoney);
                        
                        setFishingRod(data.fishingRod || 'normal');
                        setOwnedRods(data.ownedRods || ['normal']);
                        setCurrentBait(data.currentBait || 'normal');
                        setOwnedBaits(data.ownedBaits || ['normal']);
                        setTribe(data.tribe || 'nguoi');
                        setRollCount(data.rollCount || 0);
                        setPurchasedRollPacks(data.purchasedRollPacks || { single: 0, five: 0, ten: 0 });
                        setFishingOnlySecret(data.fishingOnlySecret || false);
                        setTaiChiCooldownUntil(data.taiChiCooldownUntil || null);
                    }

                    const inventorySnapshot = await db.collection('users').doc(uid).collection('inventory').get();
                    const fishList = inventorySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setInventory(fishList);

                    // Load items
                    const itemsSnapshot = await db.collection('users').doc(uid).collection('items').get();
                    const itemsList = itemsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setItems(itemsList);

                    // Load Th√°i C·ª±c cooldown
                    try {
                        const cooldownDoc = await db.collection('users').doc(uid).get();
                        const cooldownData = cooldownDoc.data();
                        if (cooldownData && cooldownData.taiChiCooldownUntil) {
                            setTaiChiCooldownUntil(cooldownData.taiChiCooldownUntil);
                            
                            // Ki·ªÉm tra xem ƒë√£ h·∫øt cooldown ch∆∞a
                            const now = Date.now();
                            if (now >= cooldownData.taiChiCooldownUntil) {
                                // ƒê√£ h·∫øt cooldown, x√≥a v√† cho s·ª≠ d·ª•ng
                                try {
                                    await db.collection('users').doc(uid).update({
                                        taiChiCooldownUntil: firebase.firestore.FieldValue.delete()
                                    });
                                } catch (error) {
                                    console.warn('Kh√¥ng th·ªÉ x√≥a cooldown:', error);
                                }
                                setTaiChiCooldownUntil(null);
                                setHasTaiChiPower(true);
                            } else {
                                // V·∫´n c√≤n cooldown
                                setHasTaiChiPower(false);
                            }
                        } else {
                            // Kh√¥ng c√≥ cooldown, ki·ªÉm tra xem ƒë√£ t·ª´ng s·ª≠ d·ª•ng Th√°i C·ª±c ch∆∞a
                            if (cooldownData && cooldownData.hasUsedTaiChi) {
                                // ƒê√£ t·ª´ng d√πng Th√°i C·ª±c v√† kh√¥ng c√≥ cooldown = c√≥ th·ªÉ d√πng
                                setHasTaiChiPower(true);
                            }
                        }
                    } catch (error) {
                        console.warn('Kh√¥ng th·ªÉ load cooldown:', error);
                        // Kh√¥ng l√†m g√¨ c·∫£, ƒë·ªÉ state m·∫∑c ƒë·ªãnh
                    }
        
                    // Load nhi·ªám v·ª• h·∫±ng ng√†y
                    await checkAndResetQuests(uid);
                } catch (error) {
                    console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
                }
            };

            // Kh·ªüi t·∫°o nhi·ªám v·ª• h·∫±ng ng√†y
            const initializeDailyQuests = () => {
                const quests = dailyQuestTemplates.map(template => ({
                    ...template,
                    progress: 0,
                    completed: false,
                    claimed: false
                }));
                return quests;
            };

            // Ki·ªÉm tra v√† reset nhi·ªám v·ª• n·∫øu qua ng√†y m·ªõi
            const checkAndResetQuests = async (uid) => {
                try {
                    const questDoc = await db.collection('users').doc(uid).collection('quests').doc('daily').get();
        
                    if (questDoc.exists) {
                        const questData = questDoc.data();
                        const lastReset = questData.lastReset ? questData.lastReset.toDate() : new Date(0);
                        const today = new Date();
            
                        // Ki·ªÉm tra xem ƒë√£ qua ng√†y m·ªõi ch∆∞a
                        if (lastReset.toDateString() !== today.toDateString()) {
                            // Reset nhi·ªám v·ª•
                            const newQuests = initializeDailyQuests();
                            await db.collection('users').doc(uid).collection('quests').doc('daily').set({
                                quests: newQuests,
                                lastReset: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            setDailyQuests(newQuests);
                            setLastQuestReset(today);
                        } else {
                            // Load nhi·ªám v·ª• hi·ªán t·∫°i
                            setDailyQuests(questData.quests || []);
                            setLastQuestReset(lastReset);
                        }
                    } else {
                        // T·∫°o nhi·ªám v·ª• l·∫ßn ƒë·∫ßu
                        const newQuests = initializeDailyQuests();
                        await db.collection('users').doc(uid).collection('quests').doc('daily').set({
                            quests: newQuests,
                            lastReset: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        setDailyQuests(newQuests);
                        setLastQuestReset(new Date());
                    }
                } catch (error) {
                    console.error('L·ªói khi ki·ªÉm tra nhi·ªám v·ª•:', error);
                }
            };

            // C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô nhi·ªám v·ª•
            const updateQuestProgress = async (questType, amount = 1, rarityName = '') => {
                if (!userId || dailyQuests.length === 0) return;
    
                let updated = false;
                const newQuests = dailyQuests.map(quest => {
                    if (quest.completed) return quest;
        
                    let shouldUpdate = false;
        
                    switch (quest.type) {
                        case 'catch':
                            shouldUpdate = questType === 'catch';
                            break;
                        case 'catch_rare':
                            shouldUpdate = questType === 'catch' && ['Rare', 'Legendary', 'Mythic', 'Secret'].includes(rarityName);
                            break;
                        case 'catch_legendary':
                            shouldUpdate = questType === 'catch' && ['Legendary', 'Mythic', 'Secret'].includes(rarityName);
                            break;
                        case 'solve':
                            shouldUpdate = questType === 'solve';
                            break;
                        case 'earn':
                            shouldUpdate = questType === 'earn';
                            break;
                    }
        
                    if (shouldUpdate) {
                        updated = true;
                        const newProgress = Math.min(quest.progress + amount, quest.target);
                        return {
                            ...quest,
                            progress: newProgress,
                            completed: newProgress >= quest.target
                        };
                    }
        
                    return quest;
                });
    
                if (updated) {
                    setDailyQuests(newQuests);
        
                    // L∆∞u v√†o Firebase
                    try {
                        await db.collection('users').doc(userId).collection('quests').doc('daily').update({
                            quests: newQuests
                        });
                    } catch (error) {
                        console.error('L·ªói khi c·∫≠p nh·∫≠t nhi·ªám v·ª•:', error);
                    }
                }
            };

            // Nh·∫≠n th∆∞·ªüng nhi·ªám v·ª•
            const claimQuestReward = async (questId) => {
                const quest = dailyQuests.find(q => q.id === questId);

                if (!quest || !quest.completed || quest.claimed) {
                    return;
                }

                const newMoney = money + quest.reward;
                const newQuests = dailyQuests.map(q => 
                    q.id === questId ? { ...q, claimed: true } : q
                );

                updateMoneyWithAnimation(newMoney, quest.reward); // ‚Üê Thay ƒë·ªïi
                // ‚≠ê TH√äM LOG QUEST
                saveLog('quest_reward', { quest: quest.title, reward: quest.reward }, quest.reward);
                setDailyQuests(newQuests);

                try {
                    await db.collection('users').doc(userId).update({ money: Math.min(newMoney, MAX_MONEY) });
                    await db.collection('users').doc(userId).collection('quests').doc('daily').update({
                        quests: newQuests
                    });

                    setMessage(`üéâ ƒê√£ nh·∫≠n th∆∞·ªüng ${formatMoney(quest.reward)} xu!`);
                    setTimeout(() => setMessage(''), 3000);
                } catch (error) {
                    console.error('L·ªói khi nh·∫≠n th∆∞·ªüng:', error);
                }
            };

            const saveGameData = async () => {
                if (!userId) return;
                try {
                    await db.collection('users').doc(userId).set({
                        money,
                        fishingRod,
                        ownedRods,
                        currentBait,
                        ownedBaits,
                        fishingOnlySecret,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                } catch (error) {
                    console.error('L·ªói khi l∆∞u:', error);
                }
            };

            // ‚≠ê H√ÄM L∆ØU LOG (v·ªõi DEBUG CHI TI·∫æT)
            const saveLog = async (action, details = {}, amount = 0) => {
                if (!userId || !currentUser) {
                    console.warn('‚ö†Ô∏è Skip log: No userId/currentUser');
                    return;
                }
                try {
                    console.log('üíæ Saving log:', { action, details, amount, userEmail: currentUser }); // DEBUG CHI TI·∫æT
                    const logRef = await db.collection('logs').add({
                        action,
                        userEmail: currentUser,
                        details,
                        amount,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úÖ Log saved with ID:', logRef.id); // DEBUG ID DOC
                } catch (error) {
                    console.error('‚ùå L·ªói l∆∞u log chi ti·∫øt:', error.message); // DEBUG ERROR
                }
            };

            // ‚≠ê FORMAT MESSAGE LOGS
            const formatLogMessage = (log) => {
                const d = log.details || {};
                switch (log.action) {
                    case 'catch_fish':
                        return `${d.name || 'C√°'} (${d.weight || 0}kg, ${d.rarity || 'Unknown'})`;
                    case 'buy_rod':
                        return `Mua c·∫ßn c√¢u "${d.rod || 'Unknown'} (${d.price || 0} xu)`;
                    case 'buy_bait':
                        return `Mua m·ªìi "${d.bait || 'Unknown'} (${d.price || 0} xu)`;
                    case 'sell_fish':
                        return `B√°n ${d.count || 0} c√° (nh·∫≠n ${d.total || 0} xu)`;
                    case 'quest_reward':
                        return `Nh·∫≠n th∆∞·ªüng nhi·ªám v·ª• "${d.quest || 'Unknown'} (${d.reward || 0} xu)"`;
                    case 'admin_give_fish':
                        return `Admin t·∫∑ng c√° "${d.fish || 'Unknown'} (${d.weight || 0}kg)"`;
                    case 'admin_give_money':
                        return `Admin t·∫∑ng ${d.amount || 0} xu`;
                    case 'admin_give_rod':
                        return `Admin t·∫∑ng c·∫ßn "${d.rod || 'Unknown'}"`;
                    case 'admin_ban':
                        return `Admin BAN user "${d.target || ''}"`;
                    case 'admin_unban':
                        return `Admin UNBAN user "${d.target || ''}"`;
                    case 'admin_fishing_only_secret':
                        return `Admin ${d.mode || 'unknown'} only Secret cho "${d.target || ''}"`;
                    default:
                        return 'Ho·∫°t ƒë·ªông kh√°c';
                }
            };

            const loadLeaderboard = async () => {
               setLoadingLeaderboard(true);
               try {
                   // L·∫•y d·ªØ li·ªáu t·∫•t c·∫£ ng∆∞·ªùi ch∆°i
                   const usersSnapshot = await db.collection('users').get();
                   const leaderboard = [];

                   for (const userDoc of usersSnapshot.docs) {
                       const userData = userDoc.data();
            
                       // ƒê·∫øm s·ªë c√° c·ªßa ng∆∞·ªùi ch∆°i
                       const inventorySnapshot = await db.collection('users')
                           .doc(userDoc.id)
                           .collection('inventory')
                           .get();
            
                       const fishCount = inventorySnapshot.size;
            
                       leaderboard.push({
                           id: userDoc.id,
                           email: userData.email || 'Anonymous',
                           money: userData.money || 0,
                           fishCount: fishCount
                       });
                   }

                   setLeaderboardData(leaderboard);
               } catch (error) {
                   console.error('L·ªói khi t·∫£i b·∫£ng x·∫øp h·∫°ng:', error);
               } finally {
                   setLoadingLeaderboard(false);
               }
           };

            // ‚≠ê LOAD LOGS 24H QUA & X√ìA C≈®
            // ‚≠ê LOAD LOGS FIX (CLIENT FILTER, NO REVERSE BUG)
            const loadLogs = async () => {
                setLoadingLogs(true);
                try {
                    // 24h ago (client time)
                    const now = new Date();
                    const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);

                    console.log('üîç Loading logs... 24h cutoff:', yesterday.toISOString());

                    // Query T·∫§T C·∫¢ g·∫ßn nh·∫•t (an to√†n, ko miss timestamp null)
                    const snapshot = await db.collection('logs')
                        .orderBy('timestamp', 'desc')
                        .limit(500)
                        .get();

                    console.log('üìä T·∫£i ƒë∆∞·ª£c', snapshot.size, 'docs t·ª´ Firestore');

                    // Client-side: Filter 24h & collect old refs to delete
                    const logs24h = [];
                    const oldRefs = [];

                    snapshot.docs.forEach((doc) => {
                        const data = doc.data();
                        const ts = data.timestamp?.toDate();
                        console.log('üìÑ Doc ID:', doc.id, '| TS:', ts ? ts.toISOString() : 'NULL', '| Action:', data.action); // DEBUG M·ªñI DOC
                        if (ts && ts > yesterday) {
                            logs24h.push({ id: doc.id, ...data });
                        } else if (ts) {  // Ch·ªâ x√≥a n·∫øu c√≥ TS (b·ªè qua null ƒë·ªÉ retry sau)
                            oldRefs.push(doc.ref);
                        } else {
                            console.warn('‚ö†Ô∏è Doc no timestamp:', doc.id); // DEBUG NULL TS
                        }
                    });

                    console.log('‚úÖ 24h logs:', logs24h.length, '| Old to delete:', oldRefs.length);

                    // X√ìA C≈® (batch)
                    if (oldRefs.length > 0) {
                        const batch = db.batch();
                        oldRefs.forEach(ref => batch.delete(ref));
                        await batch.commit();
                        console.log(`üóëÔ∏è X√≥a ${oldRefs.length} logs c≈©`);
                    }

                    // GI·ªÆ ORDER DESC (m·ªõi nh·∫•t ƒê·∫¶U, KH√îNG .reverse()!)
                    setLogsData(logs24h);
                } catch (error) {
                    console.error('‚ùå L·ªói load logs:', error);
                    setLogsData([]);
                } finally {
                    setLoadingLogs(false);
                }
            };
            
            const handleRegister = async () => {
                if (!email.trim() || !email.includes('@')) {
                    alert('Vui l√≤ng nh·∫≠p email h·ª£p l·ªá!');
                    return;
                }
                if (!password || password.length < 6) {
                    alert('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!');
                    return;
                }
                if (password !== confirmPassword) {
                    alert('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!');
                    return;
                }

                setLoading(true);
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
        
                    // ‚≠ê ROLL T·ªòC ƒê·∫¶U TI√äN & SET ROLL COUNT
                    const initialTribe = rollTribe();

                    await db.collection('users').doc(user.uid).set({
                        email: user.email,
                        money: 0,
                        fishingRod: 'normal',
                        ownedRods: ['normal'],
                        currentBait: 'normal',
                        ownedBaits: ['normal'],
                        banned: false,
                        tribe: initialTribe,
                        rollCount: 3,  // 3 l·∫ßn mi·ªÖn ph√≠
                        purchasedRollPacks: { single: 0, five: 0, ten: 0 },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    alert('ƒêƒÉng k√Ω th√†nh c√¥ng!');
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        alert('Email n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!');
                    } else {
                        alert('L·ªói ƒëƒÉng k√Ω: ' + error.message);
                    }
                } finally {
                    setLoading(false);
                }
            };

            // Login v·ªõi email/password
            const login = async (e) => {
                e.preventDefault();
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    alert('L·ªói ƒëƒÉng nh·∫≠p: ' + error.message);
                }
            };

            // ƒêƒÉng nh·∫≠p ·∫©n danh
            const loginAnonymous = async () => {
                const confirmAnonymous = confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: ƒêƒÉng nh·∫≠p ·∫©n danh s·∫Ω kh√¥ng l∆∞u d·ªØ li·ªáu vƒ©nh vi·ªÖn!\n\nM·ªçi ti·∫øn ƒë·ªô (ti·ªÅn, c√°, c·∫ßn c√¢u, item...) s·∫Ω b·ªã m·∫•t khi b·∫°n tho√°t.\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?');
                if (!confirmAnonymous) return;
                
                try {
                    const result = await auth.signInAnonymously();
                    setIsAnonymous(true);
                    setCurrentUser('·∫®n danh');
                    
                    // Kh·ªüi t·∫°o data m·∫∑c ƒë·ªãnh cho user ·∫©n danh
                    await db.collection('users').doc(result.user.uid).set({
                        email: 'anonymous',
                        money: 1000, // Cho 1000 xu ban ƒë·∫ßu
                        fishingRod: 'normal',
                        ownedRods: ['normal'],
                        currentBait: 'normal',
                        ownedBaits: ['normal'],
                        tribe: 'nguoi',
                        rollCount: 3,
                        purchasedRollPacks: { single: 0, five: 0, ten: 0 },
                        fishingOnlySecret: false,
                        banned: false,
                        isAnonymous: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    alert('L·ªói ƒëƒÉng nh·∫≠p ·∫©n danh: ' + error.message);
                }
            };

            // ƒêƒÉng nh·∫≠p b·∫±ng Google
            const loginWithGoogle = async () => {
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    // Quay l·∫°i d√πng popup nh∆∞ng v·ªõi x·ª≠ l√Ω t·ªët h∆°n
                    const result = await auth.signInWithPopup(provider);
                    console.log('Google popup result:', result);
                    setIsAnonymous(false);
                    
                    // Ki·ªÉm tra xem user ƒë√£ t·ªìn t·∫°i ch∆∞a
                    const userDoc = await db.collection('users').doc(result.user.uid).get();
                    if (!userDoc.exists) {
                        console.log('Creating new Google user...');
                        // T·∫°o user m·ªõi v·ªõi data m·∫∑c ƒë·ªãnh
                        await db.collection('users').doc(result.user.uid).set({
                            email: result.user.email,
                            money: 1000,
                            fishingRod: 'normal',
                            ownedRods: ['normal'],
                            currentBait: 'normal',
                            ownedBaits: ['normal'],
                            tribe: 'nguoi',
                            rollCount: 3,
                            purchasedRollPacks: { single: 0, five: 0, ten: 0 },
                            fishingOnlySecret: false,
                            banned: false,
                            isAnonymous: false,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log('New Google user created');
                    } else {
                        console.log('Google user already exists');
                    }
                } catch (error) {
                    console.error('Google login error:', error);
                    if (error.code !== 'auth/popup-closed-by-user') {
                        alert('L·ªói ƒëƒÉng nh·∫≠p Google: ' + error.message);
                    }
                }
            };

            const handleLogin = async () => {
                if (!email.trim() || !password) {
                    alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                    return;
                }

                setLoading(true);
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    if (error.code === 'auth/user-not-found') {
                        alert('T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i!');
                    } else if (error.code === 'auth/wrong-password') {
                        alert('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
                    } else {
                        alert('L·ªói ƒëƒÉng nh·∫≠p: ' + error.message);
                    }
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                if (window.confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                    if (!isAnonymous) {
                        await saveGameData();
                    }
                    await auth.signOut();
                    setUserId(null);
                    setCurrentUser(null);
                    setMoney(0);
                    setInventory([]);
                    setEmail('');
                    setPassword('');
                    setConfirmPassword('');
                    setLoginMode('login');
                    setIsAnonymous(false);
                    setGameState('login');
                }
            };

            const getRandomRarity = () => {
                if (fishingOnlySecret) {
                    return rarities.find(r => r.name === 'Secret');
                }
                let availableRarities = [...rarities];
                
                if (fishingRod === 'normal') {
                    availableRarities = rarities.filter(r => 
                        !['Legendary', 'Mythic', 'Secret'].includes(r.name)
                    );
                } else if (fishingRod === 'legendary') {
                    availableRarities = rarities.filter(r => 
                        !['Mythic', 'Secret'].includes(r.name)
                    );
                } else if (fishingRod === 'mythic') {
                    availableRarities = rarities.filter(r => 
                        r.name !== 'Secret'
                    );
                }
                
                const totalWeight = availableRarities.reduce((sum, r) => sum + r.weight, 0);
                let random = Math.random() * totalWeight;
                
                for (let rarity of availableRarities) {
                    random -= rarity.weight;
                    if (random <= 0) return rarity;
                }
                return availableRarities[0];
            };

            const calculateWeight = () => {
                let weight = 1.0;
                let increaseChance = 1.0;
                
                while (Math.random() < increaseChance) {
                    weight += 0.1;
                    increaseChance -= 0.001;
                }
                
                return Math.round(weight * 10) / 10;
            };

            const generateMath = (range, rarity) => {
                const difficultyReduction = baitInfo[currentBait].difficulty[rarity] || 0;
                const tribeData = tribes[tribe] || tribes['nguoi'];
                const tribeDiffReduce = tribeData.diffReduce;
                const adjustedRange = Math.max(5, Math.round(range * (1 - (difficultyReduction + tribeDiffReduce) / 100)));
                
                const operations = ['+', '-'];
                const op = operations[Math.floor(Math.random() * operations.length)];
                const num1 = Math.floor(Math.random() * adjustedRange) + 1;
                const num2 = Math.floor(Math.random() * adjustedRange) + 1;
                
                const question = `${num1} ${op} ${num2}`;
                const correctAnswer = op === '+' ? num1 + num2 : num1 - num2;
                
                return { question, correctAnswer };
            };

            const startFishing = () => {
                setGameState('fishing');
                setMessage('');
                
                setTimeout(() => {
                    const rarity = getRandomRarity();
                    const fishName = fishNames[rarity.name][Math.floor(Math.random() * fishNames[rarity.name].length)];
                    const weight = calculateWeight();
                    const math = generateMath(rarity.range, rarity.name);
                    const basePrice = Math.round(rarity.price * weight);
                    
                    setCurrentFish({
                        rarity: rarity.name,
                        name: fishName,
                        weight: weight,
                        color: rarity.color,
                        math: math,
                        time: rarity.time,
                        basePrice: basePrice,
                        favourite: false
                    });
                    
                    const tribeData = tribes[tribe] || tribes['nguoi'];
                    const baseTime = rarity.time * (1 + tribeData.timeBonus / 100);
                    setTimeLeft(Math.ceil(baseTime));  // L√†m tr√≤n l√™n (1.9 ‚Üí 2, 2.5 ‚Üí 3)
                    setGameState('question');
                }, 1500);
            };

            useEffect(() => {
                if (gameState === 'question' && timeLeft > 0 && !isTaiChiActive) {
                    const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
                    return () => clearTimeout(timer);
                } else if (gameState === 'question' && timeLeft === 0 && !isTaiChiActive) {
                    handleTimeout();
                }
            }, [timeLeft, gameState, isTaiChiActive]);

            const handleTimeout = () => {
                setMessage('H·ª•t m·∫•t r·ªìi!');
                setGameState('result');
                setTimeout(() => {
                    setGameState('menu');
                    setAnswer('');
                }, 2000);
            };

            const checkAnswer = async () => {
                const userAnswer = parseInt(answer);
                if (userAnswer === currentFish.math.correctAnswer) {
                    try {
                        // C·∫≠p nh·∫≠t nhi·ªám v·ª• gi·∫£i to√°n
                        await updateQuestProgress('solve', 1);

                        // C·∫≠p nh·∫≠t nhi·ªám v·ª• c√¢u c√°
                        await updateQuestProgress('catch', 1, currentFish.rarity);

                        const mutationRoll = Math.random();
                        const hasMutation = mutationRoll < 0.5;
                        const mutation = hasMutation ? (currentWeather?.mutation || null) : null;
                        const multiplier = hasMutation ? (currentWeather?.multiplier || 1) : 1;
                        const finalPrice = Math.round((currentFish.basePrice || 0) * multiplier);
                        const weatherKey = currentWeather?.key || 'clear';

                        // Th√™m c√° v√†o Firestore
                        const docRef = await db.collection('users').doc(userId).collection('inventory').add({
                            name: currentFish.name,
                            rarity: currentFish.rarity,
                            weight: currentFish.weight,
                            price: finalPrice,
                            mutation: mutation,
                            weather: weatherKey,
                            multiplier: multiplier,
                            color: currentFish.color,
                            favourite: false,
                            caughtAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        // Th√™m c√° v√†o state inventory (kh√¥ng x√≥a c√° c≈©)
                        setInventory(prevInventory => [
                            ...prevInventory,
                            {
                                id: docRef.id,
                                name: currentFish.name,
                                rarity: currentFish.rarity,
                                weight: currentFish.weight,
                                price: finalPrice,
                                mutation: mutation,
                                weather: weatherKey,
                                multiplier: multiplier,
                                color: currentFish.color,
                                favourite: false
                            }
                        ]);
                        // ‚≠ê TH√äM LOG C√ÇU C√Å (v·ªõi AWAIT & DEBUG)
                        console.log('üî• B·∫Øt ƒë·∫ßu l∆∞u log catch_fish...'); // DEBUG
                        await saveLog('catch_fish', {
                            name: currentFish.name,
                            rarity: currentFish.rarity,
                            weight: currentFish.weight,
                            price: finalPrice,
                            mutation: mutation,
                            weather: weatherKey,
                            multiplier: multiplier
                        });
                        console.log('‚úÖ Log catch_fish l∆∞u th√†nh c√¥ng!'); // DEBUG

                        setMessage(`Ch√∫c m·ª´ng! B·∫°n ƒë√£ c√¢u ƒë∆∞·ª£c ${currentFish.name} n·∫∑ng ${currentFish.weight}kg (${currentFish.rarity}) | mutation c√° n√†y l√†: ${mutation ? mutation : 'Kh√¥ng c√≥'}`);

                        setGameState('result');
                        setTimeout(() => {
                            setGameState('menu');
                            setAnswer('');
                        }, 3000);
                    } catch (error) {
                        console.error('‚ùå L·ªói to√†n b·ªô checkAnswer:', error); // DEBUG TH√äM
                        alert('L·ªói khi l∆∞u c√°: ' + error.message);
                    }
                } else {
                    setMessage('H·ª•t m·∫•t r·ªìi!');
                    setGameState('result');
                    setTimeout(() => {
                        setGameState('menu');
                        setAnswer('');
                    }, 2000);
                }
            };

            const toggleFavourite = async (fishId, currentFavourite) => {
                try {
                    await db.collection('users').doc(userId).collection('inventory').doc(fishId).update({
                        favourite: !currentFavourite
                    });

                    const newInventory = inventory.map(fish => 
                        fish.id === fishId ? { ...fish, favourite: !currentFavourite } : fish
                    );
                    setInventory(newInventory);
                } catch (error) {
                    alert('L·ªói khi c·∫≠p nh·∫≠t: ' + error.message);
                }
            };

            const useItem = async (itemId) => {
                try {
                    const item = items.find(i => i.id === itemId);
                    if (!item) return;

                    const itemDef = itemDefs[item.key];
                    if (!itemDef) return;

                    // X√≥a item kh·ªèi inventory
                    await db.collection('users').doc(userId).collection('items').doc(itemId).delete();
                    setItems(items.filter(i => i.id !== itemId));

                    // N·∫øu l√† B√°t Qu√°i Khai M·ªü, k√≠ch ho·∫°t Th√°i C·ª±c Quy·ªÅn Ph√°p
                    if (item.key === 'bat_quai_khai_mo') {
                        setHasTaiChiPower(true);
                        // L∆∞u flag ƒë√£ t·ª´ng s·ª≠ d·ª•ng Th√°i C·ª±c
                        try {
                            await db.collection('users').doc(userId).update({
                                hasUsedTaiChi: true
                            });
                        } catch (error) {
                            console.warn('Kh√¥ng th·ªÉ l∆∞u hasUsedTaiChi:', error);
                        }
                        alert('Th√°i C·ª±c Quy·ªÅn Ph√°p ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t! N√∫t s·∫Ω xu·∫•t hi·ªán khi c√¢u c√°.');
                    }
                } catch (error) {
                    alert('L·ªói khi s·ª≠ d·ª•ng item: ' + error.message);
                }
            };

            const activateTaiChiPower = async () => {
                setIsTaiChiActive(true);
                setHasTaiChiPower(false);
                
                // D·ª´ng timer c√¢u h·ªèi
                setTimeLeft(0);
                
                // M√†n ƒëen 3s
                setShowTaiChiCutscene(true);
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // H·ªèi xem c√≥ mu·ªën xem cutscene kh√¥ng
                const wantCutscene = confirm('B·∫°n c√≥ mu·ªën xem cutscene kh√¥ng?');
                
                if (wantCutscene) {
                    // Ph√°t video cutscene.mp4
                    const video = document.createElement('video');
                    video.src = 'cutscene.mp4';
                    video.style.position = 'fixed';
                    video.style.top = '0';
                    video.style.left = '0';
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.zIndex = '9999';
                    video.style.objectFit = 'cover';
                    video.autoplay = true;
                    document.body.appendChild(video);
                    
                    await new Promise(resolve => {
                        video.onended = resolve;
                    });
                    
                    document.body.removeChild(video);
                }
                
                // Hi·ªán UI state question v·ªõi glitch effect v√† thay ƒë·ªïi gi√° tr·ªã li√™n t·ª•c
                // Gi·ªØ showTaiChiCutscene=true, ch·ªâ thay ƒë·ªïi background opacity
                setShowTaiChiImage(true);
                setTaiChiKey(prev => prev + 1); // Force re-render
                
                // B·∫Øt ƒë·∫ßu thay ƒë·ªïi gi√° tr·ªã li√™n t·ª•c
                const glitchInterval = setInterval(() => {
                    // Ch·ªçn c√° ng·∫´u nhi√™n t·ª´ danh s√°ch
                    const randomRarity = rarities[Math.floor(Math.random() * (rarities.length - 1))];
                    const fishNamesForRarity = fishNames[randomRarity.name];
                    const randomFishName = fishNamesForRarity[Math.floor(Math.random() * fishNamesForRarity.length)];
                    const randomWeight = (Math.random() * 10 + 1).toFixed(2);
                    
                    // T·∫°o c√¢u h·ªèi to√°n ng·∫´u nhi√™n
                    const randomMath = generateMath(randomRarity.range, randomRarity.name);
                    
                    // C·∫≠p nh·∫≠t currentFish v·ªõi gi√° tr·ªã ng·∫´u nhi√™n
                    setCurrentFish(prev => ({
                        ...prev,
                        name: randomFishName,
                        rarity: randomRarity.name,
                        weight: parseFloat(randomWeight),
                        color: randomRarity.color,
                        math: randomMath
                    }));
                }, 100); // Thay ƒë·ªïi m·ªói 100ms
                
                // Xoay thaicuc.png 4s v·ªõi hi·ªáu ·ª©ng glitch
                await new Promise(resolve => setTimeout(resolve, 4000));
                
                // D·ª´ng thay ƒë·ªïi gi√° tr·ªã
                clearInterval(glitchInterval);
                
                // M√†n ƒëen 3s
                setShowTaiChiImage(false);
                setShowTaiChiCutscene(true);
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // V·ªÅ menu v√† nh·∫≠n c√°
                setShowTaiChiCutscene(false);
                setIsTaiChiActive(false);
                
                // T·∫°o c√° ng·∫´u nhi√™n v√† th√™m v√†o inventory
                const finalRarity = rarities[Math.floor(Math.random() * (rarities.length - 1))]; // Lo·∫°i tr·ª´ Special(admin)
                const finalFishNamesForRarity = fishNames[finalRarity.name];
                const finalFishName = finalFishNamesForRarity[Math.floor(Math.random() * finalFishNamesForRarity.length)];
                
                const newFish = {
                    id: Date.now().toString(),
                    name: finalFishName,
                    rarity: finalRarity.name,
                    price: finalRarity.price,
                    caughtAt: firebase.firestore.FieldValue.serverTimestamp(),
                    favourite: false
                };
                
                await db.collection('users').doc(userId).collection('inventory').doc(newFish.id).set(newFish);
                setInventory([...inventory, newFish]);
                
                setGameState('menu');
                alert('C√¢u c√° th√†nh c√¥ng! (H·ªìi chi√™u 1 ph√∫t)');
                
                // L∆∞u cooldown v√†o Firestore v√† set state
                const cooldownUntil = Date.now() + 60000; // 1 ph√∫t
                try {
                    await db.collection('users').doc(userId).update({ 
                        taiChiCooldownUntil: cooldownUntil 
                    });
                    setTaiChiCooldownUntil(cooldownUntil);
                    setHasTaiChiPower(false);
                } catch (error) {
                    console.warn('Kh√¥ng th·ªÉ l∆∞u cooldown:', error);
                    // V·∫´n set state local ƒë·ªÉ client bi·∫øt ƒëang cooldown
                    setTaiChiCooldownUntil(cooldownUntil);
                    setHasTaiChiPower(false);
                    // Th·ª≠ l·∫°i l∆∞u sau 5 gi√¢y
                    setTimeout(async () => {
                        try {
                            await db.collection('users').doc(userId).update({ 
                                taiChiCooldownUntil: cooldownUntil 
                            });
                        } catch (retryError) {
                            console.warn('V·∫´n kh√¥ng th·ªÉ l∆∞u cooldown sau khi retry:', retryError);
                        }
                    }, 5000);
                }
            };

            const sellFish = async () => {
                const fishToSell = inventory.filter(fish => !fish.favourite);
                const totalMoney = fishToSell.reduce((sum, fish) => sum + fish.price, 0);
                const newMoney = money + totalMoney;
                if (newMoney > MAX_MONEY) {
                    alert(`B·∫°n ƒë√£ ƒë·∫°t m·ª©c ti·ªÅn t·ªëi ƒëa (${formatMoney(MAX_MONEY)}). Kh√¥ng th·ªÉ b√°n th√™m c√°!`);
                    return;
                }
    
                try {
                    const batch = db.batch();
                    fishToSell.forEach(fish => {
                        const fishRef = db.collection('users').doc(userId).collection('inventory').doc(fish.id);
                        batch.delete(fishRef);
                    });
                    await batch.commit();

                    updateMoneyWithAnimation(newMoney, totalMoney);
                    await db.collection('users').doc(userId).update({ money: newMoney });
                    // ‚≠ê TH√äM LOG B√ÅN C√Å
                    console.log('üî• B·∫Øt ƒë·∫ßu l∆∞u log sell_fish...');
                    saveLog('sell_fish', { count: fishToSell.length, total: totalMoney }, totalMoney);
                    console.log('‚úÖ Log sell_fish l∆∞u th√†nh c√¥ng!');
        
                    // C·∫≠p nh·∫≠t nhi·ªám v·ª• ki·∫øm ti·ªÅn
                    await updateQuestProgress('earn', totalMoney);

                    setInventory(inventory.filter(fish => fish.favourite));
                    setShowSellConfirm(false);
        
                    if (fishToSell.length > 0) {
                        setMessage(`ƒê√£ b√°n ${fishToSell.length} con c√° v√† nh·∫≠n ƒë∆∞·ª£c ${totalMoney} xu!`);
                        setTimeout(() => setMessage(''), 3000);
                    }
                } catch (error) {
                    alert('L·ªói khi b√°n c√°: ' + error.message);
                }
            };

            const deleteAccount = async () => {
                if (!window.confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n vƒ©nh vi·ªÖn? T·∫•t c·∫£ d·ªØ li·ªáu s·∫Ω m·∫•t!')) return;
    
                // Prompt password ƒë·ªÉ re-auth
                const password = window.prompt('Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ x√°c th·ª±c v√† x√≥a t√†i kho·∫£n:');
                if (!password) {
                    alert('H·ªßy x√≥a!');
                    return;
                }
    
                try {
                    // Re-authenticate
                    const credential = firebase.auth.EmailAuthProvider.credential(currentUser, password);
                    await auth.currentUser.reauthenticateWithCredential(credential);
        
                    // B√¢y gi·ªù delete an to√†n
                    // X√≥a subcollections tr∆∞·ªõc (inventory v√† quests)
                    const inventoryRef = db.collection('users').doc(userId).collection('inventory');
                    const questsRef = db.collection('users').doc(userId).collection('quests');
        
                    // X√≥a t·∫•t c·∫£ docs trong inventory
                    const inventoryDocs = await inventoryRef.get();
                    for (const doc of inventoryDocs.docs) {
                        await doc.ref.delete();
                    }
        
                    // X√≥a t·∫•t c·∫£ docs trong quests
                    const questsDocs = await questsRef.get();
                    for (const doc of questsDocs.docs) {
                        await doc.ref.delete();
                    }
        
                    // X√≥a user doc ch√≠nh
                    await db.collection('users').doc(userId).delete();
        
                    // X√≥a Firebase Auth user
                    await auth.currentUser.delete();
        
                    // Sign out v√† quay v·ªÅ login
                    await auth.signOut();
                    setGameState('login');
                    alert('T√†i kho·∫£n ƒë√£ x√≥a vƒ©nh vi·ªÖn!');
                } catch (error) {
                    console.error('Delete error:', error);
                    if (error.code === 'auth/wrong-password') {
                        alert('M·∫≠t kh·∫©u sai! H√£y th·ª≠ l·∫°i.');
                    } else if (error.code === 'auth/requires-recent-login') {
                        alert('Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. H√£y ƒëƒÉng xu·∫•t v√† ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ x√≥a!');
                        await auth.signOut();
                        setGameState('login');
                    } else {
                        alert('L·ªói khi x√≥a: ' + error.message);
                    }
                }
            };
            
            const buyRod = async (item) => {
                const tribeData = tribes[tribe] || tribes['nguoi'];
                const discount = tribeData.shopDiscount / 100;
                const effectivePrice = Math.round(item.price * (1 - discount));

                if (money < effectivePrice) {
                    alert('B·∫°n kh√¥ng ƒë·ªß ti·ªÅn ƒë·ªÉ mua c·∫ßn c√¢u n√†y!');
                    return;
                }

                if (ownedRods.includes(item.unlocks)) {
                    alert('B·∫°n ƒë√£ c√≥ c·∫ßn c√¢u n√†y r·ªìi!');
                    return;
                }

                const newMoney = money - effectivePrice;
                const newOwnedRods = [...ownedRods, item.unlocks];

                updateMoneyWithAnimation(newMoney, -effectivePrice);
                setOwnedRods(newOwnedRods);
    
                await db.collection('users').doc(userId).update({
                    money: newMoney,
                    ownedRods: newOwnedRods
                });

                // ‚≠ê TH√äM LOG MUA ROD
                saveLog('buy_rod', { rod: item.name, price: effectivePrice }, -effectivePrice);

                setMessage(`‚úÖ ƒê√£ mua ${item.name} th√†nh c√¥ng! V√†o Balo ƒë·ªÉ trang b·ªã.`);
                setTimeout(() => setMessage(''), 3000);
            };

            const buyBait = async (baitType) => {
                const bait = baitInfo[baitType];
                const tribeData = tribes[tribe] || tribes['nguoi'];
                const discount = tribeData.shopDiscount / 100;
                const effectivePrice = Math.round(bait.price * (1 - discount));

                if (money < effectivePrice) {
                    alert('B·∫°n kh√¥ng ƒë·ªß ti·ªÅn ƒë·ªÉ mua m·ªìi n√†y!');
                    return;
                }

                if (ownedBaits.includes(baitType)) {
                    alert('B·∫°n ƒë√£ c√≥ m·ªìi n√†y r·ªìi!');
                    return;
                }

                const newMoney = money - effectivePrice;
                const newOwnedBaits = [...ownedBaits, baitType];

                updateMoneyWithAnimation(newMoney, -effectivePrice);
                setOwnedBaits(newOwnedBaits);
    
                await db.collection('users').doc(userId).update({
                    money: newMoney,
                    ownedBaits: newOwnedBaits
                });

                // ‚≠ê TH√äM LOG MUA M·ªíI
                saveLog('buy_bait', { bait: bait.name, price: effectivePrice }, -effectivePrice);

                setMessage(`‚úÖ ƒê√£ mua ${bait.name} th√†nh c√¥ng! V√†o Balo ƒë·ªÉ trang b·ªã.`);
                setTimeout(() => setMessage(''), 3000);
            };

            // ‚≠ê MUA G√ìI ROLL T·ªòC
            const buyRollPack = async (item) => {
                const tribeData = tribes[tribe] || tribes['nguoi'];
                const discount = tribeData.shopDiscount / 100;
                const effectivePrice = Math.round(item.basePrice * (1 - discount));

                if (money < effectivePrice) {
                    alert('B·∫°n kh√¥ng ƒë·ªß ti·ªÅn ƒë·ªÉ mua g√≥i n√†y!');
                    return;
                }

                if (purchasedRollPacks[item.packType] >= 10) {
                    alert('B·∫°n ƒë√£ mua t·ªëi ƒëa 10 l·∫ßn cho g√≥i n√†y!');
                    return;
                }

                const newMoney = money - effectivePrice;
                const newRollCount = rollCount + item.rolls;
                const newPurchased = { ...purchasedRollPacks, [item.packType]: purchasedRollPacks[item.packType] + 1 };

                updateMoneyWithAnimation(newMoney, -effectivePrice);
                setRollCount(newRollCount);
                setPurchasedRollPacks(newPurchased);

                await db.collection('users').doc(userId).update({
                    money: newMoney,
                    rollCount: newRollCount,
                    purchasedRollPacks: newPurchased
                });

                // ‚≠ê TH√äM LOG MUA ROLL
                saveLog('buy_roll', { pack: item.name, rolls: item.rolls, price: effectivePrice }, -effectivePrice);

                setMessage(`‚úÖ ƒê√£ mua ${item.name} th√†nh c√¥ng! B·∫°n c√≥ th√™m ${item.rolls} l·∫ßn roll.`);
                setTimeout(() => setMessage(''), 3000);
            };

            // ‚≠ê ROLL L·∫†I T·ªòC (D√ôNG ROLL COUNT)
            const performRoll = async () => {
                if (rollCount <= 0) {
                    alert('B·∫°n kh√¥ng c√≤n l·∫ßn roll n√†o! H√£y mua th√™m ·ªü c·ª≠a h√†ng.');
                    return;
                }

                const newTribe = rollTribe();
                const newRollCount = rollCount - 1;

                setTribe(newTribe);
                setRollCount(newRollCount);

                await db.collection('users').doc(userId).update({
                    tribe: newTribe,
                    rollCount: newRollCount
                });

                // ‚≠ê TH√äM LOG ROLL T·ªòC
                saveLog('roll_tribe', { newTribe: tribes[newTribe].name }, 0);

                alert(`üé≤ B·∫°n ƒë√£ roll ƒë∆∞·ª£c t·ªôc m·ªõi: ${tribes[newTribe].name}! C√≤n ${newRollCount} l·∫ßn roll.`);
            };

            const equipRod = async (rodType) => {
                setFishingRod(rodType);
                await db.collection('users').doc(userId).update({ fishingRod: rodType });
                setMessage(`‚úÖ ƒê√£ trang b·ªã ${getRodNameByType(rodType)}!`);
                setTimeout(() => setMessage(''), 2000);
            };

            const equipBait = async (baitType) => {
                setCurrentBait(baitType);
                await db.collection('users').doc(userId).update({ currentBait: baitType });
                setMessage(`‚úÖ ƒê√£ trang b·ªã ${baitInfo[baitType].name}!`);
                setTimeout(() => setMessage(''), 2000);
            };

            const getRodName = () => {
                return getRodNameByType(fishingRod);
            };

            const getRodNameByType = (type) => {
                switch(type) {
                    case 'legendary': return 'New Rank Fish!';
                    case 'mythic': return 'Mythical Fishing Rod';
                    case 'secret': return 'Mysterious Fishing Rod';
                    default: return 'Normal Rod';
                }
            };

            const getRodDescription = (type) => {
                switch(type) {
                    case 'legendary': return 'C√¢u ƒë∆∞·ª£c c√° ƒë·∫øn Legendary';
                    case 'mythic': return 'C√¢u ƒë∆∞·ª£c c√° ƒë·∫øn Mythic';
                    case 'secret': return 'C√¢u ƒë∆∞·ª£c t·∫•t c·∫£ lo·∫°i c√°';
                    default: return 'C·∫ßn c√¢u c∆° b·∫£n';
                }
            };

            const getRodColor = (type) => {
                switch(type) {
                    case 'legendary': return '#22C55E';
                    case 'mythic': return '#EF4444';
                    case 'secret': return '#1F2937';
                    default: return '#9CA3AF';
                }
            };

            // ‚≠ê H√ÄM ROLL T·ªòC NG·∫™U NHI√äN
            const rollTribe = () => {
                const rand = Math.random() * 100;
                let cumulative = 0;
                for (const [key, t] of Object.entries(tribes)) {
                    cumulative += t.probability;
                    if (rand < cumulative) {
                        return key;
                    }
                }
                return 'nguoi'; // Default
            };

            // Admin Panel UI
            if (showAdminPanel) {
                return (
                    <div
                      className="min-h-screen bg-cover bg-center p-8"
                      style={{ backgroundImage: "url('inadmincommand.jpg')" }}
                    >
                        {/* Thay th·∫ø ph·∫ßn hi·ªÉn th·ªã money c≈© */}
                        <div className="fixed top-4 right-4 bg-yellow-400 px-6 py-3 rounded-lg shadow-lg z-50">
                            <p className="text-2xl font-bold text-gray-800">
                                üí∞ {formatMoney(Math.floor(displayMoney))} xu
                            </p>
                            {showMoneyChange && (
                                <div 
                                    className={`absolute -bottom-8 right-0 text-xl font-bold animate-bounce ${
                                        moneyChange > 0 ? 'text-green-500' : 'text-red-500'
                                    }`}
                                    style={{
                                        animation: 'slideUp 2s ease-out forwards'
                                    }}
                                >
                                    {moneyChange > 0 ? '+' : ''}{formatMoney(moneyChange)}
                                </div>
                            )}
                        </div>
                        
                        <div className="max-w-4xl mx-auto">
                            <div className="bg-white rounded-lg shadow-2xl p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <div>
                                        <h2 className="text-3xl font-bold text-gray-800">‚öôÔ∏è Admin Command Panel</h2>
                                        <p className="text-sm text-gray-600 mt-1">Quy·ªÅn Admin: {currentUser}</p>
                                    </div>
                                    <button
                                        onClick={() => setShowAdminPanel(false)}
                                        className="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"
                                    >
                                        Quay l·∫°i
                                    </button>
                                </div>

                                <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                                    <h3 className="font-bold mb-2">üìã Danh s√°ch l·ªánh:</h3>
                                    <div className="text-sm text-gray-700 space-y-1">
                                        <p><code className="bg-gray-200 px-2 py-1 rounded">/givefish &lt;t√™n c√°&gt; &lt;email&gt; [mutation1,mutation2,...]</code> - T·∫∑ng c√° cho ng∆∞·ªùi ch∆°i (c√≥ th·ªÉ ch·ªçn mutation)</p>
                                        <p><code className="bg-gray-200 px-2 py-1 rounded">/givemoney &lt;s·ªë xu&gt; &lt;email&gt;</code> - T·∫∑ng xu cho ng∆∞·ªùi ch∆°i</p>
                                        <p><code className="bg-gray-200 px-2 py-1 rounded">/giverod &lt;legendary|mythic|secret&gt; &lt;email&gt;</code> - T·∫∑ng c·∫ßn c√¢u</p>
                                        <p><code className="bg-gray-200 px-2 py-1 rounded">/ban &lt;email&gt;</code> - Ban ng∆∞·ªùi ch∆°i</p>
                                        <p><code className="bg-gray-200 px-2 py-1 rounded">/unban &lt;email&gt;</code> - UNBan ng∆∞·ªùi ch∆°i</p>
                                        <p><code className="bg-gray-200 px-2 py-1 rounded">/setrace &lt;nguoi|ca|nemo|poseidon&gt; &lt;email&gt;</code> - Ch·ªânh T·ªôc c·ªßa ng∆∞·ªùi ch∆°i</p>
                                        <p><code className="bg-gray-200 px-2 py-1 rounded">/setrace &lt;1|2|3...&gt; &lt;email&gt;</code> - Cho ng∆∞·ªùi ch∆°i roll</p>
                                        <p><code className="bg-gray-200 px-2 py-1 rounded">/setrace  &lt;email&gt; &lt;on|off&gt;</code> - Ch·ªânh ng∆∞·ªùi ch∆°i c√¢u ƒë∆∞·ª£c to√†n secret</p>
                                        <p><code className="bg-gray-200 px-2 py-1 rounded">/help</code> - Hi·ªÉn th·ªã tr·ª£ gi√∫p</p>
                                    </div>
                                </div>

                                <div className="mb-4">
                                    <input
                                        type="text"
                                        value={adminCommand}
                                        onChange={(e) => setAdminCommand(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && executeAdminCommand()}
                                        placeholder="Nh·∫≠p l·ªánh... (v√≠ d·ª•: /givefish C√° R·ªìng abc@gmail.com L·∫•p l√°nh,N√≥ng)"
                                        className="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-600"
                                    />
                                </div>

                                <button
                                    onClick={executeAdminCommand}
                                    className="w-full py-3 bg-blue-600 text-white text-lg font-bold rounded-lg hover:bg-blue-700 transition mb-4"
                                >
                                    ‚ñ∂Ô∏è Th·ª±c thi l·ªánh
                                </button>

                                {adminOutput && (
                                    <div className="p-4 bg-gray-900 text-green-400 rounded-lg font-mono text-sm whitespace-pre-wrap">
                                        {adminOutput}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // ‚≠ê PANEL LOGS (CH·ªà ADMIN)
            if (showLogs) {
                return (
                    <div
                      className="min-h-screen bg-cover bg-center p-8"
                      style={{ backgroundImage: "url('inlogs.jpg')" }}
                    >
                        {/* Money bar gi·ªëng admin panel */}
                        <div className="fixed top-4 right-4 bg-yellow-400 px-6 py-3 rounded-lg shadow-lg z-50">
                            <p className="text-2xl font-bold text-gray-800">
                                üí∞ {formatMoney(Math.floor(displayMoney))} xu
                            </p>
                            {showMoneyChange && (
                                <div 
                                    className={`absolute -bottom-8 right-0 text-xl font-bold animate-bounce ${
                                        moneyChange > 0 ? 'text-green-500' : 'text-red-500'
                                    }`}
                                    style={{ animation: 'slideUp 2s ease-out forwards' }}
                                >
                                    {moneyChange > 0 ? '+' : ''}{formatMoney(moneyChange)}
                                </div>
                            )}
                        </div>
            
                        <div className="max-w-6xl mx-auto">
                            <div className="bg-white rounded-lg shadow-2xl p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <div>
                                        <h2 className="text-3xl font-bold text-gray-800">üìã Activity Logs (24h qua)</h2>
                                        <p className="text-sm text-gray-600 mt-1">T·ª± ƒë·ªông x√≥a logs c≈© h∆°n 24h</p>
                                    </div>
                                    <div className="space-x-2">
                                        <button
                                            onClick={loadLogs}
                                            disabled={loadingLogs}
                                            className="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:bg-gray-400 transition"
                                        >
                                            {loadingLogs ? '‚è≥' : 'üîÑ'} Refresh
                                        </button>
                                        <button
                                            onClick={() => setShowLogs(false)}
                                            className="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"
                                        >
                                            Quay l·∫°i
                                        </button>
                                    </div>
                                </div>

                                {loadingLogs ? (
                                    <div className="flex justify-center py-12">
                                        <div className="text-xl text-gray-500">‚è≥ ƒêang t·∫£i logs...</div>
                                    </div>
                                ) : logsData.length === 0 ? (
                                    <div className="text-center py-12 text-gray-500 text-xl">
                                        üì≠ Ch∆∞a c√≥ ho·∫°t ƒë·ªông trong 24h qua
                                    </div>
                                ) : (
                                    <div className="mb-4 text-center text-lg font-bold text-blue-600">
                                        üìà T·ªïng {logsData.length} ho·∫°t ƒë·ªông (24h qua)
                                    </div>,
                                    <div className="space-y-3 max-h-[70vh] overflow-y-auto p-4 bg-gray-50 rounded-xl">
                                        {logsData.map((log) => (
                                            <div key={log.id} className="p-4 bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition">
                                                <div className="flex justify-between items-start mb-2">
                                                    <strong className="text-lg text-gray-800">{log.userEmail}</strong>
                                                    <span className="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded">
                                                        {log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString('vi-VN') : 'N/A'}
                                                    </span>
                                                </div>
                                                <p className="text-gray-700 font-medium">{formatLogMessage(log)}</p>
                                                {log.amount !== 0 && log.amount !== undefined && (
                                                    <span className={`ml-2 px-3 py-1 rounded-full text-sm font-bold ${
                                                        log.amount > 0 
                                                            ? 'bg-green-100 text-green-800' 
                                                            : 'bg-red-100 text-red-800'
                                                    }`}>
                                                        {log.amount > 0 ? `+${formatMoney(Math.abs(log.amount))}` : `-${formatMoney(Math.abs(log.amount))}`} xu
                                                    </span>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            if (showRollPanel) {
                const tribeData = tribes[tribe] || tribes['nguoi'];
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-900 to-blue-700 p-8">
                        <div className="max-w-md mx-auto bg-white rounded-lg shadow-2xl p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-3xl font-bold text-gray-800">üé≤ Roll T·ªôc</h2>
                                <button
                                    onClick={() => setShowRollPanel(false)}
                                    className="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"
                                >
                                    Quay l·∫°i
                                </button>
                            </div>

                            <div className="p-4 bg-blue-50 rounded-lg mb-6">
                                <h3 className="text-2xl font-bold mb-2">T·ªôc hi·ªán t·∫°i: {tribeData.name}</h3>
                                <ul className="list-disc pl-6 text-gray-700">
                                    <li>TƒÉng th·ªùi gian c√¢u: +{tribeData.timeBonus}%</li>
                                    <li>Gi·∫£m ƒë·ªô kh√≥: -{tribeData.diffReduce}%</li>
                                    <li>Gi·∫£m gi√° shop: -{tribeData.shopDiscount}%</li>
                                </ul>
                            </div>

                            <p className="text-center text-xl mb-4">B·∫°n c√≤n {rollCount} l·∫ßn roll mi·ªÖn ph√≠/mua.</p>

                            <button
                                onClick={performRoll}
                                disabled={rollCount <= 0}
                                className="w-full py-4 bg-green-600 text-white text-2xl font-bold rounded-lg hover:bg-green-700 transition disabled:bg-gray-400"
                            >
                                Roll Ngay!
                            </button>

                            <p className="text-center text-sm text-gray-500 mt-4">Mua th√™m l·∫ßn roll ·ªü C·ª≠a H√†ng n·∫øu h·∫øt.</p>
                        </div>
                    </div>
                );
            }

            if (configError) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-red-600 to-red-800">
                        <div className="bg-white rounded-xl shadow-2xl p-12 max-w-2xl w-full mx-4">
                            <h1 className="text-4xl font-bold text-center mb-6 text-red-600">‚ö†Ô∏è C·∫•u h√¨nh Firebase</h1>
                            <div className="bg-red-50 border-2 border-red-300 rounded-lg p-6 mb-6">
                                <p className="text-lg text-red-800 mb-4">
                                    B·∫°n c·∫ßn c·∫•u h√¨nh Firebase tr∆∞·ªõc khi s·ª≠ d·ª•ng game!
                                </p>
                                <ol className="text-sm text-red-700 space-y-2 ml-4">
                                    <li><strong>1.</strong> Truy c·∫≠p <a href="https://console.firebase.google.com" target="_blank" className="text-blue-600 underline">Firebase Console</a></li>
                                    <li><strong>2.</strong> T·∫°o project m·ªõi ho·∫∑c ch·ªçn project c√≥ s·∫µn</li>
                                    <li><strong>3.</strong> V√†o <strong>Project Settings</strong> ‚Üí <strong>Your apps</strong> ‚Üí Ch·ªçn Web app</li>
                                    <li><strong>4.</strong> Copy Firebase config v√† thay th·∫ø v√†o code</li>
                                    <li><strong>5.</strong> B·∫≠t <strong>Authentication</strong> (Email/Password)</li>
                                    <li><strong>6.</strong> B·∫≠t <strong>Firestore Database</strong></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                );
            }

            // Admin Panel UI
            if (showAdminPanel) {
                return (
                    <div
                      className="min-h-screen bg-cover bg-center p-8"
                      style={{ backgroundImage: "url('inadmincommand.jpg')" }}
                    >
                        {/* Thay th·∫ø ph·∫ßn hi·ªÉn th·ªã money c≈© */}
                        <div className="fixed top-4 right-4 bg-yellow-400 px-6 py-3 rounded-lg shadow-lg z-50">
                            <p className="text-2xl font-bold text-gray-800">
                                üí∞ {formatMoney(Math.floor(displayMoney))} xu
                            </p>
                            {showMoneyChange && (
                                <div 
                                    className={`absolute -bottom-8 right-0 text-xl font-bold animate-bounce ${
                                        moneyChange > 0 ? 'text-green-500' : 'text-red-500'
                                    }`}
                                    style={{
                                        animation: 'slideUp 2s ease-out forwards'
                                    }}
                                >
                                    {moneyChange > 0 ? '+' : ''}{formatMoney(moneyChange)}
                                </div>
                            )}
                        </div>
            
                        <div className="max-w-4xl mx-auto">
                            <div className="bg-white rounded-lg shadow-2xl p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <div>
                                        <h2 className="text-3xl font-bold text-gray-800">‚öôÔ∏è Admin Command Panel</h2>
                                        <p className="text-sm text-gray-600 mt-1">Quy·ªÅn Admin: {currentUser}</p>
                                    </div>
                                    <button
                                        onClick={() => setShowAdminPanel(false)}
                                        className="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"
                                    >
                                        Quay l·∫°i
                                    </button>
                                </div>

                                <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                                    <h3 className="font-bold mb-2">üìã Danh s√°ch l·ªánh:</h3>
                                    <div className="text-sm text-gray-700 space-y-1">
                                        <p><code className="bg-gray-200 px-2 py-1 rounded">/givefish &lt;t√™n c√°&gt; &lt;email&gt; [mutation1,mutation2,...]</code> - T·∫∑ng c√° cho ng∆∞·ªùi ch∆°i (c√≥ th·ªÉ ch·ªçn mutation)</p>
                                        <p><code className="bg-gray-200 px-2 py-1 rounded">/givemoney &lt;s·ªë xu&gt; &lt;email&gt;</code> - T·∫∑ng xu cho ng∆∞·ªùi ch∆°i</p>
                                        <p><code className="bg-gray-200 px-2 py-1 rounded">/giverod &lt;legendary|mythic|secret&gt; &lt;email&gt;</code> - T·∫∑ng c·∫ßn c√¢u</p>
                                        <p><code className="bg-gray-200 px-2 py-1 rounded">/help</code> - Hi·ªÉn th·ªã tr·ª£ gi√∫p</p>
                                    </div>
                                </div>

                                <div className="mb-4">
                                    <input
                                        type="text"
                                        value={adminCommand}
                                        onChange={(e) => setAdminCommand(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && executeAdminCommand()}
                                        placeholder="Nh·∫≠p l·ªánh... (v√≠ d·ª•: /givefish C√° R·ªìng test@gmail.com L·∫•p l√°nh,N√≥ng)"
                                        className="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-600"
                                    />
                                </div>

                                <button
                                    onClick={executeAdminCommand}
                                    className="w-full py-3 bg-blue-600 text-white text-lg font-bold rounded-lg hover:bg-blue-700 transition mb-4"
                                >
                                    ‚ñ∂Ô∏è Th·ª±c thi l·ªánh
                                </button>

                                {adminOutput && (
                                    <div className="p-4 bg-gray-900 text-green-400 rounded-lg font-mono text-sm whitespace-pre-wrap">
                                        {adminOutput}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'banned') {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-red-900">
                        <div className="bg-white rounded-lg p-12 shadow-2xl text-center">
                            <h2 className="text-4xl font-bold text-red-600 mb-4">T√†i kho·∫£n b·ªã c·∫•m!</h2>
                            <p className="text-xl text-gray-800 mb-8">B·∫°n ƒë√£ b·ªã ban kh·ªèi game.</p>
                            <button
                                onClick={deleteAccount}
                                className="px-8 py-3 bg-red-600 text-white text-xl rounded-lg hover:bg-red-700 transition"
                            >
                                X√≥a t√†i kho·∫£n vƒ©nh vi·ªÖn
                            </button>
                        </div>
                    </div>
                );
            }

            if (gameState === 'login') {
                return (
                    <div
                      className="min-h-screen flex items-center justify-center bg-cover bg-center p-8"
                      style={{ backgroundImage: "url('background.jpg')" }}
                    >
                        <div className="bg-white rounded-xl shadow-2xl p-12 max-w-md w-full mx-4">
                            <h1 className="text-4xl font-bold text-center mb-8 text-gray-800">üé£ Fishing With The Math</h1>
                            <p className="text-center text-sm text-green-600 font-semibold mb-4">‚úÖ S·ª≠ d·ª•ng Firebase</p>
                            
                            {loading ? (
                                <div className="text-center text-gray-600 text-lg py-8">ƒêang x·ª≠ l√Ω...</div>
                            ) : (
                                <>
                                    <div className="flex gap-2 mb-6">
                                        <button
                                            onClick={() => setLoginMode('login')}
                                            className={`flex-1 py-3 rounded-lg font-bold transition ${
                                                loginMode === 'login' 
                                                    ? 'bg-blue-600 text-white' 
                                                    : 'bg-gray-300 text-gray-700'
                                            }`}
                                        >
                                            ƒêƒÉng nh·∫≠p
                                        </button>
                                        <button
                                            onClick={() => setLoginMode('register')}
                                            className={`flex-1 py-3 rounded-lg font-bold transition ${
                                                loginMode === 'register' 
                                                    ? 'bg-blue-600 text-white' 
                                                    : 'bg-gray-300 text-gray-700'
                                            }`}
                                        >
                                            ƒêƒÉng k√Ω
                                        </button>
                                    </div>

                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder="Email"
                                        className="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-purple-600"
                                    />
                                    
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        placeholder="M·∫≠t kh·∫©u"
                                        className="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-purple-600"
                                    />

                                    {loginMode === 'register' && (
                                        <input
                                            type="password"
                                            value={confirmPassword}
                                            onChange={(e) => setConfirmPassword(e.target.value)}
                                            placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u"
                                            className="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-purple-600"
                                        />
                                    )}

                                    <button
                                        onClick={loginMode === 'login' ? handleLogin : handleRegister}
                                        className="w-full py-3 bg-blue-600 text-white text-xl font-bold rounded-lg hover:bg-blue-700 transition mb-4"
                                    >
                                        {loginMode === 'login' ? 'üéÆ ƒêƒÉng nh·∫≠p' : 'üìù ƒêƒÉng k√Ω'}
                                    </button>

                                    <div className="border-t pt-4 mt-6">
                                        <p className="text-center text-gray-600 mb-4 font-semibold">Ho·∫∑c ƒëƒÉng nh·∫≠p b·∫±ng:</p>
                                        
                                        <button
                                            onClick={loginAnonymous}
                                            className="w-full py-3 bg-gray-600 text-white text-lg font-bold rounded-lg hover:bg-gray-700 transition mb-3"
                                        >
                                            ü•∑ ƒêƒÉng nh·∫≠p ·∫©n danh
                                        </button>
                                        
                                        <button
                                            onClick={loginWithGoogle}
                                            className="w-full py-3 bg-red-600 text-white text-lg font-bold rounded-lg hover:bg-red-700 transition"
                                        >
                                            üîó ƒêƒÉng nh·∫≠p b·∫±ng Google
                                        </button>
                                        
                                        {loginMode === 'login' && (
                                            <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                                <p className="text-xs text-yellow-800 text-center">
                                                    ‚ö†Ô∏è <strong>ƒêƒÉng nh·∫≠p ·∫©n danh:</strong> D·ªØ li·ªáu s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u vƒ©nh vi·ªÖn v√† s·∫Ω b·ªã m·∫•t khi tho√°t!
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                );
            }

            if (showInventory) {
                return (
                    <div
                      className="min-h-screen bg-cover bg-center p-8"
                      style={{ backgroundImage: "url('inbackpack.png')" }}
                    >
                        {/* Thay th·∫ø ph·∫ßn hi·ªÉn th·ªã money c≈© */}
                        <div className="fixed top-4 right-4 bg-yellow-400 px-6 py-3 rounded-lg shadow-lg z-50">
                            <p className="text-2xl font-bold text-gray-800">
                                üí∞ {formatMoney(Math.floor(displayMoney))} xu
                            </p>
                            {showMoneyChange && (
                                <div 
                                    className={`absolute -bottom-8 right-0 text-xl font-bold animate-bounce ${
                                        moneyChange > 0 ? 'text-green-500' : 'text-red-500'
                                    }`}
                                    style={{
                                        animation: 'slideUp 2s ease-out forwards'
                                    }}
                                >
                                    {moneyChange > 0 ? '+' : ''}{formatMoney(moneyChange)}
                                </div>
                            )}
                        </div>
                        
                        <div className="max-w-6xl mx-auto">
                            <div className="bg-white rounded-lg shadow-2xl p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-3xl font-bold text-gray-800">üéí Balo</h2>
                                    <button
                                        onClick={() => {
                                            setShowInventory(false);
                                            setInventoryTab('fish');
                                        }}
                                        className="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
                                    >
                                        Quay l·∫°i
                                    </button>
                                </div>

                                <div className="flex gap-2 mb-6">
                                    <button
                                        onClick={() => setInventoryTab('fish')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition ${
                                            inventoryTab === 'fish' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-300 text-gray-700'
                                        }`}
                                    >
                                        üêü C√° ({inventory.length})
                                    </button>
                                    <button
                                        onClick={() => setInventoryTab('rods')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition ${
                                            inventoryTab === 'rods' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-300 text-gray-700'
                                        }`}
                                    >
                                        üé£ C·∫ßn c√¢u ({ownedRods.length})
                                    </button>
                                    <button
                                        onClick={() => setInventoryTab('baits')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition ${
                                            inventoryTab === 'baits' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-300 text-gray-700'
                                        }`}
                                    >
                                        ü™± M·ªìi c√¢u ({ownedBaits.length})
                                    </button>
                                    <button
                                        onClick={() => setInventoryTab('items')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition ${
                                            inventoryTab === 'items' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-300 text-gray-700'
                                        }`}
                                    >
                                        ‚òØÔ∏è Items ({items.length})
                                    </button>
                                </div>
                                
                                {inventoryTab === 'fish' ? (
                                    <div>
                                        {inventory.length === 0 ? (
                                            <p className="text-center text-gray-500 text-xl py-12">Ch∆∞a c√≥ c√° n√†o trong balo!</p>
                                        ) : (
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                {inventory.map((fish) => (
                                                    <div
                                                        key={fish.id}
                                                        className="border-4 rounded-lg p-4 relative"
                                                        style={{ borderColor: fish.color }}
                                                    >
                                                        <button
                                                            onClick={() => toggleFavourite(fish.id, fish.favourite)}
                                                            className="absolute top-2 right-2 text-3xl hover:scale-110 transition"
                                                        >
                                                            {fish.favourite ? '‚≠ê' : '‚òÜ'}
                                                        </button>
                                                        
                                                        <div className="flex items-center gap-3 mb-2">
                                                            <FishIcon size={32} color={fish.color} />
                                                            <h3 className="text-xl font-bold" style={{ color: fish.color }}>
                                                                {fish.name}
                                                            </h3>
                                                        </div>
                                                        <div className="space-y-1 text-gray-700">
                                                            <p><strong>ƒê·ªô hi·∫øm:</strong> {fish.rarity}</p>
                                                            <p><strong>C√¢n n·∫∑ng:</strong> {fish.weight} kg</p>
                                                            <p><strong>Gi√° tr·ªã:</strong> {fish.price} xu</p>
                                                            <p><strong>Mutation c√° n√†y l√†:</strong> {fish.mutation ? fish.mutation : 'Kh√¥ng c√≥'}</p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ) : inventoryTab === 'rods' ? (
                                    <div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            {ownedRods.map((rodType, index) => (
                                                <div
                                                    key={index}
                                                    className="border-4 rounded-lg p-6 relative"
                                                    style={{ borderColor: getRodColor(rodType) }}
                                                >
                                                    {fishingRod === rodType && (
                                                        <div className="absolute top-2 right-2 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                                                            ‚úì ƒêang d√πng
                                                        </div>
                                                    )}
                                                    
                                                    <div className="text-center mb-4">
                                                        <div className="text-5xl mb-2">üé£</div>
                                                        <h3 className="text-xl font-bold mb-2" style={{ color: getRodColor(rodType) }}>
                                                            {getRodNameByType(rodType)}
                                                        </h3>
                                                        <p className="text-gray-600 text-sm mb-4">
                                                            {getRodDescription(rodType)}
                                                        </p>
                                                    </div>
                                                    
                                                    {fishingRod !== rodType && (
                                                        <button
                                                            onClick={() => equipRod(rodType)}
                                                            className="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                                        >
                                                            Trang b·ªã
                                                        </button>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : inventoryTab === 'baits' ? (
                                    <div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            {ownedBaits.map((baitType, index) => {
                                                const bait = baitInfo[baitType];
                                                return (
                                                    <div
                                                        key={index}
                                                        className="border-4 rounded-lg p-6 relative"
                                                        style={{ borderColor: bait.color }}
                                                    >
                                                        {currentBait === baitType && (
                                                            <div className="absolute top-2 right-2 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                                                                ‚úì ƒêang d√πng
                                                            </div>
                                                        )}
                                                        
                                                        <div className="text-center mb-4">
                                                            <div className="text-5xl mb-2">{bait.icon}</div>
                                                            <h3 className="text-xl font-bold mb-2" style={{ color: bait.color }}>
                                                                {bait.name}
                                                            </h3>
                                                            <p className="text-gray-600 text-sm mb-4">
                                                                {bait.description}
                                                            </p>
                                                        </div>
                                                        
                                                        {currentBait !== baitType && (
                                                            <button
                                                                onClick={() => equipBait(baitType)}
                                                                className="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                                            >
                                                                Trang b·ªã
                                                            </button>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ) : inventoryTab === 'items' ? (
                                    <div>
                                        {items.length === 0 ? (
                                            <p className="text-center text-gray-500 text-xl py-12">Ch∆∞a c√≥ item n√†o!</p>
                                        ) : (
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                {items.map((item) => {
                                                    const itemDef = itemDefs[item.key];
                                                    return (
                                                        <div
                                                            key={item.id}
                                                            className="border-4 rounded-lg p-6 relative"
                                                            style={{ borderColor: itemDef.color }}
                                                        >
                                                            <div className="text-center mb-4">
                                                                <div className="text-5xl mb-2">{itemDef.icon}</div>
                                                                <h3 className="text-xl font-bold mb-2" style={{ color: itemDef.color }}>
                                                                    {itemDef.name}
                                                                </h3>
                                                                <p className="text-gray-600 text-sm mb-4">
                                                                    {itemDef.description}
                                                                </p>
                                                            </div>
                                                            
                                                            {itemDef.usable && (
                                                                <button
                                                                    onClick={() => useItem(item.id)}
                                                                    className="w-full py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
                                                                >
                                                                    S·ª≠ d·ª•ng
                                                                </button>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                ) : null}
                            </div>
                        </div>
                    </div>
                );
            }

            if (showShop) {
                return (
                    <div
                      className="min-h-screen bg-cover bg-center p-8"
                      style={{ backgroundImage: "url('inshop.png')" }}
                    >
                        {/* Thay th·∫ø ph·∫ßn hi·ªÉn th·ªã money c≈© */}
                        <div className="fixed top-4 right-4 bg-yellow-400 px-6 py-3 rounded-lg shadow-lg z-50">
                            <p className="text-2xl font-bold text-gray-800">
                                üí∞ {formatMoney(Math.floor(displayMoney))} xu
                            </p>
                            {showMoneyChange && (
                                <div 
                                    className={`absolute -bottom-8 right-0 text-xl font-bold animate-bounce ${
                                        moneyChange > 0 ? 'text-green-500' : 'text-red-500'
                                    }`}
                                    style={{
                                        animation: 'slideUp 2s ease-out forwards'
                                    }}
                                >
                                    {moneyChange > 0 ? '+' : ''}{formatMoney(moneyChange)}
                                </div>
                            )}
                        </div>
                        
                        <div className="max-w-6xl mx-auto">
                            <div className="bg-white rounded-lg shadow-2xl p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-3xl font-bold text-gray-800">ü™ù C·ª≠a H√†ng</h2>
                                    <button
                                        onClick={() => setShowShop(false)}
                                        className="px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition"
                                    >
                                        Quay l·∫°i
                                    </button>
                                </div>

                                <div className="flex gap-2 mb-6">
                                    <button
                                        onClick={() => setShopTab('rods')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition ${
                                            shopTab === 'rods' 
                                                ? 'bg-purple-600 text-white' 
                                                : 'bg-gray-300 text-gray-700'
                                        }`}
                                    >
                                        üé£ C·∫ßn C√¢u
                                    </button>
                                    <button
                                        onClick={() => setShopTab('baits')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition ${
                                            shopTab === 'baits' 
                                                ? 'bg-purple-600 text-white' 
                                                : 'bg-gray-300 text-gray-700'
                                        }`}
                                    >
                                        ü™± M·ªìi C√¢u
                                    </button>
                                    <button
                                        onClick={() => setShopTab('rolls')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition ${
                                            shopTab === 'rolls' 
                                                ? 'bg-purple-600 text-white' 
                                                : 'bg-gray-300 text-gray-700'
                                        }`}
                                    >
                                        üé≤ Roll T·ªôc
                                    </button>
                                </div>

                                <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                                    <p className="text-lg font-semibold text-blue-900">
                                        üé£ C·∫ßn c√¢u: <span className="text-blue-600">{getRodName()}</span>
                                        <span className="mx-2">|</span>
                                        ü™± M·ªìi: <span className="text-green-600">{baitInfo[currentBait].name}</span>
                                    </p>
                                </div>

                                {shopTab === 'rods' ? (
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        {shopItems.map((item) => {
                                            const tribeData = tribes[tribe] || tribes['nguoi'];
                                            const discount = tribeData.shopDiscount / 100;
                                            const effectivePrice = Math.round(item.price * (1 - discount));
                                            const isOwned = ownedRods.includes(item.unlocks);
            
                                            return (
                                                <div
                                                    key={item.id}
                                                    className="border-4 border-gray-300 rounded-lg p-6 relative bg-gradient-to-b from-white to-gray-50"
                                                >
                                                    {isOwned && (
                                                        <div className="absolute top-2 right-2 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                                                            ‚úì ƒê√£ mua
                                                        </div>
                                                    )}
                    
                                                    <div className="text-center mb-4">
                                                        <div className="text-5xl mb-3">üé£</div>
                                                    </div>
                    
                                                    <h3 className="text-2xl font-bold mb-2 text-gray-800">
                                                        {item.name}
                                                    </h3>
                                                    <p className="text-gray-600 mb-4 min-h-12">
                                                        {item.description}
                                                    </p>
                                                    <p className="text-3xl font-bold text-yellow-600 mb-4">
                                                        üí∞ {effectivePrice} xu {discount > 0 && `(gi·∫£m ${tribeData.shopDiscount}%)`}
                                                    </p>
                                                    <button
                                                        onClick={() => buyRod(item)}
                                                        disabled={isOwned || money < effectivePrice}
                                                        className={`w-full py-3 text-white text-lg font-bold rounded-lg transition ${item.color} disabled:bg-gray-400 disabled:cursor-not-allowed`}
                                                    >
                                                        {isOwned ? 'ƒê√£ s·ªü h·ªØu' : money < effectivePrice ? 'Kh√¥ng ƒë·ªß ti·ªÅn' : 'Mua ngay'}
                                                    </button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                ) : shopTab === 'baits' ? (
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        {Object.entries(baitInfo).filter(([key]) => key !== 'normal').map(([baitType, bait]) => {
                                            const tribeData = tribes[tribe] || tribes['nguoi'];
                                            const discount = tribeData.shopDiscount / 100;
                                            const effectivePrice = Math.round(bait.price * (1 - discount));
                                            const isOwned = ownedBaits.includes(baitType);
            
                                            return (
                                                <div
                                                    key={baitType}
                                                    className="border-4 rounded-lg p-6 relative bg-gradient-to-b from-white to-gray-50"
                                                    style={{ borderColor: bait.color }}
                                                >
                                                    {isOwned && (
                                                        <div className="absolute top-2 right-2 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                                                            ‚úì ƒê√£ mua
                                                        </div>
                                                    )}
                    
                                                    <div className="text-center mb-4">
                                                        <div className="text-6xl mb-3">{bait.icon}</div>
                                                        <h3 className="text-2xl font-bold mb-2" style={{ color: bait.color }}>
                                                            {bait.name}
                                                        </h3>
                                                        <p className="text-gray-600 mb-4 min-h-12">
                                                            {bait.description}
                                                        </p>
                                                    </div>
                    
                                                    <div className="mb-4 text-sm text-gray-700">
                                                        <p className="font-bold mb-2">Gi·∫£m ƒë·ªô kh√≥:</p>
                                                        <div className="space-y-1">
                                                            <p>Common: {bait.difficulty.Common}%</p>
                                                            <p>Uncommon: {bait.difficulty.Uncommon}%</p>
                                                            <p>Rare: {bait.difficulty.Rare}%</p>
                                                            <p>Legendary: {bait.difficulty.Legendary}%</p>
                                                            <p>Mythic: {bait.difficulty.Mythic}%</p>
                                                            <p>Secret: {bait.difficulty.Secret}%</p>
                                                        </div>
                                                    </div>
                                                    <p className="text-3xl font-bold text-yellow-600 mb-4">
                                                        üí∞ {effectivePrice} xu {discount > 0 && `(gi·∫£m ${tribeData.shopDiscount}%)`}
                                                    </p>
                                                    <button
                                                        onClick={() => buyBait(baitType)}
                                                        disabled={isOwned || money < effectivePrice}
                                                        className="w-full py-3 text-white text-lg font-bold rounded-lg transition bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                                                    >
                                                        {isOwned ? 'ƒê√£ s·ªü h·ªØu' : money < effectivePrice ? 'Kh√¥ng ƒë·ªß ti·ªÅn' : 'Mua ngay'}
                                                    </button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        {rollItems.map((item) => {
                                            const tribeData = tribes[tribe] || tribes['nguoi'];
                                            const discount = tribeData.shopDiscount / 100;
                                            const effectivePrice = Math.round(item.basePrice * (1 - discount));
                                            const purchased = purchasedRollPacks[item.packType] || 0;
                                            const isMax = purchased >= 10;

                                            return (
                                                <div
                                                    key={item.id}
                                                    className="border-4 border-gray-300 rounded-lg p-6 relative bg-gradient-to-b from-white to-gray-50"
                                                >
                                                    {isMax && (
                                                        <div className="absolute top-2 right-2 bg-red-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                                                            Max 10
                                                        </div>
                                                    )}
                    
                                                    <div className="text-center mb-4">
                                                        <div className="text-5xl mb-3">üé≤</div>
                                                    </div>
                    
                                                    <h3 className="text-2xl font-bold mb-2 text-gray-800">
                                                        {item.name}
                                                    </h3>
                                                    <p className="text-gray-600 mb-4 min-h-12">
                                                        {item.description} (ƒê√£ mua: {purchased}/10)
                                                    </p>
                                                    <p className="text-3xl font-bold text-yellow-600 mb-4">
                                                        üí∞ {effectivePrice} xu {discount > 0 && `(gi·∫£m ${tribeData.shopDiscount}%)`}
                                                    </p>
                                                    <button
                                                        onClick={() => buyRollPack(item)}
                                                        disabled={isMax || money < effectivePrice}
                                                        className={`w-full py-3 text-white text-lg font-bold rounded-lg transition bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed`}
                                                    >
                                                        {isMax ? 'ƒê√£ max' : money < effectivePrice ? 'Kh√¥ng ƒë·ªß ti·ªÅn' : 'Mua ngay'}
                                                    </button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                                
                            </div>
                        </div>
                    </div>
                );
            }

            if (showLeaderboard) {
                const sortedData = leaderboardTab === 'fish' 
                    ? [...leaderboardData].sort((a, b) => b.fishCount - a.fishCount)
                    : [...leaderboardData].sort((a, b) => b.money - a.money);

                return (
                    <div
                      className="min-h-screen bg-cover bg-center p-8"
                      style={{ backgroundImage: "url('inleaderboard.jpg')" }}
                    >
                        {/* Thay th·∫ø ph·∫ßn hi·ªÉn th·ªã money c≈© */}
                        <div className="fixed top-4 right-4 bg-yellow-400 px-6 py-3 rounded-lg shadow-lg z-50">
                            <p className="text-2xl font-bold text-gray-800">
                                üí∞ {formatMoney(Math.floor(displayMoney))} xu
                            </p>
                            {showMoneyChange && (
                                <div 
                                    className={`absolute -bottom-8 right-0 text-xl font-bold animate-bounce ${
                                        moneyChange > 0 ? 'text-green-500' : 'text-red-500'
                                    }`}
                                    style={{
                                        animation: 'slideUp 2s ease-out forwards'
                                    }}
                                >
                                    {moneyChange > 0 ? '+' : ''}{formatMoney(moneyChange)}
                                </div>
                            )}
                        </div>
            
                        <div className="max-w-4xl mx-auto">
                            <div className="bg-white rounded-lg shadow-2xl p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-3xl font-bold text-gray-800">üèÜ B·∫£ng X·∫øp H·∫°ng</h2>
                                    <button
                                        onClick={() => setShowLeaderboard(false)}
                                        className="px-6 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition"
                                    >
                                        Quay l·∫°i
                                    </button>
                                </div>

                                <div className="flex gap-2 mb-6">
                                    <button
                                        onClick={() => setLeaderboardTab('fish')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition ${
                                            leaderboardTab === 'fish' 
                                                ? 'bg-blue-600 text-white' 
                                    :             'bg-gray-300 text-gray-700'
                                        }`}
                                    >
                                        üêü S·ªë C√° C√¢u ƒê∆∞·ª£c
                                    </button>
                                    <button
                                        onClick={() => setLeaderboardTab('money')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition ${
                                            leaderboardTab === 'money' 
                                                ? 'bg-yellow-600 text-white' 
                                                : 'bg-gray-300 text-gray-700'
                                        }`}
                                    >
                                        üí∞ S·ªë Ti·ªÅn
                                    </button>
                                </div>

                                <button
                                    onClick={loadLeaderboard}
                                    disabled={loadingLeaderboard}
                                    className="w-full mb-4 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition disabled:bg-gray-400"
                                >
                                    {loadingLeaderboard ? '‚è≥ ƒêang t·∫£i...' : 'üîÑ L√†m m·ªõi'}
                                </button>

                                {loadingLeaderboard ? (
                                    <div className="text-center text-gray-500 text-xl py-12">
                                        ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng...
                                    </div>
                                ) : sortedData.length === 0 ? (
                                    <div className="text-center text-gray-500 text-xl py-12">
                                        Ch∆∞a c√≥ d·ªØ li·ªáu
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {sortedData.map((player, index) => {
                                            const isCurrentUser = player.id === userId;
                                            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                                
                                            return (
                                                <div
                                                    key={player.id}
                                                    className={`flex items-center justify-between p-4 rounded-lg border-2 ${
                                                        isCurrentUser 
                                                            ? 'bg-blue-50 border-blue-500' 
                                                            : 'bg-gray-50 border-gray-200'
                                                    }`}
                                                >
                                                    <div className="flex items-center gap-4">
                                                        <span className="text-3xl font-bold w-12 text-center">
                                                            {medal}
                                                        </span>
                                                        <div>
                                                            <p className="font-bold text-lg text-gray-800">
                                                                {player.email}
                                                                {isCurrentUser && (
                                                                    <span className="ml-2 text-sm bg-blue-500 text-white px-2 py-1 rounded">
                                                                        B·∫°n
                                                                    </span>
                                                                )}
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        {leaderboardTab === 'fish' ? (
                                                            <p className="text-2xl font-bold text-blue-600">
                                                                üêü {player.fishCount}
                                                            </p>
                                                        ) : (
                                                            <p className="text-2xl font-bold text-yellow-600">
                                                                üí∞ {player.money} xu
                                                            </p>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            if (showQuests) {
                const completedCount = dailyQuests.filter(q => q.completed).length;
                const claimedCount = dailyQuests.filter(q => q.claimed).length;
    
                return (
                    <div
                      className="min-h-screen bg-cover bg-center p-8"
                      style={{ backgroundImage: "url('inquest.png')" }}
                    >
                        {/* Thay th·∫ø ph·∫ßn hi·ªÉn th·ªã money c≈© */}
                        <div className="fixed top-4 right-4 bg-yellow-400 px-6 py-3 rounded-lg shadow-lg z-50">
                            <p className="text-2xl font-bold text-gray-800">
                                üí∞ {formatMoney(Math.floor(displayMoney))} xu
                            </p>
                            {showMoneyChange && (
                                <div 
                                    className={`absolute -bottom-8 right-0 text-xl font-bold animate-bounce ${
                                        moneyChange > 0 ? 'text-green-500' : 'text-red-500'
                                    }`}
                                    style={{
                                        animation: 'slideUp 2s ease-out forwards'
                                    }}
                                >
                                    {moneyChange > 0 ? '+' : ''}{formatMoney(moneyChange)}
                                </div>
                            )}
                        </div>
            
                        <div className="max-w-4xl mx-auto">
                            <div className="bg-white rounded-lg shadow-2xl p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <div>
                                        <h2 className="text-3xl font-bold text-gray-800">üìã Nhi·ªám V·ª• H·∫±ng Ng√†y</h2>
                                        <p className="text-sm text-gray-600 mt-1">
                                            Ho√†n th√†nh: {completedCount}/{dailyQuests.length} | 
                                            ƒê√£ nh·∫≠n th∆∞·ªüng: {claimedCount}/{dailyQuests.length}
                                        </p>
                                    </div>
                                    <button
                                        onClick={() => setShowQuests(false)}
                                        className="px-6 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition"
                                    >
                                        Quay l·∫°i
                                    </button>
                                </div>

                                {dailyQuests.length === 0 ? (
                                    <div className="text-center text-gray-500 text-xl py-12">
                                        ƒêang t·∫£i nhi·ªám v·ª•...
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {dailyQuests.map((quest) => {
                                            const progressPercent = Math.min((quest.progress / quest.target) * 100, 100);
                                
                                            return (
                                                <div
                                                    key={quest.id}
                                                    className={`border-2 rounded-lg p-6 transition ${
                                                        quest.completed 
                                                            ? 'bg-green-50 border-green-500' 
                                                            : 'bg-gray-50 border-gray-300'
                                                    }`}
                                                >
                                                    <div className="flex items-start justify-between mb-3">
                                                        <div className="flex items-center gap-3">
                                                            <span className="text-4xl">{quest.icon}</span>
                                                            <div>
                                                                <h3 className="text-xl font-bold text-gray-800">
                                                                    {quest.title}
                                                                </h3>
                                                                <p className="text-gray-600">
                                                                    {quest.description.replace('{target}', quest.target)}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className="text-2xl font-bold text-yellow-600">
                                                                +{quest.reward} xu
                                                            </p>
                                                        </div>
                                                    </div>
                                        
                                                    <div className="mb-3">
                                                        <div className="flex justify-between items-center mb-1">
                                                            <span className="text-sm text-gray-600">
                                                                Ti·∫øn ƒë·ªô: {quest.progress}/{quest.target}
                                                            </span>
                                                            <span className="text-sm font-semibold text-gray-700">
                                                                {progressPercent.toFixed(0)}%
                                                            </span>
                                                        </div>
                                                        <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                                            <div
                                                                className={`h-full rounded-full transition-all duration-500 ${
                                                                    quest.completed ? 'bg-green-500' : 'bg-blue-500'
                                                                }`}
                                                                style={{ width: `${progressPercent}%` }}
                                                            />
                                                        </div>
                                                    </div>
                                        
                                                    {quest.completed && !quest.claimed && (
                                                        <button
                                                            onClick={() => claimQuestReward(quest.id)}
                                                            className="w-full py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition animate-pulse"
                                                        >
                                                            üéÅ Nh·∫≠n th∆∞·ªüng
                                                        </button>
                                                    )}
                                        
                                                    {quest.claimed && (
                                                        <div className="w-full py-3 bg-gray-400 text-white font-bold rounded-lg text-center">
                                                            ‚úÖ ƒê√£ nh·∫≠n th∆∞·ªüng
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                    
                                {lastQuestReset && (
                                    <div className="mt-6 p-4 bg-blue-50 rounded-lg text-center">
                                        <p className="text-sm text-gray-600">
                                            ‚è∞ Nhi·ªám v·ª• s·∫Ω ƒë∆∞·ª£c l√†m m·ªõi v√†o 00:00 m·ªói ng√†y
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div
                  className={`min-h-screen flex items-center justify-center transition-all duration-500 bg-cover bg-center ${
                    gameState === 'fishing' || gameState === 'question'
                      ? ''
                      : ''
                  }`}
                  style={
                    gameState === 'fishing' || gameState === 'question'
                      ? { backgroundImage: "url('infishingtime.jpg')" }
                      : { backgroundImage: "url('background.jpg')" }
                  }
                >
                    <div className="fixed top-4 left-4 bg-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3">
                        <span className="text-lg">üë§ <strong>{currentUser}</strong></span>
                        {isAdmin && (
                            <span className="bg-red-500 text-white px-2 py-1 rounded text-xs font-bold">ADMIN</span>
                        )}
                        <button
                            onClick={handleLogout}
                            className="bg-red-500 text-white px-4 py-1 rounded-md text-sm hover:bg-red-600 transition"
                        >
                            ƒêƒÉng xu·∫•t
                        </button>
                    </div>

                    {/* Thay th·∫ø ph·∫ßn hi·ªÉn th·ªã money c≈© */}
                    <div className="fixed top-4 right-4 bg-yellow-400 px-6 py-3 rounded-lg shadow-lg z-50">
                        <p className="text-2xl font-bold text-gray-800">
                            üí∞ {formatMoney(Math.floor(displayMoney))} xu
                        </p>
                        {showMoneyChange && (
                            <div 
                                className={`absolute -bottom-8 right-0 text-xl font-bold animate-bounce ${
                                    moneyChange > 0 ? 'text-green-500' : 'text-red-500'
                                }`}
                                style={{
                                    animation: 'slideUp 2s ease-out forwards'
                                }}
                            >
                                {moneyChange > 0 ? '+' : ''}{formatMoney(moneyChange)}
                            </div>
                        )}
                    </div>
                    
                    {message && gameState === 'menu' && (
                        <div className="fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
                            <p className="text-xl font-bold">{message}</p>
                        </div>
                    )}
                    
                    {showSellConfirm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-8 max-w-md mx-4">
                                <h3 className="text-2xl font-bold mb-4 text-gray-800">X√°c nh·∫≠n b√°n c√°</h3>
                                <p className="text-lg mb-6 text-gray-600">
                                    B·∫°n c√≥ {inventory.filter(f => !f.favourite).length} con c√° c√≥ th·ªÉ b√°n
                                    <br />
                                    <span className="text-sm text-gray-500">(C√° ƒë∆∞·ª£c ƒë√°nh d·∫•u ‚≠ê s·∫Ω kh√¥ng b·ªã b√°n)</span>
                                </p>
                                <div className="flex gap-4">
                                    <button
                                        onClick={sellFish}
                                        className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                                    >
                                        ƒê·ªìng √Ω
                                    </button>
                                    <button
                                        onClick={() => setShowSellConfirm(false)}
                                        className="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
                                    >
                                        H·ªßy
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <div className="text-center">
                        {gameState === 'menu' && (
                            <div className="space-y-6">
                                <h1 className="text-5xl font-bold text-white mb-8 drop-shadow-lg">
                                    üé£ Fishing With The Math üé£
                                </h1>
                                <button
                                    onClick={startFishing}
                                    className="px-12 py-4 bg-blue-600 text-white text-2xl rounded-lg hover:bg-blue-700 transform hover:scale-105 transition shadow-lg"
                                >
                                    B·∫Øt ƒë·∫ßu c√¢u c√°
                                </button>
        
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 justify-center mt-6">
                                    <button
                                        onClick={() => setShowInventory(true)}
                                        className="px-4 py-2 text-lg sm:px-8 sm:py-3 sm:text-xl bg-green-600 text-white rounded-lg hover:bg-green-700 transform hover:scale-105 transition shadow-lg flex items-center gap-2 w-full"
                                    >
                                        <PackageIcon size={24} />
                                        Balo ({inventory.length})
                                    </button>
                                    <button
                                        onClick={() => setShowQuests(true)}
                                        className="px-4 py-2 text-lg sm:px-8 sm:py-3 sm:text-xl bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transform hover:scale-105 transition shadow-lg relative w-full"
                                    >
                                        üìã Nhi·ªám v·ª•
                                        {dailyQuests.filter(q => q.completed && !q.claimed).length > 0 && (
                                            <span className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold animate-bounce">
                                                {dailyQuests.filter(q => q.completed && !q.claimed).length}
                                            </span>
                                        )}
                                    </button>
                                    {isAdmin && (
                                        <button
                                            onClick={() => setShowAdminPanel(true)}
                                            className="px-4 py-2 text-lg sm:px-8 sm:py-3 sm:text-xl bg-gradient-to-r from-red-600 to-pink-600 text-white rounded-lg hover:from-red-700 hover:to-pink-700 transform hover:scale-105 transition shadow-lg border-2 border-yellow-400 animate-pulse w-full"
                                        >
                                            ‚öôÔ∏è Admin Command
                                        </button>
                                    )}
                                    {isAdmin && (
                                        <button
                                            onClick={() => { setShowLogs(true); loadLogs(); }}
                                            className="px-4 py-2 text-lg sm:px-8 sm:py-3 sm:text-xl bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transform hover:scale-105 transition shadow-lg w-full"
                                        >
                                            üìã Logs
                                        </button>
                                    )}
                                    <button
                                        onClick={() => setShowRollPanel(true)}
                                        className="px-4 py-2 text-lg sm:px-8 sm:py-3 sm:text-xl bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 transform hover:scale-105 transition shadow-lg w-full"
                                    >
                                        üé≤ Roll T·ªôc ({rollCount} l·∫ßn)
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowLeaderboard(true);
                                            loadLeaderboard();
                                        }}
                                        className="px-4 py-2 text-lg sm:px-8 sm:py-3 sm:text-xl bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transform hover:scale-105 transition shadow-lg w-full"
                                    >
                                        üèÜ B·∫£ng x·∫øp h·∫°ng
                                    </button>
            
                                    <button
                                        onClick={() => setShowShop(true)}
                                        className="px-4 py-2 text-lg sm:px-8 sm:py-3 sm:text-xl bg-purple-600 text-white rounded-lg hover:bg-purple-700 transform hover:scale-105 transition shadow-lg w-full"
                                    >
                                        ü™ù C·ª≠a h√†ng
                                    </button>
            
                                    <button
                                        onClick={() => setShowSellConfirm(true)}
                                        disabled={inventory.filter(f => !f.favourite).length === 0}
                                        className="px-4 py-2 text-lg sm:px-8 sm:py-3 sm:text-xl bg-orange-600 text-white rounded-lg hover:bg-orange-700 transform hover:scale-105 transition shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed disabled:hover:scale-100 w-full"
                                    >
                                        üíµ B√°n c√°
                                    </button>
                                </div>
                                <div className="mt-6 p-4 bg-white bg-opacity-50 rounded-lg space-y-2">
                                    <p className="text-lg font-semibold text-gray-800">
                                        üé£ C·∫ßn c√¢u: <span className="text-blue-600">{getRodName()}</span>
                                    </p>
                                    <p className="text-lg font-semibold text-gray-800">
                                        {baitInfo[currentBait].icon} M·ªìi: <span className="text-green-600">{baitInfo[currentBait].name}</span>
                                    </p>
                                    <p className="text-lg font-semibold text-gray-800">
                                        üå¶Ô∏è Weather: <span className="text-purple-700">{currentWeather?.name || '...'}</span>
                                        <span className="mx-2">|</span>
                                        {currentWeather?.isWaiting ? (
                                            <>
                                                ‚è≥ Ch·ªù weather m·ªõi: <span className="text-orange-700">{getWeatherCountdownText()}</span>
                                            </>
                                        ) : (
                                            <>
                                                ‚è≥ C√≤n: <span className="text-red-700">{getWeatherCountdownText()}</span>
                                            </>
                                        )}
                                        <span className="mx-2">|</span>
                                        üíß N∆∞·ªõc: <span className="text-blue-700">{currentWeather?.waterLevel ?? 0}/10</span>
                                        <span className="mx-2">|</span>
                                        ‚òÄÔ∏è N·∫Øng: <span className="text-yellow-700">{currentWeather?.sunLevel ?? 0}/10</span>
                                        <span className="mx-2">|</span>
                                        üå´Ô∏è Kh√≠ quy·ªÉn: <span className="text-gray-700">{currentWeather?.atmosphereLevel ?? 0}/10</span>
                                    </p>
                                    {currentWeather?.addedWeathers && currentWeather.addedWeathers.length > 0 && (
                                        <div className="mt-2 space-y-1">
                                            <p className="text-sm font-semibold text-indigo-700">üåà Th√™m weather:</p>
                                            {currentWeather.addedWeathers.map((item, idx) => {
                                                const wdef = weatherDefs[item.key];
                                                return (
                                                    <p key={idx} className="text-sm text-gray-700">
                                                        ‚Ä¢ {wdef?.name || item.key} ({formatCountdownFromMs(item.expiresAtMs)})
                                                    </p>
                                                );
                                            })}
                                        </div>
                                    )}
                                    <div className="space-y-2">
                                        <div className="w-full bg-gray-300 rounded-full h-2 overflow-hidden">
                                            <div
                                                className="bg-blue-600 h-2"
                                                style={{ width: `${Math.max(0, Math.min(100, ((currentWeather?.waterLevel ?? 0) / 10) * 100))}%` }}
                                            />
                                        </div>
                                        <div className="w-full bg-gray-300 rounded-full h-2 overflow-hidden">
                                            <div
                                                className="bg-yellow-500 h-2"
                                                style={{ width: `${Math.max(0, Math.min(100, ((currentWeather?.sunLevel ?? 0) / 10) * 100))}%` }}
                                            />
                                        </div>
                                        <div className="w-full bg-gray-300 rounded-full h-2 overflow-hidden">
                                            <div
                                                className="bg-gray-700 h-2"
                                                style={{ width: `${Math.max(0, Math.min(100, ((currentWeather?.atmosphereLevel ?? 0) / 10) * 100))}%` }}
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {gameState === 'fishing' && (
                            <div className="bg-white bg-opacity-90 rounded-lg p-12 shadow-2xl">
                                <h2 className="text-4xl font-bold text-blue-600 animate-pulse">
                                    C√° ƒë√£ c·∫Øn c√¢u! üé£
                                </h2>
                            </div>
                        )}

                        {gameState === 'question' && currentFish && (
                            <div className="bg-white rounded-lg p-8 shadow-2xl max-w-md">
                                <div className="mb-4 p-4 rounded-lg" style={{ backgroundColor: currentFish.color + '20' }}>
                                    <div className="flex justify-center mb-2">
                                        <FishIcon size={48} color={currentFish.color} />
                                    </div>
                                    <h2 className={`text-2xl font-bold mb-2 ${showTaiChiImage ? 'glitch-text' : ''}`} style={{ color: currentFish.color }}>
                                        {currentFish.name}
                                    </h2>
                                    <p className={`text-lg ${showTaiChiImage ? 'glitch-text' : ''}`}><strong>ƒê·ªô hi·∫øm:</strong> {currentFish.rarity}</p>
                                    <p className={`text-lg ${showTaiChiImage ? 'glitch-number' : ''}`}><strong>C√¢n n·∫∑ng:</strong> {currentFish.weight} kg</p>
                                </div>

                                <div className="my-4 p-4 bg-gray-100 rounded-lg">
                                    <p className="text-sm text-purple-600 font-semibold mb-2">
                                        {baitInfo[currentBait].icon} S·ª≠ d·ª•ng: {baitInfo[currentBait].name}
                                    </p>
                                    <p className="text-sm text-blue-600 font-semibold mb-2">
                                        üå¶Ô∏è Weather: {currentWeather?.name || '...'} | {currentWeather?.isWaiting ? `‚è≥ Ch·ªù weather m·ªõi: ${getWeatherCountdownText()}` : `‚è≥ C√≤n: ${getWeatherCountdownText()}`}
                                    </p>
                                    {currentWeather?.addedWeathers && currentWeather.addedWeathers.length > 0 && (
                                        <div className="mb-2 space-y-1">
                                            <p className="text-xs font-semibold text-indigo-700">üåà Th√™m:</p>
                                            {currentWeather.addedWeathers.map((item, idx) => {
                                                const wdef = weatherDefs[item.key];
                                                return (
                                                    <p key={idx} className="text-xs text-gray-600">
                                                        ‚Ä¢ {wdef?.name || item.key} ({formatCountdownFromMs(item.expiresAtMs)})
                                                    </p>
                                                );
                                            })}
                                        </div>
                                    )}
                                    <p className={`text-3xl font-bold text-gray-800 mb-4 ${showTaiChiImage ? 'glitch-number' : ''}`}>
                                        {currentFish.math.question} = ?
                                    </p>
                                    <p className={`text-xl text-red-500 font-bold ${showTaiChiImage ? 'glitch-number' : ''}`}>
                                        Th·ªùi gian: {timeLeft}s
                                    </p>
                                </div>

                                <input
                                    type="number"
                                    value={answer}
                                    onChange={(e) => setAnswer(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && checkAnswer()}
                                    placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi"
                                    className="w-full px-4 py-3 text-xl border-2 border-gray-300 rounded-lg mb-4 text-center"
                                    autoFocus
                                />

                                <button
                                    onClick={checkAnswer}
                                    className="w-full px-6 py-3 bg-green-600 text-white text-xl rounded-lg hover:bg-green-700 transition"
                                >
                                    Tr·∫£ l·ªùi
                                </button>

                                {hasTaiChiPower && (
                                    <button
                                        onClick={activateTaiChiPower}
                                        className="w-full px-6 py-3 bg-purple-600 text-white text-xl rounded-lg hover:bg-purple-700 transition mt-2"
                                    >
                                        ‚òØÔ∏è Th√°i C·ª±c Quy·ªÅn Ph√°p
                                    </button>
                                )}
                            </div>
                        )}

                        {gameState === 'result' && (
                            <div className="bg-white rounded-lg p-12 shadow-2xl max-w-md">
                                <p className="text-2xl font-bold text-gray-800">
                                    {message}
                                </p>
                            </div>
                        )}

                        {/* Overlay Th√°i C·ª±c Quy·ªÅn Ph√°p */}
                        {showTaiChiCutscene && (
                            <div className={`fixed inset-0 z-[9998] flex items-center justify-center ${showTaiChiImage ? 'bg-black bg-opacity-50' : 'bg-black'}`}>
                                {showTaiChiImage ? (
                                    // Hi·ªán UI question v·ªõi overlay thaicuc.png
                                    <div className="relative w-full h-full">
                                        <img 
                                            key={taiChiKey}
                                            src="thaicuc.png" 
                                            alt="Th√°i C·ª±c" 
                                            className="absolute inset-0 w-64 h-64 m-auto animate-spin"
                                            style={{ animationDuration: '0.5s' }}
                                            onError={(e) => {
                                                // Hi·ªán fallback text n·∫øu ·∫£nh kh√¥ng load ƒë∆∞·ª£c
                                                e.target.style.display = 'none';
                                                const fallback = document.createElement('div');
                                                fallback.innerHTML = '‚òØÔ∏è';
                                                fallback.className = 'absolute inset-0 w-64 h-64 m-auto flex items-center justify-center text-white text-6xl animate-spin';
                                                fallback.style.animationDuration = '0.5s';
                                                e.target.parentNode.appendChild(fallback);
                                            }}
                                        />
                                    </div>
                                ) : (
                                    <div className="text-white text-2xl animate-pulse">
                                        ƒêang k√≠ch ho·∫°t Th√°i C·ª±c Quy·ªÅn Ph√°p...
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FishingGame />);
    </script>
</body>
</html>
