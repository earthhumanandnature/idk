<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game C√¢u C√° 2D - Firebase Version</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ‚ö†Ô∏è THAY ƒê·ªîI CONFIG N√ÄY B·∫∞NG FIREBASE CONFIG C·ª¶A B·∫†N
        const firebaseConfig = {
          apiKey: "AIzaSyAdRj_aTtKC4EpctQtiJymTPI5TIhXEQTU",
          authDomain: "fishing-game-b3de4.firebaseapp.com",
          projectId: "fishing-game-b3de4",
          storageBucket: "fishing-game-b3de4.firebasestorage.app",
          messagingSenderId: "995387752934",
          appId: "1:995387752934:web:ccb5c73999a23d7715d627",
          measurementId: "G-2BYJH3JMTZ"
        };

        // Kh·ªüi t·∫°o Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        const FishIcon = ({ size = 24, color = "#000" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2">
                <path d="M6.5 12c.94-3.46 4.94-6 8.5-6 3.56 0 6.06 2.54 7 6-1 3.46-3.44 6-7 6s-7.56-2.54-8.5-6Z"/>
                <path d="M18 12v.5M16 17.5a2 2 0 0 0 2-2"/>
                <path d="M20 12c0-.5 0-1-.09-1.5"/>
            </svg>
        );

        const PackageIcon = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/>
                <path d="m3.3 7 8.7 5 8.7-5M12 22V12"/>
            </svg>
        );

        const FishingGame = () => {
            const [gameState, setGameState] = useState('login');
            const [loginMode, setLoginMode] = useState('login');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [currentUser, setCurrentUser] = useState(null);
            const [userId, setUserId] = useState(null);
            const [currentFish, setCurrentFish] = useState(null);
            const [answer, setAnswer] = useState('');
            const [timeLeft, setTimeLeft] = useState(0);
            const [inventory, setInventory] = useState([]);
            const [showInventory, setShowInventory] = useState(false);
            const [inventoryTab, setInventoryTab] = useState('fish');
            const [message, setMessage] = useState('');
            const [money, setMoney] = useState(0);
            const [showSellConfirm, setShowSellConfirm] = useState(false);
            const [loading, setLoading] = useState(false);
            const [showShop, setShowShop] = useState(false);
            const [shopTab, setShopTab] = useState('rods');
            const [fishingRod, setFishingRod] = useState('normal');
            const [ownedRods, setOwnedRods] = useState(['normal']);
            const [currentBait, setCurrentBait] = useState('normal');
            const [ownedBaits, setOwnedBaits] = useState(['normal']);
            const [configError, setConfigError] = useState(false);
            const [showLeaderboard, setShowLeaderboard] = useState(false);
            const [leaderboardTab, setLeaderboardTab] = useState('fish');
            const [leaderboardData, setLeaderboardData] = useState([]);
            const [loadingLeaderboard, setLoadingLeaderboard] = useState(false);
            // State cho nhi·ªám v·ª• h·∫±ng ng√†y
            const [dailyQuests, setDailyQuests] = useState([]);
            const [showQuests, setShowQuests] = useState(false);
            const [lastQuestReset, setLastQuestReset] = useState(null);

            const rarities = [
                { name: 'Common', weight: 60, range: 10, time: 3, color: '#9CA3AF', price: 10 },
                { name: 'Uncommon', weight: 50, range: 20, time: 5, color: '#22C55E', price: 25 },
                { name: 'Rare', weight: 30, range: 30, time: 6, color: '#3B82F6', price: 50 },
                { name: 'Legendary', weight: 20, range: 40, time: 8, color: '#A855F7', price: 100 },
                { name: 'Mythic', weight: 10, range: 50, time: 9, color: '#EF4444', price: 200 },
                { name: 'Secret', weight: 1, range: 60, time: 10, color: '#F59E0B', price: 500 }
            ];

            const fishNames = {
                'Common': ['C√° R√¥', 'C√° Ch√©p', 'C√° Tr√™', 'C√° L√≥c'],
                'Uncommon': ['C√° H·ªìi', 'C√° Ng·ª´', 'C√° Chim', 'C√° Basa'],
                'Rare': ['C√° Ki·∫øm', 'C√° M·∫≠p Nh·ªè', 'C√° Voi Con', 'C√° Heo'],
                'Legendary': ['C√° M·∫≠p Tr·∫Øng', 'C√° Voi Xanh', 'C√° S·∫•u', 'C√° R·ªìng'],
                'Mythic': ['C√° R·ªìng V√†ng', 'C√° Ph∆∞·ª£ng Ho√†ng', 'C√° K·ª≥ L√¢n', 'Leviathan'],
                'Secret': ['C√° Th·∫ßn', 'Poseidon', 'Kraken', 'C√° R·ªìng C·ªï ƒê·∫°i']
            };

            const baitInfo = {
                'normal': {
                    name: 'Normal Bait',
                    description: 'M·ªìi c√¢u th√¥ng th∆∞·ªùng',
                    icon: 'ü™±',
                    color: '#9CA3AF',
                    difficulty: {
                        'Common': 0, 'Uncommon': 0, 'Rare': 0,
                        'Legendary': 0, 'Mythic': 0, 'Secret': 0
                    }
                },
                'fish': {
                    name: 'Fish Bait',
                    description: 'Gi·∫£m ƒë·ªô kh√≥ b√†i to√°n',
                    icon: 'üêü',
                    color: '#22C55E',
                    price: 100,
                    difficulty: {
                        'Common': 20, 'Uncommon': 15, 'Rare': 10,
                        'Legendary': 5, 'Mythic': 2, 'Secret': 1
                    }
                },
                'update': {
                    name: 'Update Bait',
                    description: 'Gi·∫£m ƒë√°ng k·ªÉ ƒë·ªô kh√≥',
                    icon: 'ü¶ê',
                    color: '#3B82F6',
                    price: 300,
                    difficulty: {
                        'Common': 40, 'Uncommon': 35, 'Rare': 30,
                        'Legendary': 25, 'Mythic': 20, 'Secret': 10
                    }
                },
                'secret': {
                    name: 'Secret Bait',
                    description: 'Gi·∫£m c·ª±c k·ª≥ nhi·ªÅu ƒë·ªô kh√≥',
                    icon: 'ü¶ë',
                    color: '#A855F7',
                    price: 500,
                    difficulty: {
                        'Common': 80, 'Uncommon': 75, 'Rare': 70,
                        'Legendary': 65, 'Mythic': 60, 'Secret': 55
                    }
                }
            };

            // C·∫•u h√¨nh nhi·ªám v·ª• h·∫±ng ng√†y
            const dailyQuestTemplates = [
                {
                    id: 'catch_fish',
                    type: 'catch',
                    title: 'C√¢u c√°',
                    description: 'C√¢u ƒë∆∞·ª£c {target} con c√° b·∫•t k·ª≥',
                    target: 5,
                    reward: 50,
                    icon: 'üé£'
                },
                {
                    id: 'catch_rare',
                    type: 'catch_rare',
                    title: 'Th·ª£ sƒÉn Rare',
                    description: 'C√¢u ƒë∆∞·ª£c {target} con c√° Rare tr·ªü l√™n',
                    target: 3,
                    reward: 100,
                    icon: '‚≠ê'
                },
                {
                    id: 'solve_math',
                    type: 'solve',
                    title: 'Cao th·ªß to√°n h·ªçc',
                    description: 'Gi·∫£i ƒë√∫ng {target} b√†i to√°n',
                    target: 10,
                    reward: 75,
                    icon: 'üßÆ'
                },
                {
                    id: 'earn_money',
                    type: 'earn',
                    title: 'Ki·∫øm ti·ªÅn',
                    description: 'Ki·∫øm ƒë∆∞·ª£c {target} xu',
                    target: 200,
                    reward: 100,
                    icon: 'üí∞'
                },
                {
                    id: 'catch_legendary',
                    type: 'catch_legendary',
                    title: 'Huy·ªÅn tho·∫°i',
                    description: 'C√¢u ƒë∆∞·ª£c {target} con c√° Legendary tr·ªü l√™n',
                    target: 1,
                    reward: 200,
                    icon: 'üèÜ'
                }
            ];

            const shopItems = [
                {
                    id: 'legendary_rod',
                    name: 'New Rank Fish!',
                    description: 'Gi√∫p b·∫°n c√¢u ƒë∆∞·ª£c c√° Legendary',
                    price: 100,
                    color: 'bg-green-600 hover:bg-green-700',
                    unlocks: 'legendary'
                },
                {
                    id: 'mythic_rod',
                    name: 'Mythical Fishing Rod',
                    description: 'Gi√∫p b·∫°n c√¢u ƒë∆∞·ª£c c√° Mythic',
                    price: 300,
                    color: 'bg-red-600 hover:bg-red-700',
                    unlocks: 'mythic'
                },
                {
                    id: 'secret_rod',
                    name: 'Mysterious Fishing Rod',
                    description: 'Gi√∫p b·∫°n c√¢u ƒë∆∞·ª£c c√° Secret',
                    price: 500,
                    color: 'bg-gray-900 hover:bg-gray-800',
                    unlocks: 'secret'
                }
            ];

            // Ki·ªÉm tra Firebase config
            useEffect(() => {
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    setConfigError(true);
                }
            }, []);

            // L·∫Øng nghe tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        setUserId(user.uid);
                        setCurrentUser(user.email);
                        await loadGameData(user.uid);
                        setGameState('menu');
                    }
                });
                return () => unsubscribe();
            }, []);

            // Auto-save game data
            useEffect(() => {
                if (userId && gameState === 'menu') {
                    const saveTimer = setTimeout(() => {
                        saveGameData();
                    }, 2000);
                    return () => clearTimeout(saveTimer);
                }
            }, [money, fishingRod, ownedRods, currentBait, ownedBaits, userId]);

            const loadGameData = async (uid) => {
                try {
                    const gameDoc = await db.collection('users').doc(uid).get();
                    if (gameDoc.exists) {
                        const data = gameDoc.data();
                        setMoney(data.money || 0);
                        setFishingRod(data.fishingRod || 'normal');
                        setOwnedRods(data.ownedRods || ['normal']);
                        setCurrentBait(data.currentBait || 'normal');
                        setOwnedBaits(data.ownedBaits || ['normal']);
                    }

                    const inventorySnapshot = await db.collection('users').doc(uid).collection('inventory').get();
                    const fishList = inventorySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setInventory(fishList);
        
                    // Load nhi·ªám v·ª• h·∫±ng ng√†y
                    await checkAndResetQuests(uid);
                } catch (error) {
                    console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
                }
            };

            // Kh·ªüi t·∫°o nhi·ªám v·ª• h·∫±ng ng√†y
            const initializeDailyQuests = () => {
                const quests = dailyQuestTemplates.map(template => ({
                    ...template,
                    progress: 0,
                    completed: false,
                    claimed: false
                }));
                return quests;
            };

            // Ki·ªÉm tra v√† reset nhi·ªám v·ª• n·∫øu qua ng√†y m·ªõi
            const checkAndResetQuests = async (uid) => {
                try {
                    const questDoc = await db.collection('users').doc(uid).collection('quests').doc('daily').get();
        
                    if (questDoc.exists) {
                        const questData = questDoc.data();
                        const lastReset = questData.lastReset ? questData.lastReset.toDate() : new Date(0);
                        const today = new Date();
            
                        // Ki·ªÉm tra xem ƒë√£ qua ng√†y m·ªõi ch∆∞a
                        if (lastReset.toDateString() !== today.toDateString()) {
                            // Reset nhi·ªám v·ª•
                            const newQuests = initializeDailyQuests();
                            await db.collection('users').doc(uid).collection('quests').doc('daily').set({
                                quests: newQuests,
                                lastReset: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            setDailyQuests(newQuests);
                            setLastQuestReset(today);
                        } else {
                            // Load nhi·ªám v·ª• hi·ªán t·∫°i
                            setDailyQuests(questData.quests || []);
                            setLastQuestReset(lastReset);
                        }
                    } else {
                        // T·∫°o nhi·ªám v·ª• l·∫ßn ƒë·∫ßu
                        const newQuests = initializeDailyQuests();
                        await db.collection('users').doc(uid).collection('quests').doc('daily').set({
                            quests: newQuests,
                            lastReset: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        setDailyQuests(newQuests);
                        setLastQuestReset(new Date());
                    }
                } catch (error) {
                    console.error('L·ªói khi ki·ªÉm tra nhi·ªám v·ª•:', error);
                }
            };

            // C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô nhi·ªám v·ª•
            const updateQuestProgress = async (questType, amount = 1, rarityName = '') => {
                if (!userId || dailyQuests.length === 0) return;
    
                let updated = false;
                const newQuests = dailyQuests.map(quest => {
                    if (quest.completed) return quest;
        
                    let shouldUpdate = false;
        
                    switch (quest.type) {
                        case 'catch':
                            shouldUpdate = questType === 'catch';
                            break;
                        case 'catch_rare':
                            shouldUpdate = questType === 'catch' && ['Rare', 'Legendary', 'Mythic', 'Secret'].includes(rarityName);
                            break;
                        case 'catch_legendary':
                            shouldUpdate = questType === 'catch' && ['Legendary', 'Mythic', 'Secret'].includes(rarityName);
                            break;
                        case 'solve':
                            shouldUpdate = questType === 'solve';
                            break;
                        case 'earn':
                            shouldUpdate = questType === 'earn';
                            break;
                    }
        
                    if (shouldUpdate) {
                        updated = true;
                        const newProgress = Math.min(quest.progress + amount, quest.target);
                        return {
                            ...quest,
                            progress: newProgress,
                            completed: newProgress >= quest.target
                        };
                    }
        
                    return quest;
                });
    
                if (updated) {
                    setDailyQuests(newQuests);
        
                    // L∆∞u v√†o Firebase
                    try {
                        await db.collection('users').doc(userId).collection('quests').doc('daily').update({
                            quests: newQuests
                        });
                    } catch (error) {
                        console.error('L·ªói khi c·∫≠p nh·∫≠t nhi·ªám v·ª•:', error);
                    }
                }
            };

            // Nh·∫≠n th∆∞·ªüng nhi·ªám v·ª•
            const claimQuestReward = async (questId) => {
                const quest = dailyQuests.find(q => q.id === questId);
    
                if (!quest || !quest.completed || quest.claimed) {
                    return;
                }
    
                const newMoney = money + quest.reward;
                const newQuests = dailyQuests.map(q => 
                    q.id === questId ? { ...q, claimed: true } : q
                );
    
                setMoney(newMoney);
                setDailyQuests(newQuests);
    
                try {
                    await db.collection('users').doc(userId).update({ money: newMoney });
                    await db.collection('users').doc(userId).collection('quests').doc('daily').update({
                        quests: newQuests
                    });
        
                    setMessage(`üéâ ƒê√£ nh·∫≠n th∆∞·ªüng ${quest.reward} xu!`);
                    setTimeout(() => setMessage(''), 3000);
                } catch (error) {
                    console.error('L·ªói khi nh·∫≠n th∆∞·ªüng:', error);
                }
            };

            const saveGameData = async () => {
                if (!userId) return;
                try {
                    await db.collection('users').doc(userId).set({
                        money,
                        fishingRod,
                        ownedRods,
                        currentBait,
                        ownedBaits,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                } catch (error) {
                    console.error('L·ªói khi l∆∞u:', error);
                }
            };

            const loadLeaderboard = async () => {
               setLoadingLeaderboard(true);
               try {
                   // L·∫•y d·ªØ li·ªáu t·∫•t c·∫£ ng∆∞·ªùi ch∆°i
                   const usersSnapshot = await db.collection('users').get();
                   const leaderboard = [];

                   for (const userDoc of usersSnapshot.docs) {
                       const userData = userDoc.data();
            
                       // ƒê·∫øm s·ªë c√° c·ªßa ng∆∞·ªùi ch∆°i
                       const inventorySnapshot = await db.collection('users')
                           .doc(userDoc.id)
                           .collection('inventory')
                           .get();
            
                       const fishCount = inventorySnapshot.size;
            
                       leaderboard.push({
                           id: userDoc.id,
                           email: userData.email || 'Anonymous',
                           money: userData.money || 0,
                           fishCount: fishCount
                       });
                   }

                   setLeaderboardData(leaderboard);
               } catch (error) {
                   console.error('L·ªói khi t·∫£i b·∫£ng x·∫øp h·∫°ng:', error);
               } finally {
                   setLoadingLeaderboard(false);
               }
           };

            const handleRegister = async () => {
                if (!email.trim() || !email.includes('@')) {
                    alert('Vui l√≤ng nh·∫≠p email h·ª£p l·ªá!');
                    return;
                }
                if (!password || password.length < 6) {
                    alert('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!');
                    return;
                }
                if (password !== confirmPassword) {
                    alert('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!');
                    return;
                }

                setLoading(true);
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    await db.collection('users').doc(user.uid).set({
                        email: user.email,
                        money: 0,
                        fishingRod: 'normal',
                        ownedRods: ['normal'],
                        currentBait: 'normal',
                        ownedBaits: ['normal'],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    alert('ƒêƒÉng k√Ω th√†nh c√¥ng!');
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        alert('Email n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!');
                    } else {
                        alert('L·ªói ƒëƒÉng k√Ω: ' + error.message);
                    }
                } finally {
                    setLoading(false);
                }
            };

            const handleLogin = async () => {
                if (!email.trim() || !password) {
                    alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                    return;
                }

                setLoading(true);
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    if (error.code === 'auth/user-not-found') {
                        alert('T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i!');
                    } else if (error.code === 'auth/wrong-password') {
                        alert('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
                    } else {
                        alert('L·ªói ƒëƒÉng nh·∫≠p: ' + error.message);
                    }
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                if (window.confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                    await saveGameData();
                    await auth.signOut();
                    setUserId(null);
                    setCurrentUser(null);
                    setMoney(0);
                    setInventory([]);
                    setEmail('');
                    setPassword('');
                    setConfirmPassword('');
                    setLoginMode('login');
                    setGameState('login');
                }
            };

            const getRandomRarity = () => {
                let availableRarities = [...rarities];
                
                if (fishingRod === 'normal') {
                    availableRarities = rarities.filter(r => 
                        !['Legendary', 'Mythic', 'Secret'].includes(r.name)
                    );
                } else if (fishingRod === 'legendary') {
                    availableRarities = rarities.filter(r => 
                        !['Mythic', 'Secret'].includes(r.name)
                    );
                } else if (fishingRod === 'mythic') {
                    availableRarities = rarities.filter(r => 
                        r.name !== 'Secret'
                    );
                }
                
                const totalWeight = availableRarities.reduce((sum, r) => sum + r.weight, 0);
                let random = Math.random() * totalWeight;
                
                for (let rarity of availableRarities) {
                    random -= rarity.weight;
                    if (random <= 0) return rarity;
                }
                return availableRarities[0];
            };

            const calculateWeight = () => {
                let weight = 1.0;
                let increaseChance = 1.0;
                
                while (Math.random() < increaseChance) {
                    weight += 0.1;
                    increaseChance -= 0.001;
                }
                
                return Math.round(weight * 10) / 10;
            };

            const generateMath = (range, rarity) => {
                const difficultyReduction = baitInfo[currentBait].difficulty[rarity] || 0;
                const adjustedRange = Math.max(5, Math.round(range * (1 - difficultyReduction / 100)));
                
                const operations = ['+', '-'];
                const op = operations[Math.floor(Math.random() * operations.length)];
                const num1 = Math.floor(Math.random() * adjustedRange) + 1;
                const num2 = Math.floor(Math.random() * adjustedRange) + 1;
                
                const question = `${num1} ${op} ${num2}`;
                const correctAnswer = op === '+' ? num1 + num2 : num1 - num2;
                
                return { question, correctAnswer };
            };

            const startFishing = () => {
                setGameState('fishing');
                setMessage('');
                
                setTimeout(() => {
                    const rarity = getRandomRarity();
                    const fishName = fishNames[rarity.name][Math.floor(Math.random() * fishNames[rarity.name].length)];
                    const weight = calculateWeight();
                    const math = generateMath(rarity.range, rarity.name);
                    const fishPrice = Math.round(rarity.price * weight);
                    
                    setCurrentFish({
                        rarity: rarity.name,
                        name: fishName,
                        weight: weight,
                        color: rarity.color,
                        math: math,
                        time: rarity.time,
                        price: fishPrice,
                        favourite: false
                    });
                    
                    setTimeLeft(rarity.time);
                    setGameState('question');
                }, 1500);
            };

            useEffect(() => {
                if (gameState === 'question' && timeLeft > 0) {
                    const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
                    return () => clearTimeout(timer);
                } else if (gameState === 'question' && timeLeft === 0) {
                    handleTimeout();
                }
            }, [timeLeft, gameState]);

            const handleTimeout = () => {
                setMessage('H·ª•t m·∫•t r·ªìi!');
                setGameState('result');
                setTimeout(() => {
                    setGameState('menu');
                    setAnswer('');
                }, 2000);
            };

            const checkAnswer = async () => {
                const userAnswer = parseInt(answer);
    
                if (userAnswer === currentFish.math.correctAnswer) {
                    try {
                        // C·∫≠p nh·∫≠t nhi·ªám v·ª• gi·∫£i to√°n
                        await updateQuestProgress('solve', 1);
            
                        // C·∫≠p nh·∫≠t nhi·ªám v·ª• c√¢u c√°
                        await updateQuestProgress('catch', 1, currentFish.rarity);
            
                        await db.collection('users').doc(userId).collection('inventory').add({
                            name: currentFish.name,
                            rarity: currentFish.rarity,
                            weight: currentFish.weight,
                            price: currentFish.price,
                            color: currentFish.color,
                            favourite: false,
                            caughtAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        setMessage(`Ch√∫c m·ª´ng! B·∫°n ƒë√£ c√¢u ƒë∆∞·ª£c ${currentFish.name} n·∫∑ng ${currentFish.weight}kg (${currentFish.rarity})`);
            
                        await loadGameData(userId);
            
                        setGameState('result');
                        setTimeout(() => {
                            setGameState('menu');
                            setAnswer('');
                        }, 3000);
                    } catch (error) {
                        alert('L·ªói khi l∆∞u c√°: ' + error.message);
                    }
                } else {
                    setMessage('H·ª•t m·∫•t r·ªìi!');
                    setGameState('result');
                    setTimeout(() => {
                        setGameState('menu');
                        setAnswer('');
                    }, 2000);
                }
            };

            const toggleFavourite = async (fishId, currentFavourite) => {
                try {
                    await db.collection('users').doc(userId).collection('inventory').doc(fishId).update({
                        favourite: !currentFavourite
                    });

                    const newInventory = inventory.map(fish => 
                        fish.id === fishId ? { ...fish, favourite: !currentFavourite } : fish
                    );
                    setInventory(newInventory);
                } catch (error) {
                    alert('L·ªói khi c·∫≠p nh·∫≠t: ' + error.message);
                }
            };

            const sellFish = async () => {
                const fishToSell = inventory.filter(fish => !fish.favourite);
                const totalMoney = fishToSell.reduce((sum, fish) => sum + fish.price, 0);
    
                try {
                    const batch = db.batch();
                    fishToSell.forEach(fish => {
                        const fishRef = db.collection('users').doc(userId).collection('inventory').doc(fish.id);
                        batch.delete(fishRef);
                    });
                    await batch.commit();

                    const newMoney = money + totalMoney;
                    setMoney(newMoney);
                    await db.collection('users').doc(userId).update({ money: newMoney });
        
                    // C·∫≠p nh·∫≠t nhi·ªám v·ª• ki·∫øm ti·ªÅn
                    await updateQuestProgress('earn', totalMoney);

                    setInventory(inventory.filter(fish => fish.favourite));
                    setShowSellConfirm(false);
        
                    if (fishToSell.length > 0) {
                        setMessage(`ƒê√£ b√°n ${fishToSell.length} con c√° v√† nh·∫≠n ƒë∆∞·ª£c ${totalMoney} xu!`);
                        setTimeout(() => setMessage(''), 3000);
                    }
                } catch (error) {
                    alert('L·ªói khi b√°n c√°: ' + error.message);
                }
            };

            const buyRod = async (item) => {
                if (money < item.price) {
                    alert('B·∫°n kh√¥ng ƒë·ªß ti·ªÅn ƒë·ªÉ mua c·∫ßn c√¢u n√†y!');
                    return;
                }

                if (ownedRods.includes(item.unlocks)) {
                    alert('B·∫°n ƒë√£ c√≥ c·∫ßn c√¢u n√†y r·ªìi!');
                    return;
                }

                const newMoney = money - item.price;
                const newOwnedRods = [...ownedRods, item.unlocks];

                setMoney(newMoney);
                setOwnedRods(newOwnedRods);
                
                await db.collection('users').doc(userId).update({
                    money: newMoney,
                    ownedRods: newOwnedRods
                });

                setMessage(`‚úÖ ƒê√£ mua ${item.name} th√†nh c√¥ng! V√†o Balo ƒë·ªÉ trang b·ªã.`);
                setTimeout(() => setMessage(''), 3000);
            };

            const buyBait = async (baitType) => {
                const bait = baitInfo[baitType];
                
                if (money < bait.price) {
                    alert('B·∫°n kh√¥ng ƒë·ªß ti·ªÅn ƒë·ªÉ mua m·ªìi n√†y!');
                    return;
                }

                if (ownedBaits.includes(baitType)) {
                    alert('B·∫°n ƒë√£ c√≥ m·ªìi n√†y r·ªìi!');
                    return;
                }

                const newMoney = money - bait.price;
                const newOwnedBaits = [...ownedBaits, baitType];

                setMoney(newMoney);
                setOwnedBaits(newOwnedBaits);
                
                await db.collection('users').doc(userId).update({
                    money: newMoney,
                    ownedBaits: newOwnedBaits
                });

                setMessage(`‚úÖ ƒê√£ mua ${bait.name} th√†nh c√¥ng! V√†o Balo ƒë·ªÉ trang b·ªã.`);
                setTimeout(() => setMessage(''), 3000);
            };

            const equipRod = async (rodType) => {
                setFishingRod(rodType);
                await db.collection('users').doc(userId).update({ fishingRod: rodType });
                setMessage(`‚úÖ ƒê√£ trang b·ªã ${getRodNameByType(rodType)}!`);
                setTimeout(() => setMessage(''), 2000);
            };

            const equipBait = async (baitType) => {
                setCurrentBait(baitType);
                await db.collection('users').doc(userId).update({ currentBait: baitType });
                setMessage(`‚úÖ ƒê√£ trang b·ªã ${baitInfo[baitType].name}!`);
                setTimeout(() => setMessage(''), 2000);
            };

            const getRodName = () => {
                return getRodNameByType(fishingRod);
            };

            const getRodNameByType = (type) => {
                switch(type) {
                    case 'legendary': return 'New Rank Fish!';
                    case 'mythic': return 'Mythical Fishing Rod';
                    case 'secret': return 'Mysterious Fishing Rod';
                    default: return 'Normal Rod';
                }
            };

            const getRodDescription = (type) => {
                switch(type) {
                    case 'legendary': return 'C√¢u ƒë∆∞·ª£c c√° ƒë·∫øn Legendary';
                    case 'mythic': return 'C√¢u ƒë∆∞·ª£c c√° ƒë·∫øn Mythic';
                    case 'secret': return 'C√¢u ƒë∆∞·ª£c t·∫•t c·∫£ lo·∫°i c√°';
                    default: return 'C·∫ßn c√¢u c∆° b·∫£n';
                }
            };

            const getRodColor = (type) => {
                switch(type) {
                    case 'legendary': return '#22C55E';
                    case 'mythic': return '#EF4444';
                    case 'secret': return '#1F2937';
                    default: return '#9CA3AF';
                }
            };

            if (configError) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-red-600 to-red-800">
                        <div className="bg-white rounded-xl shadow-2xl p-12 max-w-2xl w-full mx-4">
                            <h1 className="text-4xl font-bold text-center mb-6 text-red-600">‚ö†Ô∏è C·∫•u h√¨nh Firebase</h1>
                            <div className="bg-red-50 border-2 border-red-300 rounded-lg p-6 mb-6">
                                <p className="text-lg text-red-800 mb-4">
                                    B·∫°n c·∫ßn c·∫•u h√¨nh Firebase tr∆∞·ªõc khi s·ª≠ d·ª•ng game!
                                </p>
                                <ol className="text-sm text-red-700 space-y-2 ml-4">
                                    <li><strong>1.</strong> Truy c·∫≠p <a href="https://console.firebase.google.com" target="_blank" className="text-blue-600 underline">Firebase Console</a></li>
                                    <li><strong>2.</strong> T·∫°o project m·ªõi ho·∫∑c ch·ªçn project c√≥ s·∫µn</li>
                                    <li><strong>3.</strong> V√†o <strong>Project Settings</strong> ‚Üí <strong>Your apps</strong> ‚Üí Ch·ªçn Web app</li>
                                    <li><strong>4.</strong> Copy Firebase config v√† thay th·∫ø v√†o code</li>
                                    <li><strong>5.</strong> B·∫≠t <strong>Authentication</strong> (Email/Password)</li>
                                    <li><strong>6.</strong> B·∫≠t <strong>Firestore Database</strong></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'login') {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 to-purple-800">
                        <div className="bg-white rounded-xl shadow-2xl p-12 max-w-md w-full mx-4">
                            <h1 className="text-4xl font-bold text-center mb-8 text-gray-800">üé£ Game C√¢u C√° 2D</h1>
                            <p className="text-center text-sm text-green-600 font-semibold mb-4">‚úÖ S·ª≠ d·ª•ng Firebase</p>
                            
                            {loading ? (
                                <div className="text-center text-gray-600 text-lg py-8">ƒêang x·ª≠ l√Ω...</div>
                            ) : (
                                <>
                                    <div className="flex gap-2 mb-6">
                                        <button
                                            onClick={() => setLoginMode('login')}
                                            className={`flex-1 py-3 rounded-lg font-bold transition ${
                                                loginMode === 'login' 
                                                    ? 'bg-blue-600 text-white' 
                                                    : 'bg-gray-300 text-gray-700'
                                            }`}
                                        >
                                            ƒêƒÉng nh·∫≠p
                                        </button>
                                        <button
                                            onClick={() => setLoginMode('register')}
                                            className={`flex-1 py-3 rounded-lg font-bold transition ${
                                                loginMode === 'register' 
                                                    ? 'bg-blue-600 text-white' 
                                                    : 'bg-gray-300 text-gray-700'
                                            }`}
                                        >
                                            ƒêƒÉng k√Ω
                                        </button>
                                    </div>

                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder="Email"
                                        className="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-purple-600"
                                    />
                                    
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        placeholder="M·∫≠t kh·∫©u"
                                        className="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-purple-600"
                                    />

                                    {loginMode === 'register' && (
                                        <input
                                            type="password"
                                            value={confirmPassword}
                                            onChange={(e) => setConfirmPassword(e.target.value)}
                                            placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u"
                                            className="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-purple-600"
                                        />
                                    )}

                                    <button
                                        onClick={loginMode === 'login' ? handleLogin : handleRegister}
                                        className="w-full py-3 bg-blue-600 text-white text-xl font-bold rounded-lg hover:bg-blue-700 transition mb-4"
                                    >
                                        {loginMode === 'login' ? 'üéÆ ƒêƒÉng nh·∫≠p' : 'üìù ƒêƒÉng k√Ω'}
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                );
            }

            if (showInventory) {
                return (
                    <div className="min-h-screen bg-gradient-to-b from-blue-400 to-blue-600 p-8">
                        <div className="fixed top-4 right-4 bg-yellow-400 px-6 py-3 rounded-lg shadow-lg z-50">
                            <p className="text-2xl font-bold text-gray-800">üí∞ {money} xu</p>
                        </div>
                        
                        <div className="max-w-6xl mx-auto">
                            <div className="bg-white rounded-lg shadow-2xl p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-3xl font-bold text-gray-800">üéí Balo</h2>
                                    <button
                                        onClick={() => {
                                            setShowInventory(false);
                                            setInventoryTab('fish');
                                        }}
                                        className="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
                                    >
                                        Quay l·∫°i
                                    </button>
                                </div>

                                <div className="flex gap-2 mb-6">
                                    <button
                                        onClick={() => setInventoryTab('fish')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition ${
                                            inventoryTab === 'fish' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-300 text-gray-700'
                                        }`}
                                    >
                                        üêü C√° ({inventory.length})
                                    </button>
                                    <button
                                        onClick={() => setInventoryTab('rods')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition ${
                                            inventoryTab === 'rods' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-300 text-gray-700'
                                        }`}
                                    >
                                        üé£ C·∫ßn c√¢u ({ownedRods.length})
                                    </button>
                                    <button
                                        onClick={() => setInventoryTab('baits')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition ${
                                            inventoryTab === 'baits' 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-300 text-gray-700'
                                        }`}
                                    >
                                        ü™± M·ªìi c√¢u ({ownedBaits.length})
                                    </button>
                                </div>
                                
                                {inventoryTab === 'fish' ? (
                                    <div>
                                        {inventory.length === 0 ? (
                                            <p className="text-center text-gray-500 text-xl py-12">Ch∆∞a c√≥ c√° n√†o trong balo!</p>
                                        ) : (
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                {inventory.map((fish) => (
                                                    <div
                                                        key={fish.id}
                                                        className="border-4 rounded-lg p-4 relative"
                                                        style={{ borderColor: fish.color }}
                                                    >
                                                        <button
                                                            onClick={() => toggleFavourite(fish.id, fish.favourite)}
                                                            className="absolute top-2 right-2 text-3xl hover:scale-110 transition"
                                                        >
                                                            {fish.favourite ? '‚≠ê' : '‚òÜ'}
                                                        </button>
                                                        
                                                        <div className="flex items-center gap-3 mb-2">
                                                            <FishIcon size={32} color={fish.color} />
                                                            <h3 className="text-xl font-bold" style={{ color: fish.color }}>
                                                                {fish.name}
                                                            </h3>
                                                        </div>
                                                        <div className="space-y-1 text-gray-700">
                                                            <p><strong>ƒê·ªô hi·∫øm:</strong> {fish.rarity}</p>
                                                            <p><strong>C√¢n n·∫∑ng:</strong> {fish.weight} kg</p>
                                                            <p><strong>Gi√° tr·ªã:</strong> {fish.price} xu</p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ) : inventoryTab === 'rods' ? (
                                    <div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            {ownedRods.map((rodType, index) => (
                                                <div
                                                    key={index}
                                                    className="border-4 rounded-lg p-6 relative"
                                                    style={{ borderColor: getRodColor(rodType) }}
                                                >
                                                    {fishingRod === rodType && (
                                                        <div className="absolute top-2 right-2 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                                                            ‚úì ƒêang d√πng
                                                        </div>
                                                    )}
                                                    
                                                    <div className="text-center mb-4">
                                                        <div className="text-5xl mb-2">üé£</div>
                                                        <h3 className="text-xl font-bold mb-2" style={{ color: getRodColor(rodType) }}>
                                                            {getRodNameByType(rodType)}
                                                        </h3>
                                                        <p className="text-gray-600 text-sm mb-4">
                                                            {getRodDescription(rodType)}
                                                        </p>
                                                    </div>
                                                    
                                                    {fishingRod !== rodType && (
                                                        <button
                                                            onClick={() => equipRod(rodType)}
                                                            className="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                                        >
                                                            Trang b·ªã
                                                        </button>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : (
                                    <div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            {ownedBaits.map((baitType, index) => {
                                                const bait = baitInfo[baitType];
                                                return (
                                                    <div
                                                        key={index}
                                                        className="border-4 rounded-lg p-6 relative"
                                                        style={{ borderColor: bait.color }}
                                                    >
                                                        {currentBait === baitType && (
                                                            <div className="absolute top-2 right-2 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                                                                ‚úì ƒêang d√πng
                                                            </div>
                                                        )}
                                                        
                                                        <div className="text-center mb-4">
                                                            <div className="text-5xl mb-2">{bait.icon}</div>
                                                            <h3 className="text-xl font-bold mb-2" style={{ color: bait.color }}>
                                                                {bait.name}
                                                            </h3>
                                                            <p className="text-gray-600 text-sm mb-4">
                                                                {bait.description}
                                                            </p>
                                                        </div>
                                                        
                                                        {currentBait !== baitType && (
                                                            <button
                                                                onClick={() => equipBait(baitType)}
                                                                className="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                                            >
                                                                Trang b·ªã
                                                            </button>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            if (showShop) {
                return (
                    <div className="min-h-screen bg-gradient-to-b from-purple-400 to-purple-600 p-8">
                        <div className="fixed top-4 right-4 bg-yellow-400 px-6 py-3 rounded-lg shadow-lg z-50">
                            <p className="text-2xl font-bold text-gray-800">üí∞ {money} xu</p>
                        </div>
                        
                        <div className="max-w-6xl mx-auto">
                            <div className="bg-white rounded-lg shadow-2xl p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-3xl font-bold text-gray-800">ü™ù C·ª≠a H√†ng</h2>
                                    <button
                                        onClick={() => setShowShop(false)}
                                        className="px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition"
                                    >
                                        Quay l·∫°i
                                    </button>
                                </div>

                                <div className="flex gap-2 mb-6">
                                    <button
                                        onClick={() => setShopTab('rods')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition ${
                                            shopTab === 'rods' 
                                                ? 'bg-purple-600 text-white' 
                                                : 'bg-gray-300 text-gray-700'
                                        }`}
                                    >
                                        üé£ C·∫ßn C√¢u
                                    </button>
                                    <button
                                        onClick={() => setShopTab('baits')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition ${
                                            shopTab === 'baits' 
                                                ? 'bg-purple-600 text-white' 
                                                : 'bg-gray-300 text-gray-700'
                                        }`}
                                    >
                                        ü™± M·ªìi C√¢u
                                    </button>
                                </div>

                                <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                                    <p className="text-lg font-semibold text-blue-900">
                                        üé£ C·∫ßn c√¢u: <span className="text-blue-600">{getRodName()}</span>
                                        <span className="mx-2">|</span>
                                        ü™± M·ªìi: <span className="text-green-600">{baitInfo[currentBait].name}</span>
                                    </p>
                                </div>
                                
                                {shopTab === 'rods' ? (
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        {shopItems.map((item) => {
                                            const isOwned = ownedRods.includes(item.unlocks);
                                            
                                            return (
                                                <div
                                                    key={item.id}
                                                    className="border-4 border-gray-300 rounded-lg p-6 relative bg-gradient-to-b from-white to-gray-50"
                                                >
                                                    {isOwned && (
                                                        <div className="absolute top-2 right-2 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                                                            ‚úì ƒê√£ mua
                                                        </div>
                                                    )}
                                                    
                                                    <div className="text-center mb-4">
                                                        <div className="text-5xl mb-3">üé£</div>
                                                    </div>
                                                    
                                                    <h3 className="text-2xl font-bold mb-2 text-gray-800">
                                                        {item.name}
                                                    </h3>
                                                    <p className="text-gray-600 mb-4 min-h-12">
                                                        {item.description}
                                                    </p>
                                                    <p className="text-3xl font-bold text-yellow-600 mb-4">
                                                        üí∞ {item.price} xu
                                                    </p>
                                                    <button
                                                        onClick={() => buyRod(item)}
                                                        disabled={isOwned || money < item.price}
                                                        className={`w-full py-3 text-white text-lg font-bold rounded-lg transition ${item.color} disabled:bg-gray-400 disabled:cursor-not-allowed`}
                                                    >
                                                        {isOwned ? 'ƒê√£ s·ªü h·ªØu' : money < item.price ? 'Kh√¥ng ƒë·ªß ti·ªÅn' : 'Mua ngay'}
                                                    </button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        {Object.entries(baitInfo).filter(([key]) => key !== 'normal').map(([baitType, bait]) => {
                                            const isOwned = ownedBaits.includes(baitType);
                                            
                                            return (
                                                <div
                                                    key={baitType}
                                                    className="border-4 rounded-lg p-6 relative bg-gradient-to-b from-white to-gray-50"
                                                    style={{ borderColor: bait.color }}
                                                >
                                                    {isOwned && (
                                                        <div className="absolute top-2 right-2 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                                                            ‚úì ƒê√£ mua
                                                        </div>
                                                    )}
                                                    
                                                    <div className="text-center mb-4">
                                                        <div className="text-6xl mb-3">{bait.icon}</div>
                                                        <h3 className="text-2xl font-bold mb-2" style={{ color: bait.color }}>
                                                            {bait.name}
                                                        </h3>
                                                        <p className="text-gray-600 mb-4 min-h-12">
                                                            {bait.description}
                                                        </p>
                                                    </div>
                                                    
                                                    <div className="mb-4 text-sm text-gray-700">
                                                        <p className="font-bold mb-2">Gi·∫£m ƒë·ªô kh√≥:</p>
                                                        <div className="space-y-1">
                                                            <p>Common: {bait.difficulty.Common}%</p>
                                                            <p>Uncommon: {bait.difficulty.Uncommon}%</p>
                                                            <p>Rare: {bait.difficulty.Rare}%</p>
                                                            <p>Legendary: {bait.difficulty.Legendary}%</p>
                                                            <p>Mythic: {bait.difficulty.Mythic}%</p>
                                                            <p>Secret: {bait.difficulty.Secret}%</p>
                                                        </div>
                                                    </div>

                                                    <p className="text-3xl font-bold text-yellow-600 mb-4">
                                                        üí∞ {bait.price} xu
                                                    </p>
                                                    <button
                                                        onClick={() => buyBait(baitType)}
                                                        disabled={isOwned || money < bait.price}
                                                        className="w-full py-3 text-white text-lg font-bold rounded-lg transition bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                                                    >
                                                        {isOwned ? 'ƒê√£ s·ªü h·ªØu' : money < bait.price ? 'Kh√¥ng ƒë·ªß ti·ªÅn' : 'Mua ngay'}
                                                    </button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            if (showLeaderboard) {
                const sortedData = leaderboardTab === 'fish' 
                    ? [...leaderboardData].sort((a, b) => b.fishCount - a.fishCount)
                    : [...leaderboardData].sort((a, b) => b.money - a.money);

                return (
                    <div className="min-h-screen bg-gradient-to-b from-yellow-400 to-orange-600 p-8">
                        <div className="fixed top-4 right-4 bg-yellow-400 px-6 py-3 rounded-lg shadow-lg z-50">
                            <p className="text-2xl font-bold text-gray-800">üí∞ {money} xu</p>
                        </div>
            
                        <div className="max-w-4xl mx-auto">
                            <div className="bg-white rounded-lg shadow-2xl p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-3xl font-bold text-gray-800">üèÜ B·∫£ng X·∫øp H·∫°ng</h2>
                                    <button
                                        onClick={() => setShowLeaderboard(false)}
                                        className="px-6 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition"
                                    >
                                        Quay l·∫°i
                                    </button>
                                </div>

                                <div className="flex gap-2 mb-6">
                                    <button
                                        onClick={() => setLeaderboardTab('fish')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition ${
                                            leaderboardTab === 'fish' 
                                                ? 'bg-blue-600 text-white' 
                                    :             'bg-gray-300 text-gray-700'
                                        }`}
                                    >
                                        üêü S·ªë C√° C√¢u ƒê∆∞·ª£c
                                    </button>
                                    <button
                                        onClick={() => setLeaderboardTab('money')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition ${
                                            leaderboardTab === 'money' 
                                                ? 'bg-yellow-600 text-white' 
                                                : 'bg-gray-300 text-gray-700'
                                        }`}
                                    >
                                        üí∞ S·ªë Ti·ªÅn
                                    </button>
                                </div>

                                <button
                                    onClick={loadLeaderboard}
                                    disabled={loadingLeaderboard}
                                    className="w-full mb-4 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition disabled:bg-gray-400"
                                >
                                    {loadingLeaderboard ? '‚è≥ ƒêang t·∫£i...' : 'üîÑ L√†m m·ªõi'}
                                </button>

                                {loadingLeaderboard ? (
                                    <div className="text-center text-gray-500 text-xl py-12">
                                        ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng...
                                    </div>
                                ) : sortedData.length === 0 ? (
                                    <div className="text-center text-gray-500 text-xl py-12">
                                        Ch∆∞a c√≥ d·ªØ li·ªáu
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {sortedData.map((player, index) => {
                                            const isCurrentUser = player.id === userId;
                                            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                                
                                            return (
                                                <div
                                                    key={player.id}
                                                    className={`flex items-center justify-between p-4 rounded-lg border-2 ${
                                                        isCurrentUser 
                                                            ? 'bg-blue-50 border-blue-500' 
                                                            : 'bg-gray-50 border-gray-200'
                                                    }`}
                                                >
                                                    <div className="flex items-center gap-4">
                                                        <span className="text-3xl font-bold w-12 text-center">
                                                            {medal}
                                                        </span>
                                                        <div>
                                                            <p className="font-bold text-lg text-gray-800">
                                                                {player.email}
                                                                {isCurrentUser && (
                                                                    <span className="ml-2 text-sm bg-blue-500 text-white px-2 py-1 rounded">
                                                                        B·∫°n
                                                                    </span>
                                                                )}
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        {leaderboardTab === 'fish' ? (
                                                            <p className="text-2xl font-bold text-blue-600">
                                                                üêü {player.fishCount}
                                                            </p>
                                                        ) : (
                                                            <p className="text-2xl font-bold text-yellow-600">
                                                                üí∞ {player.money} xu
                                                            </p>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            if (showQuests) {
                const completedCount = dailyQuests.filter(q => q.completed).length;
                const claimedCount = dailyQuests.filter(q => q.claimed).length;
    
                return (
                    <div className="min-h-screen bg-gradient-to-b from-indigo-400 to-indigo-600 p-8">
                        <div className="fixed top-4 right-4 bg-yellow-400 px-6 py-3 rounded-lg shadow-lg z-50">
                            <p className="text-2xl font-bold text-gray-800">üí∞ {money} xu</p>
                        </div>
            
                        <div className="max-w-4xl mx-auto">
                            <div className="bg-white rounded-lg shadow-2xl p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <div>
                                        <h2 className="text-3xl font-bold text-gray-800">üìã Nhi·ªám V·ª• H·∫±ng Ng√†y</h2>
                                        <p className="text-sm text-gray-600 mt-1">
                                            Ho√†n th√†nh: {completedCount}/{dailyQuests.length} | 
                                            ƒê√£ nh·∫≠n th∆∞·ªüng: {claimedCount}/{dailyQuests.length}
                                        </p>
                                    </div>
                                    <button
                                        onClick={() => setShowQuests(false)}
                                        className="px-6 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition"
                                    >
                                        Quay l·∫°i
                                    </button>
                                </div>

                                {dailyQuests.length === 0 ? (
                                    <div className="text-center text-gray-500 text-xl py-12">
                                        ƒêang t·∫£i nhi·ªám v·ª•...
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {dailyQuests.map((quest) => {
                                            const progressPercent = Math.min((quest.progress / quest.target) * 100, 100);
                                
                                            return (
                                                <div
                                                    key={quest.id}
                                                    className={`border-2 rounded-lg p-6 transition ${
                                                        quest.completed 
                                                            ? 'bg-green-50 border-green-500' 
                                                            : 'bg-gray-50 border-gray-300'
                                                    }`}
                                                >
                                                    <div className="flex items-start justify-between mb-3">
                                                        <div className="flex items-center gap-3">
                                                            <span className="text-4xl">{quest.icon}</span>
                                                            <div>
                                                                <h3 className="text-xl font-bold text-gray-800">
                                                                    {quest.title}
                                                                </h3>
                                                                <p className="text-gray-600">
                                                                    {quest.description.replace('{target}', quest.target)}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className="text-2xl font-bold text-yellow-600">
                                                                +{quest.reward} xu
                                                            </p>
                                                        </div>
                                                    </div>
                                        
                                                    <div className="mb-3">
                                                        <div className="flex justify-between items-center mb-1">
                                                            <span className="text-sm text-gray-600">
                                                                Ti·∫øn ƒë·ªô: {quest.progress}/{quest.target}
                                                            </span>
                                                            <span className="text-sm font-semibold text-gray-700">
                                                                {progressPercent.toFixed(0)}%
                                                            </span>
                                                        </div>
                                                        <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                                            <div
                                                                className={`h-full rounded-full transition-all duration-500 ${
                                                                    quest.completed ? 'bg-green-500' : 'bg-blue-500'
                                                                }`}
                                                                style={{ width: `${progressPercent}%` }}
                                                            />
                                                        </div>
                                                    </div>
                                        
                                                    {quest.completed && !quest.claimed && (
                                                        <button
                                                            onClick={() => claimQuestReward(quest.id)}
                                                            className="w-full py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition animate-pulse"
                                                        >
                                                            üéÅ Nh·∫≠n th∆∞·ªüng
                                                        </button>
                                                    )}
                                        
                                                    {quest.claimed && (
                                                        <div className="w-full py-3 bg-gray-400 text-white font-bold rounded-lg text-center">
                                                            ‚úÖ ƒê√£ nh·∫≠n th∆∞·ªüng
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                    
                                {lastQuestReset && (
                                    <div className="mt-6 p-4 bg-blue-50 rounded-lg text-center">
                                        <p className="text-sm text-gray-600">
                                            ‚è∞ Nhi·ªám v·ª• s·∫Ω ƒë∆∞·ª£c l√†m m·ªõi v√†o 00:00 m·ªói ng√†y
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`min-h-screen flex items-center justify-center transition-all duration-500 ${
                    gameState === 'fishing' || gameState === 'question' 
                        ? 'bg-gradient-to-b from-blue-400 to-blue-600' 
                        : 'bg-gradient-to-b from-cyan-300 to-teal-400'
                }`}>
                    <div className="fixed top-4 left-4 bg-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3">
                        <span className="text-lg">üë§ <strong>{currentUser}</strong></span>
                        <button
                            onClick={handleLogout}
                            className="bg-red-500 text-white px-4 py-1 rounded-md text-sm hover:bg-red-600 transition"
                        >
                            ƒêƒÉng xu·∫•t
                        </button>
                    </div>

                    <div className="fixed top-4 right-4 bg-yellow-400 px-6 py-3 rounded-lg shadow-lg z-50">
                        <p className="text-2xl font-bold text-gray-800">üí∞ {money} xu</p>
                    </div>
                    
                    {message && gameState === 'menu' && (
                        <div className="fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
                            <p className="text-xl font-bold">{message}</p>
                        </div>
                    )}
                    
                    {showSellConfirm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-8 max-w-md mx-4">
                                <h3 className="text-2xl font-bold mb-4 text-gray-800">X√°c nh·∫≠n b√°n c√°</h3>
                                <p className="text-lg mb-6 text-gray-600">
                                    B·∫°n c√≥ {inventory.filter(f => !f.favourite).length} con c√° c√≥ th·ªÉ b√°n
                                    <br />
                                    <span className="text-sm text-gray-500">(C√° ƒë∆∞·ª£c ƒë√°nh d·∫•u ‚≠ê s·∫Ω kh√¥ng b·ªã b√°n)</span>
                                </p>
                                <div className="flex gap-4">
                                    <button
                                        onClick={sellFish}
                                        className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                                    >
                                        ƒê·ªìng √Ω
                                    </button>
                                    <button
                                        onClick={() => setShowSellConfirm(false)}
                                        className="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
                                    >
                                        H·ªßy
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <div className="text-center">
                        {gameState === 'menu' && (
                            <div className="space-y-6">
                                <h1 className="text-5xl font-bold text-white mb-8 drop-shadow-lg">
                                    üé£ Game C√¢u C√° 2D üé£
                                </h1>
                                <button
                                    onClick={startFishing}
                                    className="px-12 py-4 bg-blue-600 text-white text-2xl rounded-lg hover:bg-blue-700 transform hover:scale-105 transition shadow-lg"
                                >
                                    B·∫Øt ƒë·∫ßu c√¢u c√°
                                </button>
                                
                                <div className="flex gap-4 justify-center mt-6">
                                    <button
                                        onClick={() => setShowInventory(true)}
                                        className="px-8 py-3 bg-green-600 text-white text-xl rounded-lg hover:bg-green-700 transform hover:scale-105 transition shadow-lg flex items-center gap-2"
                                    >
                                        <PackageIcon size={24} />
                                        Balo ({inventory.length})
                                    </button>

                                    <button
                                        onClick={() => setShowQuests(true)}
                                        className="px-8 py-3 bg-indigo-600 text-white text-xl rounded-lg hover:bg-indigo-700 transform hover:scale-105 transition shadow-lg relative"
                                    >
                                        üìã Nhi·ªám v·ª•
                                        {dailyQuests.filter(q => q.completed && !q.claimed).length > 0 && (
                                            <span className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold animate-bounce">
                                                {dailyQuests.filter(q => q.completed && !q.claimed).length}
                                            </span>
                                        )}
                                    </button>

                                    <button
                                        onClick={() => {
                                            setShowLeaderboard(true);
                                            loadLeaderboard();
                                        }}
                                        className="px-8 py-3 bg-yellow-600 text-white text-xl rounded-lg hover:bg-yellow-700 transform hover:scale-105 transition shadow-lg"
                                    >
                                        üèÜ B·∫£ng x·∫øp h·∫°ng
                                    </button>
                                    
                                    <button
                                        onClick={() => setShowShop(true)}
                                        className="px-8 py-3 bg-purple-600 text-white text-xl rounded-lg hover:bg-purple-700 transform hover:scale-105 transition shadow-lg"
                                    >
                                        ü™ù C·ª≠a h√†ng
                                    </button>
                                    
                                    <button
                                        onClick={() => setShowSellConfirm(true)}
                                        disabled={inventory.filter(f => !f.favourite).length === 0}
                                        className="px-8 py-3 bg-orange-600 text-white text-xl rounded-lg hover:bg-orange-700 transform hover:scale-105 transition shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed disabled:hover:scale-100"
                                    >
                                        üíµ B√°n c√°
                                    </button>
                                </div>

                                <div className="mt-6 p-4 bg-white bg-opacity-50 rounded-lg space-y-2">
                                    <p className="text-lg font-semibold text-gray-800">
                                        üé£ C·∫ßn c√¢u: <span className="text-blue-600">{getRodName()}</span>
                                    </p>
                                    <p className="text-lg font-semibold text-gray-800">
                                        {baitInfo[currentBait].icon} M·ªìi: <span className="text-green-600">{baitInfo[currentBait].name}</span>
                                    </p>
                                </div>
                            </div>
                        )}

                        {gameState === 'fishing' && (
                            <div className="bg-white bg-opacity-90 rounded-lg p-12 shadow-2xl">
                                <h2 className="text-4xl font-bold text-blue-600 animate-pulse">
                                    C√° ƒë√£ c·∫Øn c√¢u! üé£
                                </h2>
                            </div>
                        )}

                        {gameState === 'question' && currentFish && (
                            <div className="bg-white rounded-lg p-8 shadow-2xl max-w-md">
                                <div className="mb-4 p-4 rounded-lg" style={{ backgroundColor: currentFish.color + '20' }}>
                                    <div className="flex justify-center mb-2">
                                        <FishIcon size={48} color={currentFish.color} />
                                    </div>
                                    <h2 className="text-2xl font-bold mb-2" style={{ color: currentFish.color }}>
                                        {currentFish.name}
                                    </h2>
                                    <p className="text-lg"><strong>ƒê·ªô hi·∫øm:</strong> {currentFish.rarity}</p>
                                    <p className="text-lg"><strong>C√¢n n·∫∑ng:</strong> {currentFish.weight} kg</p>
                                </div>

                                <div className="my-4 p-4 bg-gray-100 rounded-lg">
                                    <p className="text-sm text-purple-600 font-semibold mb-2">
                                        {baitInfo[currentBait].icon} S·ª≠ d·ª•ng: {baitInfo[currentBait].name}
                                    </p>
                                    <p className="text-3xl font-bold text-gray-800 mb-4">
                                        {currentFish.math.question} = ?
                                    </p>
                                    <p className="text-xl text-red-500 font-bold">
                                        Th·ªùi gian: {timeLeft}s
                                    </p>
                                </div>

                                <input
                                    type="number"
                                    value={answer}
                                    onChange={(e) => setAnswer(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && checkAnswer()}
                                    placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi"
                                    className="w-full px-4 py-3 text-xl border-2 border-gray-300 rounded-lg mb-4 text-center"
                                    autoFocus
                                />

                                <button
                                    onClick={checkAnswer}
                                    className="w-full px-6 py-3 bg-green-600 text-white text-xl rounded-lg hover:bg-green-700 transition"
                                >
                                    Tr·∫£ l·ªùi
                                </button>
                            </div>
                        )}

                        {gameState === 'result' && (
                            <div className="bg-white rounded-lg p-12 shadow-2xl max-w-md">
                                <p className="text-2xl font-bold text-gray-800">
                                    {message}
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FishingGame />);
    </script>
</body>
</html>
